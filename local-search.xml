<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>iOS-ç³»ç»ŸCå‡½æ•°çš„hook</title>
    <link href="/2022/02/01/iOS-C%E5%87%BD%E6%95%B0%E7%9A%84hook/"/>
    <url>/2022/02/01/iOS-C%E5%87%BD%E6%95%B0%E7%9A%84hook/</url>
    
    <content type="html"><![CDATA[<h3 id="fishhookæ–¹æ¡ˆ"><a href="#fishhookæ–¹æ¡ˆ" class="headerlink" title="fishhookæ–¹æ¡ˆ"></a>fishhookæ–¹æ¡ˆ</h3><p>é€šè¿‡è§£æ<code>bind</code>ã€<code>lazy_bind</code>ã€<code>weak_bind</code>å¯ä»¥è·å–åˆ°å…ƒç»„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç»„ä¼šå‘Šè¯‰æˆ‘ä»¬ç¬¦å·å’ŒæŒ‡é’ˆä¿¡æ¯ï¼ŒæŒ‡é’ˆä¿¡æ¯åŒ…æ‹¬æŒ‡é’ˆä½äºå“ªä¸ªæ®µä»¥åŠåœ¨æ®µçš„åç§»</p><p>åœ¨iOSä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”¨å˜é‡æˆ–ç±»ä¼¼<code>NSLog()</code>ç­‰å¤–éƒ¨å‡½æ•°å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨åœ°å€ï¼Œè€Œæ˜¯åœ¨ç»è¿‡bind æˆ– lazy_bindåæ‰èƒ½å¾—åˆ°çœŸæ­£çš„åœ°å€ã€‚bindæˆ–lazy_bindåçœŸæ­£çš„å‡½æ•°åœ°å€è®°å½•åœ¨ <code>nl_symbol_ptr</code> æˆ– <code>la_symbol_ptr</code>ä¸­ï¼Œé€šè¿‡ç¬¦å·è¡¨å¯ä»¥æ‰¾åˆ°æ¯ä¸ªå‡½æ•°å¯¹åº”åœ¨<code>nl_symbol_ptr</code>æˆ–<code>la_symbol_ptr</code>ä¸­çš„åœ°å€ã€‚fishhook å°±æ˜¯é€šè¿‡æŸ¥æ‰¾ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°è®°å½•å‡½æ•°æŒ‡é’ˆçš„åœ°å€ä¿®æ”¹å‡½æ•°æŒ‡é’ˆä»è€Œå®ç°Cå‡½æ•°çš„hookã€‚</p><p>bindæ˜¯åœ¨åŠ è½½é•œåƒçš„æ—¶å€™å°±å°±å·²ç»ç»‘å®šï¼Œè€Œlazy_bindæ˜¯åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰è§¦å‘ç»‘å®šã€‚</p><blockquote><p> lazy_bindæ˜¯å¦‚ä½•å®ç°åœ¨é¦–æ¬¡è°ƒç”¨å‡½æ•°æ—¶è¿›è¡Œbindçš„å‘¢ï¼Ÿ</p></blockquote><p>å‡è®¾å¼ ä¸‰å’Œæå››æ˜¯åŒå­¦ï¼Œè€å¸ˆæ‰‹é‡Œæœ‰ä¸ªåå•ï¼Œè¿™ä¸ªåå•ä¸Šè®°å½•ç€è¦å‚åŠ å€¼æ—¥çš„åŒå­¦ã€‚æœ¬æ¥ä»Šå¤©åº”è¯¥æ˜¯æå››å€¼æ—¥ï¼Œä½†æ˜¯ç”±äºæ‰“å°åå•æ—¶æ•™åŠ¡å¤„è€å¸ˆä¸çŸ¥é“æå››çš„åå­—ï¼Œå› æ­¤æ‰“å°äº†ç­é•¿å¼ ä¸‰çš„åå­—ã€‚è€å¸ˆåªè®¤åå•ï¼Œå› æ­¤è€å¸ˆæ‰¾æ¥å¼ ä¸‰æ‰“æ‰«å«ç”Ÿã€‚ä½†æ˜¯å¼ ä¸‰åªåšäº†ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯æŠŠåå•ä¸Šçš„åå­—æ”¹æˆäº†æå››ï¼Œå¹¶ä¸”å«æå››æ¥æ‰“æ‰«å«ç”Ÿã€‚è¿™æ ·è€å¸ˆä»¥åå¦‚æœå†å©å’æ‰“æ‰«å«ç”Ÿçš„äº‹æƒ…æ—¶å°±ç›´æ¥æ‰¾åˆ°äº†æå››ã€‚è¿™å°±æ˜¯lazy_bindã€‚æ•…äº‹ä¸­è€å¸ˆå°±æ˜¯æˆ‘ä»¬å†™çš„ä»£ç ï¼Œä»£ç åªè®¤åœ°å€ã€‚åå•å°±æ˜¯<code>la_symbol_ptr</code>ï¼Œä¸Šé¢è®°å½•äº†å€¼æ—¥åŒå­¦åã€‚å¼ ä¸‰å°±æ˜¯stubæœºåˆ¶ï¼Œå®ƒåªæ˜¯èµ·åˆ°äº†è¾…åŠ©ä½œç”¨ã€‚è€Œæå››åˆ™æ˜¯çœŸæ­£çš„å¤–éƒ¨å‡½æ•°ï¼Œéœ€è¦çœŸæ­£æ‰§è¡Œçš„å‡½æ•°ã€‚</p><h3 id="åŠ¨æ€åº“Cå‡½æ•°hook"><a href="#åŠ¨æ€åº“Cå‡½æ•°hook" class="headerlink" title="åŠ¨æ€åº“Cå‡½æ•°hook"></a>åŠ¨æ€åº“Cå‡½æ•°hook</h3><p>é™¤äº†<code>fishhook</code>å¤–ï¼Œç¬”è€…ä¹Ÿæœ‰ä¸€ç§Cå‡½æ•°çš„é™æ€hookæ–¹å¼ï¼Œç›¸æ¯”äº<code>fishhook</code>ï¼Œæ­¤æ–¹æ¡ˆä¸å­˜åœ¨è€—æ—¶çš„æŸ¥æ‰¾æ¯”å¯¹æ“ä½œã€‚ä¸‹é¢æˆ‘å°†ä»‹ç»è¿™ç§æ¯”è¾ƒç‰¹æ®Šçš„æ–¹æ¡ˆï¼šåŸºäºåŠ¨æ€åº“çš„Cå‡½æ•°hook </p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1dv8sqwtvj20xc0fjmyr.jpg"></p><p><strong>Step1</strong>: é¦–å…ˆåœ¨ä¸»å·¥ç¨‹ä¸­å®šä¹‰ä¸€ä¸ªåŒååŒå‚åŒè¿”å›çš„å‡½æ•°ï¼Œè¿™æ ·åœ¨<code>ld64</code>é“¾æ¥æ—¶ä¼šè®¤ä¸º<code>func1</code>å’Œ<code>func2</code> ä¸­ç”¨åˆ°çš„<code>NSLog</code>æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œè¿™æ ·å°±ä¸ä¼šè·Ÿç³»ç»Ÿåº“çš„å‡½æ•°è¿›è¡ŒåŒ¹é…ï¼Œ<code>NSLog</code>ä¹Ÿå°±ä¸ä¼šè¢«æ ‡è®°ä¸ºéœ€è¦<code>bind</code>çš„å‡½æ•°ã€‚</p><p><strong>Step2</strong>: åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>NSLog</code>å†…éƒ¨ï¼Œæˆ‘ä»¬è°ƒç”¨è‡ªå®šä¹‰åŠ¨æ€åº“çš„ä¸­é—´å‡½æ•°<code>MyNSLog</code>ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†èƒ½å¤Ÿè°ƒç”¨åˆ°çœŸæ­£çš„<code>NSLog</code></p><p><strong>Step3</strong>: ç”±äºåŠ¨æ€åº“ä¸­æˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰<code>NSLog</code>å»â€œæ¬ºéª—â€ld64ï¼Œå› æ­¤åŠ¨æ€ä¸­çš„<code>NSLog</code>ä¼šå»è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿå‡½æ•°ã€‚</p><p>åˆ°è¿™é‡Œå¯èƒ½æœ‰åŒå­¦ä¼šé—®ï¼Œâ€œéš¾é“åŠ¨æ€åº“çš„<code>NSLog</code>ä¸å­˜åœ¨é‡æ–°è°ƒç”¨åˆ°ä¸»ç¨‹åºçš„<code>NSLog</code>å‡½æ•°çš„é£é™©å—ï¼Ÿé‚£æ ·å²‚ä¸æ˜¯ä¼šæ­»å¾ªç¯ï¼Ÿâ€</p><p>ä¸ä¼šçš„ã€‚å› ä¸ºåŠ¨æ€åº“æ˜¯å…·å¤‡ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹çš„äº§ç‰©ã€‚ç»è¿‡é“¾æ¥æ—¶ï¼Œåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å°±å·²ç»å†™å®šäº†<code>NSLog</code>  <code>bind</code>åˆ°ç³»ç»Ÿåº“ä¸­çš„<code>NSLog</code>äº†ï¼Œå› æ­¤åœ¨å¯åŠ¨é˜¶æ®µ<code>dyld</code>ä¸ä¼šâ€œè¿æŠ—â€äºŒè¿›åˆ¶çš„å‘½ä»¤æ‰§è¡Œåˆ°ä¸»ç¨‹åºçš„<code>NSLog</code>ã€‚</p><p>ä½†æ˜¯ç”±äºä¾µå…¥æ€§è¾ƒå¼ºï¼Œä»…å¯¹éƒ¨åˆ†éœ€è¦<strong>åŒæ­¥å¯åŠ¨</strong>ç”¨åˆ°çš„å‡½æ•°ä½¿ç”¨ã€‚<code>fishhook</code> è¿˜æ˜¯é¡¹ç›®ä¸­æœ€ä¸»è¦çš„ä½¿ç”¨æ–¹å¼ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–</title>
    <link href="/2022/01/01/dyld%202%20%E5%92%8C%20dyld%203%20%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%20%E4%BB%A5%E5%8F%8AiOS15%E4%B8%8Adyld%E7%9A%84%E5%8F%98%E5%8C%96/"/>
    <url>/2022/01/01/dyld%202%20%E5%92%8C%20dyld%203%20%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%20%E4%BB%A5%E5%8F%8AiOS15%E4%B8%8Adyld%E7%9A%84%E5%8F%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="dyld-2-å’Œ-dyld-3-æœ‰å“ªäº›åŒºåˆ«-ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–"><a href="#dyld-2-å’Œ-dyld-3-æœ‰å“ªäº›åŒºåˆ«-ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–" class="headerlink" title="dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–"></a>dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–</h3><p>dyld æ˜¯åŠ¨æ€åŠ è½½å™¨ï¼Œå®ƒä¸»è¦ç”¨äºåŠ¨æ€åº“çš„é“¾æ¥å’Œç¨‹åºå¯åŠ¨åŠ è½½å·¥ä½œï¼Œå®ƒç›®å‰æœ‰ä¸¤ä¸ªä¸»è¦ç‰ˆæœ¬ï¼šdyld 2 å’Œ dyld 3ã€‚</p><p><strong>dyld 2</strong></p><p><a href="https://github.com/opensource-apple/dyld/tree/master/src" title="dyldå¼€æºåœ°å€">dyld2</a> ä» iOS 3.1 å¼€å§‹å¼•å…¥ï¼Œä¸€ç›´åˆ° iOS 12 è¢« dyld 3 å…¨é¢ä»£æ›¿ã€‚å®ƒç»è¿‡äº†å¾ˆå¤šæ¬¡ç‰ˆæœ¬è¿­ä»£ï¼Œæˆ‘ä»¬ç°åœ¨å¸¸è§çš„ç‰¹æ€§æ¯”å¦‚ ASLRï¼ŒCode Signï¼ŒShared Cache ç­‰æŠ€æœ¯ï¼Œéƒ½æ˜¯åœ¨ dyld 2 ä¸­å¼•å…¥çš„ã€‚dyld 2 çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="http://cdn.zhangferry.com/Images/20220104235847.png"></p><ul><li>è§£æ <code>mach-o</code> å¤´æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¾èµ–åº“ï¼Œä¾èµ–åº“åˆå¯èƒ½æœ‰åˆ«çš„ä¾èµ–ï¼Œè¿™é‡Œä¼šè¿›è¡Œé€’å½’åˆ†æï¼Œç›´åˆ°è·å¾—æ‰€æœ‰ dylib çš„å®Œæ•´å›¾ã€‚è¿™é‡Œæ•°æ®åºå¤§ï¼Œéœ€è¦è¿›è¡Œå¤§é‡çš„å¤„ç†ï¼›</li><li>æ˜ å°„æ‰€æœ‰ <code>mach-o</code> æ–‡ä»¶ï¼Œå°†å®ƒä»¬æ”¾å…¥åœ°å€ç©ºé—´ï¼›</li><li>æ‰§è¡Œç¬¦å·æŸ¥æ‰¾ï¼Œè‹¥ä½ çš„ç¨‹åºä½¿ç”¨ <code>printf</code> å‡½æ•°ï¼Œå°†ä¼šæŸ¥æ‰¾ <code>printf</code> æ˜¯å¦åœ¨åº“ç³»ç»Ÿä¸­ï¼Œç„¶åæˆ‘ä»¬æ‰¾åˆ°å®ƒçš„åœ°å€ï¼Œå°†å®ƒå¤åˆ¶åˆ°ä½ çš„ç¨‹åºä¸­çš„å‡½æ•°æŒ‡é’ˆä¸Šï¼›</li><li>è¿›è¡Œ bind å’Œ rebaseï¼Œä¿®å¤å†…éƒ¨å’Œå¤–éƒ¨æŒ‡é’ˆï¼›</li><li>è¿è¡Œä¸€äº›åˆå§‹åŒ–ä»»åŠ¡ï¼Œåƒæ˜¯åŠ è½½ categoryã€load æ–¹æ³•ç­‰ï¼›</li><li>æ‰§è¡Œ mainï¼›</li></ul><p><strong>dyld 3</strong></p><p>dyld 3 åœ¨ 2017 å¹´å°±è¢«å¼•å…¥è‡³ iOS 11ï¼Œå½“æ—¶ä¸»è¦ç”¨æ¥ä¼˜åŒ–ç³»ç»Ÿåº“ã€‚ç°åœ¨ï¼Œåœ¨ iOS 13 ä¸­å®ƒä¹Ÿå°†ç”¨äºå¯åŠ¨ç¬¬ä¸‰æ–¹ APPï¼Œå®Œå…¨æ›¿ä»£ dyld 2ã€‚</p><p>dyld 3 æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¼•å…¥äº†å¯åŠ¨é—­åŒ…ï¼Œé—­åŒ…é‡ŒåŒ…å«äº†å¯åŠ¨æ‰€éœ€è¦çš„ç¼“å­˜ä¿¡æ¯ï¼Œè€Œä¸”è¿™ä¸ªé—­åŒ…åœ¨è¿›ç¨‹å¤–å°±å®Œæˆäº†ã€‚åœ¨æ‰“å¼€ APP æ—¶ï¼Œå®é™…ä¸Šå·²ç»æœ‰ä¸å°‘å·¥ä½œéƒ½å®Œæˆäº†ï¼Œè¿™ä¼šä½¿ dyld çš„æ‰§è¡Œæ›´å¿«ã€‚</p><p>æœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯å¯åŠ¨é—­åŒ…ï¼Œé—­åŒ…é‡ŒåŒ…å«äº†å¯åŠ¨æ‰€éœ€è¦çš„ç¼“å­˜ä¿¡æ¯ï¼Œä»è€Œæé«˜å¯åŠ¨é€Ÿåº¦ã€‚ä¸‹å›¾æ˜¯ dyld 2 å’Œ dyld 3 çš„æ‰§è¡Œæ­¥éª¤å¯¹æ¯”ï¼š</p><p><img src="http://cdn.zhangferry.com/Images/20220105001119.png"></p><p>dyld 3 çš„æ‰§è¡Œæ­¥éª¤åˆ†ä¸¤å¤§æ­¥ï¼Œä»¥å›¾ä¸­è™šçº¿éš”å¼€ï¼Œè™šçº¿ä»¥ä¸Šè¿›ç¨‹å¤–æ‰§è¡Œï¼Œä»¥ä¸‹è¿›ç¨‹åˆ›å»ºæ—¶æ‰§è¡Œï¼š</p><ul><li>å‰ 3 æ­¥æŸ¥æ‰¾ä¾èµ–å’Œç¬¦å·ç›¸å¯¹è€—æ—¶ï¼Œä¸”æ¶‰åŠä¸€äº›å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥å°†è¿™äº›ä¿¡æ¯åšæˆç¼“å­˜é—­åŒ…å†™å…¥ç£ç›˜é‡Œï¼Œå¯¹åº”åœ°å€ï¼š<code>tmp/com.apple.dyld</code>ã€‚é—­åŒ…ä¼šåœ¨é‡å¯æ‰‹æœº&#x2F;æ›´æ–°&#x2F;ä¸‹è½½ App çš„é¦–å¯ç­‰æ—¶æœºåˆ›å»ºã€‚</li><li>è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œè¯»å–é—­åŒ…å¹¶éªŒè¯é—­åŒ…æœ‰æ•ˆæ€§ã€‚</li><li>åé¢æ­¥éª¤åŒ dyld 2</li></ul><h3 id="iOS-15-çš„LC-DYLD-CHAINED-FIXUPS"><a href="#iOS-15-çš„LC-DYLD-CHAINED-FIXUPS" class="headerlink" title="iOS 15 çš„LC_DYLD_CHAINED_FIXUPS"></a>iOS 15 çš„LC_DYLD_CHAINED_FIXUPS</h3><p>åœ¨iOS15 ä¸Šï¼ŒAPPçš„<code>rebase</code> &amp; <code>bind</code> çš„æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ã€‚</p><p>å¦‚æœæˆ‘ä»¬å°†<code>iOS Deployment Target</code>è®¾ç½®ä¸º15çš„è¯ï¼Œé€šè¿‡<code>MachOView</code>æŸ¥çœ‹æ‰“åŒ…åçš„Mach-Oæ–‡ä»¶ä¼šå‘ç°æ–°çš„äºŒè¿›åˆ¶ä¸Šå‡ºç°äº†ä¸æ”¯æŒçš„LCã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/4642217-76d3f18e9cc92b52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/830/format/webp" alt="img"></p><p>è¿™æ˜¯ç”±äº<code>LC_DYLD_INFO_ONLY</code>è¢«æ›¿æ¢æˆäº†æ–°å¢çš„<code>LC_DYLD_EXPORTS_TRIE</code>å’Œ<code>LC_DYLD_CHAINED_FIXUPS</code>ã€‚</p><p>æ–‡ä»¶çš„å˜åŒ–æ„å‘³ç€iOS 15çš„<code>rebase</code>å’Œ<code>bind</code>æœºåˆ¶å‘ç”Ÿäº†å˜åŒ–ã€‚å›é¡¾iOS 14åŠä»¥å‰ï¼Œ<code>dyld</code>æ˜¯é€šè¿‡è§£æå‹ç¼©å­—èŠ‚æµå®ç°äº†<code>rebase</code>å’Œ<code>bind</code>ã€‚è§£æå‹ç¼©å­—èŠ‚ä¼šå‘Šè¯‰<code>dyld</code> æ•´ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœ‰å“ªäº›åœ°å€éœ€è¦ä¿®æ­£ï¼Œä»¥åŠåœ¨<code>bind</code>æ—¶æ¯ä¸ªåœ°å€æ˜¯ä¸ºå“ªä¸ªå¤–éƒ¨ç¬¦å·é¢„ç•™ã€‚é‚£iOS 15 <code>dyld</code>æ˜¯å¦‚ä½•è¿›è¡Œè¿‡ä¿®æ­£çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬æ¢ç´¢ä¸‹<code>dyld</code>ã€‚</p><p> å‰æ®µæ—¶é—´å¬åˆ°æœ‰åŒå­¦è®¨è®ºiOS 15 <code>dyld3</code> æ›´æ–°ä¸º<code>dyld4</code>äº†ã€‚ç¬”è€…æ— æ³•ç¡®å®šè‹¹æœæ˜¯å¦å·å·åœ°å‡çº§äº†<code>dyld</code>ï¼Œä½†æ˜¯ä»è››ä¸é©¬è¿¹ä¸­å¯ä»¥çœ‹å‡ºæ¥<code>dyld</code> ç¡®å®æ˜¯æœ‰å˜åŒ–ï¼Œä¾‹å¦‚åœ¨<code>instrument</code> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°éƒ¨åˆ†å‡½æ•°çš„å‘½åç©ºé—´å˜æˆäº†<code>dyld4</code>ã€‚è¿˜æœ‰å°±æ˜¯ä¸€äº›APIçš„è°ƒç”¨ä¸Šå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">let header:UnsafePointer<span class="hljs-tag">&lt;<span class="hljs-name">mach_header</span>&gt;</span> = _dyld_get_image_header(0)<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨iOS 15ç³»ç»Ÿä¹‹å‰é€šè¿‡ç´¢å¼•è·å–<code>header</code>æ—¶ï¼Œå¦‚æœ<code>index == 0</code>ï¼Œè¿”å›çš„æ˜¯å¯æ‰§è¡Œç¨‹åºçš„<code>header</code>ã€‚ä½†æ˜¯åœ¨iOS 15ä¸­ï¼Œ<code>index == 0</code>è·å–åˆ°çš„å´æ˜¯ç³»ç»Ÿåº“ã€‚å½“ç„¶è¿™äº›å˜åŒ–å¯¹æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å¯èƒ½è¿˜ä¸è¶³ä»¥äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯å¯ä»¥è¯´æ˜<code>dyld</code> ç¡®å®šæ˜¯æœ‰æ”¹åŠ¨ã€‚é‚£<code>LC_DYLD_CHAINED_FIXUPS</code>æ˜¯<code>dyld</code>çš„æ–°ç‰¹æ€§å—ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å› ä¸ºä»<code>dyld3</code>çš„<code>dyld-852.2</code>ç‰ˆæœ¬ä¸­å¯ä»¥çœ‹åˆ°<code>LC_DYLD_CHAINED_FIXUPS</code>æ—©å°±é¢„åŸ‹åœ¨dyldä¸­äº†ï¼Œåªä¸è¿‡åœ¨<code>iOS Deployment Target == 15</code>æ—¶å¼•èµ·Mach-Oæ–‡ä»¶å˜åŒ–åï¼Œæ‰èƒ½è¿›å…¥ç›¸åº”çš„ä»£ç åˆ†æ”¯ã€‚</p><h3 id="iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ"><a href="#iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ" class="headerlink" title="iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ"></a>iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ</h3><p>åœ¨iOS 15ä¸­ï¼ŒåŸæœ¬ç”¨äºrebase &amp; bind çš„å‹ç¼©å­—èŠ‚æµè¢«æ›¿æ¢ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯fixup-chains(é“¾è¡¨ç»“æ„)ã€‚åœ¨iOS å¯åŠ¨æ—¶ï¼Œdyld å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨fixup-chainsï¼Œå¦‚æœå­˜åœ¨fixup-chains åˆ™æŒ‰ç…§fixup-chainsçš„æ–¹å¼è¿›è¡Œè§£æï¼Œå¦åˆ™è¿˜æ˜¯æŒ‰ç…§å‹ç¼©å­—èŠ‚æµçš„æ–¹å¼è§£æã€‚è§£æçš„ç›®çš„æ˜¯ä¸ºäº†å°†åº”ç”¨ç¨‹åºçš„åœ°å€è¿›è¡Œä¿®æ­£ã€‚fixup-chains æœºåˆ¶æ˜¯ç”±ä¸‰å±‚ç»“æ„è¿›è¡Œå­˜å‚¨ï¼Œåˆ†åˆ«æ˜¯segmentï¼ˆæ®µï¼‰-&gt; pages(é¡µ) -&gt; fixup-chains(æŒ‡é’ˆé“¾è¡¨) ç»„æˆã€‚LC_DYLD_CHAINED_FIXUPSæ‰€æŒ‡å‘çš„æ•°æ®ä¼šå‘Šè¯‰æˆ‘ä»¬æœ‰å¤šå°‘segmentsï¼Œæ¯ä¸ªsegmentçš„ä¿¡æ¯åˆä¼šå‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªsegmentæœ‰å¤šå°‘pagesï¼Œä»¥åŠæ¯ä¸ªpage çš„fixup-chainsåœ¨å“ªé‡Œã€‚ è€Œ fixup-chainsä¸­çš„æŒ‡é’ˆæŒ‡å‘äº†å½“å‰pageä¸­æ¯ä¸€ä¸ªéœ€è¦rebase æˆ–è€… bindçš„åœ°å€ï¼Œè¿™äº›åœ°å€ä¸­å­˜å‚¨çš„æ•°æ®å¹¶éåƒiOS 15ä¹‹å‰é‚£æ ·éƒ½æ˜¯0x00ï¼Œè€Œæ˜¯æœ‰ä¸€å®šæ ¼å¼çš„å…·æœ‰ä¸€å®šæ„ä¹‰çš„8å­—èŠ‚æ•°æ®ã€‚è€Œè¿™çŸ­çŸ­çš„8å­—èŠ‚æ•°æ®è¢«æŒ‰ç…§ä¸åŒçš„ç»“æ„ä½“æ‹†åˆ†æˆå¤šä¸ªbitï¼Œæ¯ä¸ªæˆ–è¿ç»­å‡ ä¸ªbitéƒ½å…·æœ‰å…¶ç‰¹æ®Šçš„å«ä¹‰ç”¨äºæ¨æ–­rebase æˆ– bind æ‰€éœ€è¦çš„ä¸€åˆ‡ä¿¡æ¯ã€‚iOS 15åºŸé™¤äº†lazy_bind(weak_bindä»ç„¶ä¿ç•™)ï¼Œç”±äºrebaseå’Œbind è¢«æ•´åˆä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œå› æ­¤éå†ä¸€æ¬¡é“¾è¡¨å³å¯å®Œæˆä¸€ä¸ªpageæ‰€éœ€çš„rebaseå’Œbindã€‚</p><p><strong>é‚£fixup-chainsä¸ºä»€ä¹ˆèƒ½åŠ å¿«å¯åŠ¨å‘¢ï¼Ÿ</strong></p><p>å› ä¸ºåœ¨iOS 15ä»¥å‰ï¼Œrebaseå’Œbindçš„ä¿¡æ¯åœ¨å‹ç¼©å­—èŠ‚æµä¸­æ˜¯åˆ†åˆ«å­˜å‚¨çš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨å¯åŠ¨æ—¶dyldåœ¨åšrebaseæ—¶ä¼šå…ˆéå†ä¸€érebaseå‹ç¼©å­—èŠ‚æµæ‰€è®°å½•çš„åœ°å€è¿›è¡Œåœ°å€ä¿®æ”¹ï¼Œå‡è®¾ä¸ºNæ¬¡page faultï¼Œç”±äºç»è¿‡rebase çš„page æ˜¯è¢«å†™å…¥æ•°æ®çš„dirty pageï¼Œå› æ­¤ä¸ä¼šè¢«é‡Šæ”¾ï¼ŒiOS ä¼šé€šè¿‡å‹ç¼©çš„æ–¹å¼ä¼˜åŒ–æœ€è¿‘æ²¡æœ‰ä½¿ç”¨åˆ°çš„dirty pageã€‚ç„¶ååœ¨è¿›è¡Œbindæ—¶ï¼Œåˆéå†bindå‹ç¼©å­—èŠ‚æµæ‰€è®°å½•çš„é‚£äº›åœ°å€è¿›è¡Œä¿®æ”¹ï¼Œå‡è®¾éœ€è¦bind Mä¸ªpageã€‚é‚£ä¹ˆåœ¨Nå’ŒMè¿™ä¸¤ä¸ªPagesé›†åˆä¸­å¯èƒ½å­˜åœ¨å¾ˆå¤šé‡å ï¼Œè¿™å°±é€ æˆäº†äºŒæ¬¡éå†ï¼Œå¹¶ä¸”iOSå¯èƒ½å¯¹å…¶ä¸­æŸäº›dirty pageåšäº†å‹ç¼©ä¼˜åŒ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œbindæ—¶å°±éœ€è¦å¯¹è¿™äº›é‡å çš„pagesåšè§£å‹æ“ä½œã€‚è€Œfixup-chainså¾ˆå·§å¦™åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåŒä¸€ä¸ªpageçš„rebaseå’Œbindæ•´åˆæˆä¸€ä¸ªé“¾è¡¨ï¼ŒåŒæ—¶è¿›è¡Œè¿™ä¸¤ç§æ“ä½œï¼Œè¿™æ ·å°±ä¸ä¼šå­˜åœ¨é‡å¤éå†ç›¸åŒçš„pageï¼Œä¹Ÿä¸ä¼šå­˜åœ¨è§£å‹çš„é—®é¢˜ã€‚</p><p><strong>ç–‘é—®</strong></p><p>fixup-chains ä¼šå‡å°‘page falutæ¬¡æ•°å—ï¼Ÿï¼šä¸ä¼šï¼Œä¾æ—§æ˜¯<code>M</code> âˆª<code>N</code></p><p>æœ‰äººé—®è¿™ä¸ªç®—ä¸ç®—iOS å¸®æˆ‘ä»¬åšäº†äºŒè¿›åˆ¶é‡æ’ï¼Ÿï¼šå®Œå…¨æ˜¯ä¸¤å›äº‹ã€‚è™½ç„¶éƒ½æåˆ°äº†page faultï¼Œä½†æ˜¯é˜¶æ®µæ˜¯ä¸åŒçš„ã€‚</p><p><a href="https://easeapi.com/blog/blog/83-ios13-dyld3.html" title="iOS 13ä¸­dyld 3çš„æ”¹è¿›å’Œä¼˜åŒ–">iOS 13ä¸­dyld 3çš„æ”¹è¿›å’Œä¼˜åŒ–</a></p><p><a href="https://www.yotrolz.com/posts/c2aae680/" title="iOS dyld å‰ä¸–ä»Šç”Ÿ">iOS dyld å‰ä¸–ä»Šç”Ÿ</a></p><p><a href="https://www.jianshu.com/p/6ff72443377b">ä»é‡æŒ‡é’ˆæ¢æµ‹åˆ°å¯¹iOS 15 bind çš„æ¢ç´¢</a></p>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Swift-weakçš„å®ç°</title>
    <link href="/2021/09/01/Swift-weak%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2021/09/01/Swift-weak%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>åœ¨Swiftä¸­, <code>SideTable</code> æ˜¯é’ˆå¯¹æœ‰éœ€è¦çš„å¯¹è±¡è€Œåˆ›å»ºï¼Œç³»ç»Ÿä¼šä¸ºç›®æ ‡å¯¹è±¡åˆ†é…ä¸€å—æ–°çš„å†…å­˜æ¥ä¿å­˜è¯¥å¯¹è±¡é¢å¤–çš„ä¿¡æ¯ã€‚ å› ä¸ºè¿™ä¸æ˜¯å¯¹è±¡å¿…é¡»çš„å†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ª <code>SideTable</code> å¯æœ‰å¯æ— ã€‚å¯¹è±¡ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘ <code>SideTable</code> çš„æŒ‡é’ˆï¼ŒåŒæ—¶ <code>SideTable</code> ä¹Ÿæœ‰ä¸€ä¸ªæŒ‡å›åŸå¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨å®ç°ä¸Šä¸ºäº†ä¸é¢å¤–å¤šå ç”¨å†…å­˜ï¼Œç›®å‰åªæœ‰åœ¨åˆ›å»ºå¼±å¼•ç”¨æ—¶ï¼Œä¼šå…ˆæŠŠå¯¹è±¡çš„å¼•ç”¨è®¡æ•°æ”¾åˆ°æ–°åˆ›å»ºçš„ <code>SideTable</code> å»ï¼Œå†æŠŠç©ºå‡ºæ¥çš„ç©ºé—´å­˜æ”¾ <code>SideTable</code> çš„åœ°å€ï¼Œä¼šé€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½æ¥åŒºåˆ†å¯¹è±¡æ˜¯å¦æœ‰ <code>SideTable</code>ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JYObject</span>&#123;<br>    <span class="hljs-keyword">var</span> age :<span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span><br>    <span class="hljs-keyword">var</span> name:<span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;JY&quot;</span><br>&#125;<br> <br>  <span class="hljs-keyword">var</span> t <span class="hljs-operator">=</span> <span class="hljs-type">JYObject</span>()<br>    <br>  <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> t2 <span class="hljs-operator">=</span> t<br>    <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;----&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨<code>print</code>å¤„æ‰“ä¸Šæ–­ç‚¹ï¼ŒæŸ¥çœ‹t2å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C">(lldb) po t2<br>â–¿ Optional&lt;JYObject&gt;<br>  â–¿ some : &lt;JYObject: <span class="hljs-number">0x6000001a9710</span>&gt;<br><br>(lldb) x/<span class="hljs-number">8</span>gx  <span class="hljs-number">0x6000001a9710</span><br><span class="hljs-number">0x6000001a9710</span>: <span class="hljs-number">0x0000000100491e18</span> <span class="hljs-number">0xc0000c00001f03dc</span><br><span class="hljs-number">0x6000001a9720</span>: <span class="hljs-number">0x0000000000000012</span> <span class="hljs-number">0x000000000000594a</span><br><span class="hljs-number">0x6000001a9730</span>: <span class="hljs-number">0xe200000000000000</span> <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6000001a9740</span>: <span class="hljs-number">0x00007efd22b59740</span> <span class="hljs-number">0x000000000000009c</span><br>(lldb) <br></code></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹æ±‡ç¼–ï¼Œå®šä¹‰äº†ä¸€ä¸ª<code>weak</code>å˜é‡ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨äº†<code>swift_weakInit</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”±<code>WeakReference</code>è°ƒç”¨çš„ã€‚è¯´æ˜<code>weak</code>å­—æ®µåœ¨ç¼–è¯‘å™¨å£°æ˜çš„è¿‡ç¨‹å½“ä¸­è‡ªåŠ¨ç”Ÿæˆäº†<code>WeakReference</code>å¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">WeakReference *<span class="hljs-title">swift::swift_weakInit</span><span class="hljs-params">(WeakReference *ref, HeapObject *value)</span> </span>&#123;<br>  ref-&gt;<span class="hljs-built_in">nativeInit</span>(value);<br>  <span class="hljs-keyword">return</span> ref;<br>&#125;<br><br> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">nativeInit</span><span class="hljs-params">(HeapObject *object)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> side = object ? object-&gt;refCounts.formWeakReference() : <span class="hljs-literal">nullptr</span>;<br>    nativeValue.<span class="hljs-built_in">store</span>(<span class="hljs-built_in">WeakReferenceBits</span>(side), std::memory_order_relaxed);<br>  &#125;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br>HeapObjectSideTableEntry* RefCounts&lt;InlineRefCountBits&gt;::formWeakReference()<br>&#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª Side Table</span><br>  <span class="hljs-keyword">auto</span> side = <span class="hljs-built_in">allocateSideTable</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">if</span> (side)<br>      <span class="hljs-comment">// å¢åŠ ä¸€ä¸ªå¼±å¼•ç”¨</span><br>    <span class="hljs-keyword">return</span> side-&gt;<span class="hljs-built_in">incrementWeak</span>();<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p> æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>allocateSideTable</code>æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ª<code>Side Table</code>çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">template</span> &lt;&gt;<br>HeapObjectSideTableEntry* RefCounts&lt;InlineRefCountBits&gt;::<span class="hljs-built_in">allocateSideTable</span>(<span class="hljs-type">bool</span> failIfDeiniting)<br>&#123;<br>  <span class="hljs-comment">//1.æ‹¿åˆ°åŸæœ‰çš„å¼•ç”¨è®¡æ•°</span><br>  <span class="hljs-keyword">auto</span> oldbits = refCounts.<span class="hljs-built_in">load</span>(SWIFT_MEMORY_ORDER_CONSUME);<br>  <br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰SideTableï¼Œ</span><br>  <span class="hljs-keyword">if</span> (oldbits.<span class="hljs-built_in">hasSideTable</span>()) &#123;<br>    <span class="hljs-comment">// Already have a side table. Return it.</span><br>    <span class="hljs-keyword">return</span> oldbits.<span class="hljs-built_in">getSideTable</span>();<br>  &#125; <br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (failIfDeiniting &amp;&amp; oldbits.<span class="hljs-built_in">getIsDeiniting</span>()) &#123;<br>    <span class="hljs-comment">// Already past the start of deinit. Do nothing.</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Preflight passed. Allocate a side table.</span><br>  <br>  <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> custom side table allocator</span><br> <br>  <span class="hljs-comment">//2.é€šè¿‡HeapObjectåˆ›å»ºäº†ä¸€ä¸ªHeapObjectSideTableEntryå®ä¾‹å¯¹è±¡</span><br>  HeapObjectSideTableEntry *side = <span class="hljs-keyword">new</span> <span class="hljs-built_in">HeapObjectSideTableEntry</span>(<span class="hljs-built_in">getHeapObject</span>());<br> <br>  <span class="hljs-comment">//3.å°†åˆ›å»ºçš„å®ä¾‹å¯¹è±¡åœ°å€ç»™äº†InlineRefCountBitsï¼Œä¹Ÿå°±æ˜¯ RefCountBitsT</span><br>  <span class="hljs-keyword">auto</span> newbits = <span class="hljs-built_in">InlineRefCountBits</span>(side);<br>  <br>  <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">if</span> (oldbits.<span class="hljs-built_in">hasSideTable</span>()) &#123;<br>      <span class="hljs-comment">// Already have a side table. Return it and delete ours.</span><br>      <span class="hljs-comment">// Read before delete to streamline barriers.</span><br>      <span class="hljs-keyword">auto</span> result = oldbits.<span class="hljs-built_in">getSideTable</span>();<br>      <span class="hljs-keyword">delete</span> side;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (failIfDeiniting &amp;&amp; oldbits.<span class="hljs-built_in">getIsDeiniting</span>()) &#123;<br>      <span class="hljs-comment">// Already past the start of deinit. Do nothing.</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>     <br>    <span class="hljs-comment">// å°†åŸæœ‰çš„å¼•ç”¨è®¡æ•°å­˜å‚¨</span><br>    side-&gt;<span class="hljs-built_in">initRefCounts</span>(oldbits);<br>     <br>  &#125; <span class="hljs-keyword">while</span> (! refCounts.<span class="hljs-built_in">compare_exchange_weak</span>(oldbits, newbits,<br>                                             std::memory_order_release,<br>                                             std::memory_order_relaxed));<br>  <span class="hljs-keyword">return</span> side;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢æ‰€åšçš„äº‹æƒ…</p><p>1.æ‹¿åˆ°åŸæœ‰çš„å¼•ç”¨è®¡æ•°<br>2.é€šè¿‡HeapObjectåˆ›å»ºäº†ä¸€ä¸ªHeapObjectSideTableEntryå®ä¾‹å¯¹è±¡<br>3.å°†åˆ›å»ºçš„å®ä¾‹å¯¹è±¡åœ°å€ç»™äº†<code>InlineRefCountBits</code>ï¼Œä¹Ÿå°±æ˜¯ RefCountBitsTã€‚</p></blockquote><p>æ„é€ å®Œ <code>Side Table</code> ä»¥åï¼Œå¯¹è±¡ä¸­çš„ <code>RefCountBitsT</code> å°±ä¸æ˜¯åŸæ¥çš„å¼•ç”¨è®¡æ•°äº†ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘ <code>Side Table</code> çš„æŒ‡é’ˆï¼Œç„¶è€Œç”±äºå®ƒä»¬å®é™…éƒ½æ˜¯ <code>uint64_t</code>ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥åŒºåˆ†ã€‚åŒºåˆ†çš„æ–¹æ³•æˆ‘ä»¬å¯ä»¥æ¥çœ‹ <code>InlineRefCountBits</code> çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//å¼±å¼•ç”¨</span><br><span class="hljs-function">LLVM_ATTRIBUTE_ALWAYS_INLINE</span><br><span class="hljs-function">  <span class="hljs-title">RefCountBitsT</span><span class="hljs-params">(HeapObjectSideTableEntry* side)</span></span><br><span class="hljs-function">    : bits((reinterpret_cast&lt;BitsType&gt;(side) &gt;&gt; Offsets::SideTableUnusedLowBits)</span><br><span class="hljs-function">           | (BitsType(<span class="hljs-number">1</span>) &lt;&lt; Offsets::UseSlowRCShift)</span><br><span class="hljs-function">           | (BitsType(<span class="hljs-number">1</span>) &lt;&lt; Offsets::SideTableMarkShift))</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-built_in">assert</span>(refcountIsInline);<br>  &#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨å¼±å¼•ç”¨æ–¹æ³•ä¸­æŠŠåˆ›å»ºå‡ºæ¥çš„åœ°å€åšäº†åç§»æ“ä½œç„¶åå­˜æ”¾åˆ°äº†å†…å­˜å½“ä¸­ã€‚</p><p><code>SideTableUnusedLowBits</code> &#x3D; 3ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼ è¿›æ¥çš„<code>side</code>å¾€å³ç§»äº† 3 ä½ï¼Œä¸‹é¢çš„ä¸¤ä¸ªæ˜¯ 62 ä½å’Œ 63 ä½æ ‡è®°æˆ 1</p></blockquote><p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸€ä¸‹ <code>HeapObjectSideTableEntry</code> çš„ç»“æ„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HeapObjectSideTableEntry</span> &#123;<br>  <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> does object need to be atomic?</span><br>  std::atomic&lt;HeapObject*&gt; object;<br>  SideTableRefCounts refCounts;<br><br>  <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">HeapObjectSideTableEntry</span>(HeapObject *newObject)<br>    : <span class="hljs-built_in">object</span>(newObject), <span class="hljs-built_in">refCounts</span>()<br>  &#123; &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥å°è¯•è¿˜åŸä¸€ä¸‹ æ‹¿åˆ°å¼±å¼•ç”¨è®¡æ•° </p><p><code>0xc0000c00001f03dc</code>62ä½å’Œ63ä½æ¸…0å¾—åˆ° <code>HeapObjectSideTableEntry</code> å®ä¾‹å¯¹è±¡çš„åœ°å€<code>0xC00001F03DC</code></p><p>å®ƒæ—¢ç„¶æ˜¯å³ç§» 3 ä½ï¼Œé‚£ä¹ˆæˆ‘å·¦ç§» 3 ä½æŠŠå®ƒè¿˜åŸï¼Œ<code>HeapObjectSideTableEntry</code>å·¦ç§»ä¸‰ä½ å¾—åˆ°<code>0x10062AFE0</code></p><p><img src="https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/20220302155825.png"></p><ul><li><code>0x6000001a9710</code> å°±æ˜¯å®ä¾‹å¯¹è±¡çš„åœ°å€ã€‚</li><li><code>0x0000000000000002</code>å°±æ˜¯å¼±å¼•ç”¨è®¡æ•°ã€‚<br>è¿™é‡Œå¼±å¼•ç”¨ä¸º<code>2</code>çš„åŸå› æ˜¯å› ä¸º<code>SideTableRefCountBits</code>åˆå§‹åŒ–çš„æ—¶å€™ä»<code>1</code>å¼€å§‹.</li></ul><p> <code>Side Table</code>çš„ç”Ÿå‘½å‘¨æœŸä¸å¯¹è±¡æ˜¯åˆ†ç¦»çš„ï¼Œå½“å¼ºå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œåªæœ‰ <code>HeapObject</code> è¢«é‡Šæ”¾äº†ï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾<code>Side Table</code>ï¼Œåªæœ‰æ‰€æœ‰çš„ <code>weak</code> å¼•ç”¨è€…éƒ½è¢«é‡Šæ”¾äº†æˆ–ç›¸å…³å˜é‡è¢«ç½® <code>nil</code> åï¼Œ<code>Side Table</code> æ‰èƒ½å¾—ä»¥é‡Šæ”¾</p>]]></content>
    
    
    <categories>
      
      <category>Swift</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†</title>
    <link href="/2021/08/02/iOS-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86/"/>
    <url>/2021/08/02/iOS-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†"><a href="#iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†" class="headerlink" title="iOS ç¼–è¯‘è¿‡ç¨‹æ¢³ç†"></a>iOS ç¼–è¯‘è¿‡ç¨‹æ¢³ç†</h1><p>ç¼–è¯‘è¯­è¨€åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¿…é¡»å…ˆé€šè¿‡ç¼–è¯‘å™¨ç”Ÿæˆæœºå™¨ç ï¼Œæœºå™¨ç å¯ä»¥ç›´æ¥åœ¨ CPU ä¸Šæ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡å¾ˆé«˜ã€‚</p><h2 id="ç¼–è¯‘å™¨çš„æ¦‚è¿°"><a href="#ç¼–è¯‘å™¨çš„æ¦‚è¿°" class="headerlink" title="ç¼–è¯‘å™¨çš„æ¦‚è¿°"></a>ç¼–è¯‘å™¨çš„æ¦‚è¿°</h2><p>ç¼–è¯‘å™¨çš„ä½œç”¨æ˜¯æŠŠæˆ‘ä»¬çš„é«˜çº§è¯­è¨€è½¬æ¢æˆæœºå™¨å¯ä»¥è¯†åˆ«çš„æœºå™¨ç ï¼Œç»å…¸çš„è®¾è®¡ç»“æ„å¦‚ä¸‹ï¼š</p><p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1dwrp77ruj20ki03z0sn.jpg"></p><ul><li>å‰ç«¯ï¼ˆFrontendï¼‰ï¼šè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æå’Œç”Ÿæˆä¸­é—´ä»£ç ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šå¯¹ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå‘ç°å‡ºé”™çš„æˆ–éœ€è¦è­¦å‘Šçš„ä¼šæ ‡æ³¨å‡ºæ¥ã€‚</li><li>ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ï¼šä¼šè¿›è¡Œ BitCode çš„ç”Ÿæˆï¼Œé“¾æ¥æœŸä¼˜åŒ–ç­‰å·¥ä½œã€‚</li><li>åç«¯ï¼ˆBackendï¼‰ï¼šé’ˆå¯¹ä¸åŒçš„æ¶æ„ï¼Œç”Ÿæˆå¯¹åº”çš„æœºå™¨ç ã€‚</li></ul><h2 id="Clang-LLVM-çš„ç¼–è¯‘è¿‡ç¨‹"><a href="#Clang-LLVM-çš„ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="Clang + LLVM çš„ç¼–è¯‘è¿‡ç¨‹"></a>Clang + LLVM çš„ç¼–è¯‘è¿‡ç¨‹</h2><ol><li><strong>é¢„å¤„ç†é˜¶æ®µ</strong>ï¼šimport å¤´æ–‡ä»¶æ›¿æ¢ï¼›macro å®å±•å¼€ï¼›å¤„ç†é¢„ç¼–è¯‘æŒ‡ä»¤</li><li><strong>è¯æ³•åˆ†æ</strong>ï¼šé¢„å¤„ç†å®Œæˆåè¿›å…¥è¯æ³•åˆ†æï¼Œå°†è¾“å…¥çš„ä»£ç è½¬åŒ–ä¸ºä¸€ç³»åˆ—ç¬¦åˆç‰¹å®šè¯­è¨€çš„è¯æ³•å•å…ƒï¼ˆtoken æµï¼‰ã€‚</li><li><strong>è¯­æ³•åˆ†æ</strong>ï¼šå°†è¯æ³•åˆ†æå¾—åˆ°çš„ token æµè¿›è¡Œè¯­æ³•é™æ€åˆ†æï¼ˆStatic Analysisï¼‰ï¼Œè¾“å‡º<strong>æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰</strong>ï¼Œè¿‡ç¨‹ä¸­ä¼šæ ¡éªŒè¯­æ³•æ˜¯å¦é”™è¯¯ã€‚</li><li><strong>CodeGen ç”Ÿæˆ IR ä¸­é—´ä»£ç </strong>ï¼šCodeGen è´Ÿè´£å°†è¯­æ³•æ ‘è‡ªé¡¶å‘ä¸‹éå†ç¿»è¯‘æˆ <code>LLVM IR</code>ï¼Œ<code>IR</code> æ˜¯ç¼–è¯‘è¿‡ç¨‹ä¸­å‰ç«¯çš„è¾“å‡ºåç«¯çš„è¾“å…¥ã€‚</li><li><strong>Optimize ä¼˜åŒ– IR</strong>ï¼šåˆ°è¿™é‡Œ LLVM ä¼šåšä¸€äº›ä¼˜åŒ–å·¥ä½œï¼Œåœ¨ Xcode çš„ç¼–è¯‘è®¾ç½®é‡Œå¯ä»¥è®¾ç½®ä¼˜åŒ–çº§åˆ« -01, -03, -0sï¼Œä¹Ÿå¯ä»¥å†™è‡ªå·±çš„ Passï¼ŒPass æ˜¯ LLVM ä¼˜åŒ–å·¥ä½œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹åšäº›äº‹ï¼Œä¸€èµ·åŠ èµ·æ¥å°±æ„æˆäº† LLVM å®Œæ•´çš„ä¼˜åŒ–å’Œè½¬åŒ–ã€‚é™„ä»¶ï¼š<a href="http://llvm.org/docs/WritingAnLLVMPass.html">å®˜æ–¹ Pass æ•™ç¨‹</a>ã€‚</li><li><strong>LLVM Bitcode ç”Ÿæˆå­—èŠ‚ç </strong>ï¼šå¦‚æœå¼€å¯äº† bitcodeï¼Œè‹¹æœä¼šåšè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚è‹¥æœ‰æ–°çš„åç«¯æ¶æ„ï¼Œä¾æ—§å¯ä»¥ç”¨è¿™ä»½ä¼˜åŒ–è¿‡çš„ bitcode å»ç”Ÿæˆã€‚</li><li><strong>ç”Ÿæˆæ±‡ç¼–</strong></li><li><strong>ç”Ÿæˆç›®æ ‡æ–‡ä»¶</strong></li><li><strong>ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</strong></li></ol><h2 id="Xcode-Build-çš„æµç¨‹"><a href="#Xcode-Build-çš„æµç¨‹" class="headerlink" title="Xcode Build çš„æµç¨‹"></a>Xcode Build çš„æµç¨‹</h2><p>æˆ‘ä»¬åœ¨ Xcode ä¸­ä½¿ç”¨ <strong>Command + B</strong> æˆ– <strong>Command + R</strong> æ—¶ï¼Œå³å®Œæˆäº†ä¸€æ¬¡ç¼–è¯‘ï¼Œæ¥çœ‹ä¸‹è¿™ä¸ªè¿‡ç¨‹åšäº†å“ªäº›äº‹æƒ…ã€‚</p><p>ç¼–è¯‘è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p><ul><li>é¢„ç¼–è¯‘ï¼ˆPre-processï¼‰ï¼šå®æ›¿æ¢ã€åˆ é™¤æ³¨é‡Šã€å±•å¼€å¤´æ–‡ä»¶ï¼Œäº§ç”Ÿ .i æ–‡ä»¶ã€‚</li><li>ç¼–è¯‘ï¼ˆComplilingï¼‰ï¼šæŠŠå‰é¢ç”Ÿæˆçš„ .i æ–‡ä»¶è½¬åŒ–ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œäº§ç”Ÿ .s æ–‡ä»¶ã€‚</li><li>æ±‡ç¼–ï¼ˆAsemblyï¼‰ï¼šæŠŠæ±‡ç¼–è¯­è¨€ .s æ–‡ä»¶è½¬åŒ–ä¸ºæœºå™¨ç æ–‡ä»¶ï¼Œäº§ç”Ÿ .0 æ–‡ä»¶ã€‚</li><li>é“¾æ¥ï¼ˆLinkï¼‰ï¼šå¯¹ .o æ–‡ä»¶ä¸­çš„å¯¹äºå…¶ä»–åº“çš„å¼•ç”¨çš„åœ°æ–¹è¿›è¡Œå¼•ç”¨ï¼Œç”Ÿæˆæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¹ŸåŒ…æ‹¬å¤šä¸ª .o æ–‡ä»¶è¿›è¡Œ linkã€‚</li></ul><p>é€šè¿‡è§£æ Xcode ç¼–è¯‘ logï¼Œå¯ä»¥å‘ç° Xcode æ˜¯æ ¹æ® Target è¿›è¡Œç¼–è¯‘çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Xcode ä¸­çš„ Build Phasesã€Build Settings åŠ Build Rules æ¥æ§åˆ¶ç¼–è¯‘è¿‡ç¨‹ã€‚</p><ul><li>Build Settingsï¼šè¿™ä¸€æ ä¸‹æ˜¯å¯¹ç¼–è¯‘çš„ç»†èŠ‚è¿›è¡Œè®¾å®šï¼ŒåŒ…å« build è¿‡ç¨‹çš„æ¯ä¸ªé˜¶æ®µçš„è®¾ç½®é€‰é¡¹ï¼ˆåŒ…å«ç¼–è¯‘ã€é“¾æ¥ã€ä»£ç ç­¾åã€æ‰“åŒ…ï¼‰ã€‚</li><li>Build Phasesï¼šç”¨äºæ§åˆ¶ä»æºæ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¦‚ç¼–è¯‘å“ªäº›æ–‡ä»¶ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­æ‰§è¡Œå“ªäº›è‡ªå®šä¹‰è„šæœ¬ã€‚ä¾‹å¦‚ CocoaPods åœ¨è¿™é‡Œä¼šè¿›è¡Œç›¸å…³é…ç½®ã€‚</li><li>Build Rulesï¼šæŒ‡å®šäº†ä¸åŒçš„æ–‡ä»¶ç±»å‹è¯¥å¦‚ä½•ç¼–è¯‘ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹è¿™é‡Œçš„å†…å®¹ã€‚å¦‚æœéœ€è¦å¯¹ç‰¹å®šç±»å‹çš„æ–‡ä»¶æ·»åŠ å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§„åˆ™ã€‚</li></ul><p>æ¯ä¸ª Target çš„å…·ä½“ç¼–è¯‘è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡ log æ—¥å¿—è·å¾—ã€‚å¤§è‡´è¿‡ç¨‹ä¸ºï¼š</p><ul><li>ç¼–è¯‘ä¿¡æ¯å†™å…¥è¾…åŠ©æ–‡ä»¶ï¼ˆå¦‚Entitlements.plistï¼‰ï¼Œåˆ›å»ºç¼–è¯‘åçš„æ–‡ä»¶æ¶æ„</li><li>å†™å…¥è¾…åŠ©ä¿¡æ¯ï¼ˆ.hmap æ–‡ä»¶ï¼‰ã€‚å°†é¡¹ç›®çš„æ–‡ä»¶ç»“æ„å¯¹åº”è¡¨ã€å°†è¦æ‰§è¡Œçš„è„šæœ¬ã€é¡¹ç›®ä¾èµ–åº“çš„æ–‡ä»¶ç»“æ„å¯¹åº”è¡¨å†™æˆæ–‡ä»¶ã€‚</li><li>è¿è¡Œé¢„è®¾çš„è„šæœ¬ã€‚å¦‚ Cocoapods ä¼šåœ¨ Build Phases ä¸­é¢„è®¾ä¸€äº›è„šæœ¬ï¼ˆCheckPods Manifest.lockï¼‰ã€‚</li><li>ç¼–è¯‘ .m æ–‡ä»¶ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ Mach-Oã€‚æ¯æ¬¡è¿›è¡Œäº† LLVM çš„å®Œæ•´æµç¨‹ï¼šå‰ç«¯ï¼ˆè¯æ³•åˆ†æ - è¯­æ³•åˆ†æ - ç”Ÿæˆ IRï¼‰ã€ä¼˜åŒ–å™¨ï¼ˆä¼˜åŒ– IRï¼‰ã€åç«¯ï¼ˆç”Ÿæˆæ±‡ç¼– - ç”Ÿæˆç›®æ ‡æ–‡ä»¶ - ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚ä½¿ç”¨ <code>CompileC</code> å’Œ <code>clang</code> å‘½ä»¤ã€‚ CompileC æ˜¯ xcodebuild å†…éƒ¨å‡½æ•°çš„æ—¥å¿—è®°å½•è¡¨ç¤ºå½¢å¼ï¼Œå®ƒæ˜¯ build.log æ–‡ä»¶ä¸­æœ‰å…³ç¼–è¯‘çš„åŸºæœ¬ä¿¡æ¯æ¥æºã€‚</li><li>é“¾æ¥éœ€è¦çš„åº“ã€‚å¦‚ Foundation.frameworkï¼ŒAFNetworking.frameworkâ€¦</li><li>æ‹·è´èµ„æºæ–‡ä»¶åˆ°ç›®æ ‡åŒ…</li><li>ç¼–è¯‘ storyboard æ–‡ä»¶</li><li>é“¾æ¥ storyboard æ–‡ä»¶</li><li>ç¼–è¯‘ Asset æ–‡ä»¶ã€‚å¦‚æœä½¿ç”¨ Asset.xcassets æ¥ç®¡ç†å›¾ç‰‡ï¼Œè¿™äº›å›¾ç‰‡ä¼šè¢«ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œé™¤äº† icon å’Œ launchIamgeã€‚</li><li>å¤„ç† infoplist</li><li>æ‰§è¡Œ CocoaPods è„šæœ¬ï¼Œå°†åœ¨ç¼–è¯‘é¡¹ç›®å‰å·²ç¼–è¯‘å¥½çš„ä¾èµ–åº“å’Œç›¸å…³èµ„æºæ‹·è´åˆ°åŒ…ä¸­ã€‚</li><li>æ‹·è´ Swift æ ‡å‡†åº“</li><li>åˆ›å»º .app æ–‡ä»¶å¹¶å¯¹å…¶ç­¾å</li></ul>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-çº¿ç¨‹æ•°é‡ç›‘æ§</title>
    <link href="/2021/07/01/iOS-%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F%E7%9B%91%E6%8E%A7/"/>
    <url>/2021/07/01/iOS-%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F%E7%9B%91%E6%8E%A7/</url>
    
    <content type="html"><![CDATA[<p>åœ¨iOSå¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸å¼€è¾Ÿæ–°çš„çº¿ç¨‹å»åšä¸€äº›äº‹ï¼Œå¦‚ä½•åˆç†çš„å¼€è¾Ÿçº¿ç¨‹ï¼Œåœ¨Appå¼€å‘é˜¶æ®µï¼Œç›‘æ§çº¿ç¨‹çš„å¼€è¾Ÿæ•°é‡ï¼Œé¿å…çº¿ä¸Šå‘ç”Ÿæ„å¤–æƒ…å†µã€‚ </p><p>å½“çº¿ç¨‹è¿‡å¤šæˆ–ç¬é—´åˆ›å»ºå¤§é‡å­çº¿ç¨‹(çº¿ç¨‹çˆ†ç‚¸)ï¼Œå°±åœ¨æ§åˆ¶å°æ‰“å°ä¿¡æ¯ï¼Œå¹¶è®°å½•ä¿¡æ¯ã€‚</p><ol><li><p>åˆ›å»ºå­çº¿ç¨‹è¿‡å¤šï¼Œæ˜¯ä¼šé€ æˆæ€§èƒ½é—®é¢˜çš„ï¼Œå› ä¸ºåˆ›å»ºçº¿ç¨‹éœ€è¦å ç”¨å†…å­˜ç©ºé—´ï¼ˆé»˜è®¤çš„æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹å 1M,å­çº¿ç¨‹å ç”¨512KBï¼‰ã€‚</p></li><li><p>ä¸åˆç†åˆ›å»ºå’Œä½¿ç”¨çº¿ç¨‹ï¼Œå®¹æ˜“å¼•å‘æ•°æ®ä¸€è‡´æ€§ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰å’Œæ­»é”é—®é¢˜ã€‚</p></li></ol><p>å› ä¸ºåœ¨iOSä¸­åŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨çš„<code>p_thread</code>ï¼Œåœ¨<code>Mach</code>å±‚ä¸­<code>thread_basic_info</code> ç»“æ„ä½“å°è£…äº†å•ä¸ªçº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">struct thread_basic_info &#123;<br>    time_value_t  user_time;      /* user run time */<br>    time_value_t  system_time;    /* system run time */<br>    integer_t    cpu_usage;       /* scaled cpu usage percentage */<br>    policy_t     policy;          /* scheduling policy in effect */<br>    integer_t    run_state;       /* run state (see below) */<br>    integer_t    flags;           /* various flags (see below) */<br>    integer_t    suspend_count;   /* suspend count for thread */<br>    integer_t    sleep_time;      /* number of seconds that thread  has been sleeping */<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>Mach Task</code>åŒ…å«å®ƒçš„çº¿ç¨‹åˆ—è¡¨ã€‚å†…æ ¸æä¾›äº†<code>task_threads</code> API è°ƒç”¨è·å–æŒ‡å®š task çš„çº¿ç¨‹åˆ—è¡¨ï¼Œç„¶åå¯ä»¥é€šè¿‡<code>thread_info</code> APIè°ƒç”¨æ¥æŸ¥è¯¢æŒ‡å®šçº¿ç¨‹çš„ä¿¡æ¯ï¼Œåœ¨ thread_act.h ä¸­æœ‰ç›¸å…³å®šä¹‰ã€‚</p><p><code>task_threads</code> å°†<code>target_task</code> ä»»åŠ¡ä¸­çš„æ‰€æœ‰çº¿ç¨‹ä¿å­˜åœ¨<code>act_list</code>æ•°ç»„ä¸­ï¼Œact_listCntè¡¨ç¤ºçº¿ç¨‹ä¸ªæ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">kern_return_t task_threads<br>(<br>    task_t target_task,<br>    thread_act_array_t *act_list,<br>    mach_msg_type_number_t *act_listCnt<br>);<br></code></pre></td></tr></table></figure><p> <code>thread_info</code>ç»“æ„å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">kern_return_t</span> <span class="hljs-title">thread_info</span></span><br><span class="hljs-function"><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_act_t</span> target_act,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_flavor_t</span> flavor,  <span class="hljs-comment">// ä¼ å…¥ä¸åŒçš„å®å®šä¹‰è·å–ä¸åŒçš„çº¿ç¨‹ä¿¡æ¯</span></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_info_t</span> thread_info_out,  <span class="hljs-comment">// æŸ¥è¯¢åˆ°çš„çº¿ç¨‹ä¿¡æ¯</span></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">mach_msg_type_number_t</span> *thread_info_outCnt  <span class="hljs-comment">// ä¿¡æ¯çš„å¤§å°</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br></code></pre></td></tr></table></figure><p> å¦‚æœé¢‘ç¹è°ƒç”¨<code>task_threads</code>å‡½æ•°ï¼Œæ¥è·å–çº¿ç¨‹æ•°é‡å’Œå¢é•¿é€Ÿåº¦ï¼Œå¤§é‡è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šé€ æˆä¸€å®šçš„æ€§èƒ½é—®é¢˜</p><p>é€šè¿‡<code>hook</code>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæ¥ç›‘å¬çº¿ç¨‹çš„æ•°é‡</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//åœ¨#include &lt;pthread/introspection.h&gt;æ–‡ä»¶é‡Œ</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">å®šä¹‰å‡½æ•°æŒ‡é’ˆï¼špthread_introspection_hook_t</span><br><span class="hljs-comment">event  : çº¿ç¨‹å¤„äºçš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¸‹é¢æšä¸¾äº†çº¿ç¨‹çš„4ä¸ªç”Ÿå‘½å‘¨æœŸï¼‰</span><br><span class="hljs-comment">thread ï¼šçº¿ç¨‹</span><br><span class="hljs-comment">addr   ï¼šçº¿ç¨‹æ ˆå†…å­˜åŸºå€</span><br><span class="hljs-comment">size   ï¼šçº¿ç¨‹æ ˆå†…å­˜å¯ç”¨å¤§å°</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*<span class="hljs-type">pthread_introspection_hook_t</span>)</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> event,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> size)</span></span>;<br><br><span class="hljs-keyword">enum</span> &#123;<br>PTHREAD_INTROSPECTION_THREAD_CREATE = <span class="hljs-number">1</span>, <span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹</span><br>PTHREAD_INTROSPECTION_THREAD_START, <span class="hljs-comment">// çº¿ç¨‹å¼€å§‹è¿è¡Œ</span><br>PTHREAD_INTROSPECTION_THREAD_TERMINATE,  <span class="hljs-comment">//çº¿ç¨‹è¿è¡Œç»ˆæ­¢</span><br>PTHREAD_INTROSPECTION_THREAD_DESTROY, <span class="hljs-comment">//é”€æ¯çº¿ç¨‹</span><br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">çœ‹è¿™ä¸ªå‡½æ•°åï¼Œå¾ˆåƒæˆ‘ä»¬å¹³æ—¶hookå‡½æ•°ä¸€æ ·çš„ã€‚</span><br><span class="hljs-comment">è¿”å›å€¼æ˜¯ä¸Šé¢å£°æ˜çš„pthread_introspection_hook_tå‡½æ•°æŒ‡é’ˆï¼šè¿”å›åŸçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚</span><br><span class="hljs-comment">å‚æ•°ä¹Ÿæ˜¯å‡½æ•°æŒ‡é’ˆï¼šä¼ å…¥çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="hljs-comment">*/</span><br>__attribute__((__nonnull__, __warn_unused_result__))<br><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-type">pthread_introspection_hook_t</span></span><br><span class="hljs-function"><span class="hljs-title">pthread_introspection_hook_install</span><span class="hljs-params">(<span class="hljs-type">pthread_introspection_hook_t</span> hook)</span></span>;<br><br></code></pre></td></tr></table></figure><h4 id="ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor"><a href="#ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor" class="headerlink" title="ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor"></a>ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ª<code>Monitor</code></h4><p>å…ˆæ¥å®šä¹‰ä¸€äº›å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">static pthread_introspection_hook_t original_pthread_introspection_hook_t = NULL;<br><br>/// åˆ›å»ºä¿¡å·é‡<br>static dispatch_semaphore_t semaphore;<br><br>/// çº¿ç¨‹æ€»æ•°<br>static int threadCount = 0;<br><br>/// æ˜¯å¦å¼€å¯ç›‘æ§<br>static bool isMonitor = false;<br><br>/// çº¿ç¨‹æ€»æ•°é˜ˆå€¼<br>static int averageThreadCount = 40;<br><br>/// çº¿ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…æ–°å¢æ•°<br>static int newThreadCount = 0;<br><br>/// çº¿ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…æ–°å¢é˜ˆå€¼<br>static int newAverageThreadCount = 10;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// å¼€å¯ç›‘æ§<br>+ (void)startMonitor&#123;<br>    // åˆ›å»ºä¿¡å·é‡ æœ€å¤§å¹¶å‘æ•°ä¸º1<br>    semaphore = dispatch_semaphore_create(1);<br>    // ç­‰å¾…<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    <br>    mach_msg_type_number_t count;<br>    thread_act_array_t threads;<br>    // è·å–åˆ°count<br>    task_threads(mach_task_self(), &amp;threads, &amp;count);<br>   <br>    // ä¿è¯åŠ é”çš„æ—¶å€™ï¼Œçº¿ç¨‹æ•°é‡ä¸å˜<br>    threadCount = count;<br>    <br>    // æ·»åŠ ğŸªé’©å­å‡½æ•°<br>    original_pthread_introspection_hook_t = pthread_introspection_hook_install(kry_pthread_introspection_hook_t);<br>    <br>    // è§£é” ä¿¡å·é‡+1<br>    dispatch_semaphore_signal(semaphore);<br>    <br>    // å¼€å§‹ç›‘æ§<br>    isMonitor = true;<br>    <br>    <br>    // å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ æ£€æµ‹æ¯ç§’çº¿ç¨‹åˆ›å»º ç„¶åé€šè¿‡clearNewThreadCountç½®ä½0<br>    const char *queenIdentifier = dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL);<br>    if (queenIdentifier == dispatch_queue_get_label(dispatch_get_main_queue())) &#123;<br>        [NSTimer scheduledTimerWithTimeInterval:1.0 target:self selector:@selector(clearNewThreadCount) userInfo:nil repeats:YES];<br>    &#125;else&#123;<br>        dispatch_async(dispatch_get_main_queue(), ^&#123;<br>        [NSTimer scheduledTimerWithTimeInterval:1.0 target:self selector:@selector(clearNewThreadCount) userInfo:nil repeats:YES];<br>        &#125;);<br>    &#125;<br>&#125;<br><br>// å½“å‰çº¿ç¨‹æ€»æ•°<br>+ (int)currentThreadCount&#123;<br>    return threadCount;<br>&#125;<br><br>void kry_pthread_introspection_hook_t(unsigned int event,<br>                                      pthread_t thread, void *addr, size_t size)&#123;<br>    <br>    // æ­£å¸¸è°ƒç”¨åŸæœ‰é€»è¾‘<br>    if (original_pthread_introspection_hook_t) &#123;<br>        original_pthread_introspection_hook_t(event,thread,addr,size);<br>    &#125;<br>    <br>    // å¼€å§‹è®°å½•<br>    <br>    // å¦‚æœæ˜¯åˆ›å»ºçº¿ç¨‹,åˆ™çº¿ç¨‹çš„æ•°é‡+1ï¼Œæ–°å¢æ•°+1<br>    if (event == PTHREAD_INTROSPECTION_THREAD_CREATE) &#123;<br>        threadCount +=1;<br>        if (isMonitor &amp;&amp; threadCount &gt; averageThreadCount) &#123;<br>            // æ€»æ•° è¶…è¿‡é˜ˆå€¼ è­¦å‘Šæˆ–è€…è®°å½•å †æ ˆ<br>            kry_Log_CallStack(false, 0);<br>        &#125;<br>        <br>        newThreadCount +=1;<br>        if (isMonitor &amp;&amp; newThreadCount &gt; newAverageThreadCount) &#123;<br>            // æ–°å¢æ•° è¶…è¿‡é˜ˆå€¼ è­¦å‘Šæˆ–è€…è®°å½•å †æ ˆ<br>            kry_Log_CallStack(true, newThreadCount);<br>        &#125;<br>    &#125;<br>    <br>    <br>    // é”€æ¯çº¿ç¨‹ï¼Œåˆ™çº¿ç¨‹æ•°é‡-1ï¼Œæ–°å¢æ•°-1<br>    if (event == PTHREAD_INTROSPECTION_THREAD_DESTROY) &#123;<br>        threadCount -=1;<br>       <br>        if (newThreadCount &gt; 0 ) &#123;<br>            newThreadCount -=1;<br>        &#125;<br>        <br>    &#125;<br>&#125;<br><br><br>void kry_Log_CallStack(bool isIncreaseLog, int num)<br>&#123;<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    if (isIncreaseLog) &#123;<br>        printf(&quot;\nğŸ”¥ä¸€ç§’é’Ÿå¼€å¯ %d æ¡çº¿ç¨‹ï¼ï¼ï¼ï¼\n&quot;, num);<br>    &#125;<br>    // å¯ä»¥è®°å½•å †æ ˆä¿¡æ¯<br>    dispatch_semaphore_signal(semaphore);<br>&#125;<br><br>+ (void)clearNewThreadCount&#123;<br>    newThreadCount = 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆç®€å•ï¼Œéƒ½æœ‰æ³¨é‡Šï¼Œè¿‘æœŸåœ¨çœ‹PCLçš„å †æ ˆè®°å½•ï¼ŒåæœŸä¼šæŠŠå †æ ˆè®°å½•å®Œå–„ä¸Šå»</p><h3 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h3><p><a href="https://www.jianshu.com/p/95df83780c8f">APPæ€§èƒ½æ£€æµ‹æ–¹æ¡ˆæ±‡æ€»</a></p><p><a href="https://juejin.cn/post/6844904122248855560">iOSçº¿ç¨‹æ•°é‡ç›‘æ§å·¥å…·</a></p>]]></content>
    
    
    <categories>
      
      <category>iOSæºç </category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-å¤œé—´æ¨¡å¼æ¡†æ¶</title>
    <link href="/2021/05/01/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/"/>
    <url>/2021/05/01/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<p>iOSå¤œé—´æ¨¡å¼çš„é€‚é…ï¼Œä¸»è¦ç”¨åˆ°äº†<code>NSProxy</code>è½¬å‘åŸç† ï¼Œå…¶ä¸­JYDynamicColorç»§æ‰¿äºUIColor</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface JYDynamicColor : UIColor<br><br>@property (nonatomic, readonly) UIColor * lightColor;<br><br>@property (nonatomic, readonly) UIColor * darkColor;<br><br>+ (UIColor *)colorWithLightColor:(UIColor *)lightColor darkColor:(UIColor *)darkColor;<br><br>+ (UIColor *)colorWithDynamicProvider:(UIColor * (^)(JYTraitCollection *traitCollection))dynamicProvider;<br><br>@end<br></code></pre></td></tr></table></figure><p>  ä½†æ˜¯åœ¨.mæ–‡ä»¶ä¸­,æˆ‘ä»¬å®é™…å°†æ¶ˆæ¯ç»™äº†JYDynamicColorProxyå¤„ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@implementation JYDynamicColor<br><br>+ (UIColor *)colorWithLightColor:(UIColor *)lightColor darkColor:(UIColor *)darkColor &#123;<br>  return [self colorWithDynamicProvider:^(JYTraitCollection *traitCollection)&#123;<br>    return traitCollection.userInterfaceStyle == JYInterfaceStyleDark ? darkColor : lightColor;<br>  &#125;];<br>&#125;<br><br>+ (UIColor *)colorWithDynamicProvider:(UIColor * _Nonnull (^)(JYTraitCollection * _Nonnull))dynamicProvider &#123;<br>    <br>    return (JYDynamicColor *)[[JYDynamicColorProxy alloc] initWithDynamicProvider:dynamicProvider];<br>&#125;<br><br>- (UIColor *)lightColor &#123;<br>  NSAssert(NO, @&quot;This should never be called&quot;);<br>  return nil;<br>&#125;<br><br>- (UIColor *)darkColor &#123;<br>  NSAssert(NO, @&quot;This should never be called&quot;);<br>   return nil;<br>&#125;<br><br>@end<br></code></pre></td></tr></table></figure><p>æ¥ç€çœ‹åˆ°<code>JYDynamicColorProxy</code>æ˜¯ç»§æ‰¿äº<code>NSProxy</code>ï¼Œå°†æ‰€æœ‰çš„äº‹ä»¶éƒ½è½¬å‘åˆ°äº†<code>resolvedColor</code>ï¼Œè€Œ<code>resolvedColor</code>æ˜¯æ ¹æ®å½“å‰æ¨¡å¼è¿”å› <code>lightColor</code> æˆ–è€… <code>darkColor</code>,è¿™æ ·å°±å®ç°äº†ï¼Œå¯¹å¤–å…¶å®æ˜¯ä¸€ä¸ª<code>UIColor</code>ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>JYDynamicColorProxy</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface JYDynamicColorProxy : NSProxy &lt;NSCopying&gt;<br><br>@property (nonatomic, readonly) UIColor * resolvedColor;<br><br>@property (nonatomic, strong) UIColor *(^dynamicProvider)(JYTraitCollection *);<br><br>@end<br><br><br>@implementation JYDynamicColorProxy<br><br>- (instancetype)initWithDynamicProvider:(UIColor * (^)(JYTraitCollection *traitCollection))dynamicProvider &#123;<br>  self.dynamicProvider = dynamicProvider;<br>  return self;<br>&#125;<br><br>// MARK: NSProxy - è½¬å‘æ¶ˆæ¯ å°†æ¶ˆæ¯å…¨éƒ¨è½¬å‘åˆ° resolvedColor<br>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;<br>  return [self.resolvedColor methodSignatureForSelector:sel];<br>&#125;<br><br>- (void)forwardInvocation:(NSInvocation *)invocation &#123;<br>  [invocation invokeWithTarget:self.resolvedColor];<br>&#125;<br><br>- (UIColor *)resolvedColor &#123;<br>  return [self resolvedColorWithTraitCollection:JYTraitCollection.overrideTraitCollection];<br>&#125;<br><br>- (UIColor *)resolvedColorWithTraitCollection:(JYTraitCollection *)traitCollection &#123;<br>    return self.dynamicProvider(traitCollection);<br>&#125;<br><br>// MARK: UIColor<br>- (UIColor *)colorWithAlphaComponent:(CGFloat)alpha &#123;<br>  return [JYDynamicColor colorWithDynamicProvider:^UIColor *(JYTraitCollection *traitCollection) &#123;<br>    return [self.dynamicProvider(traitCollection) colorWithAlphaComponent:alpha];<br>  &#125;];<br>&#125;<br><br>- (CGColorRef)CGColor &#123;<br>  return [[self resolvedColor] CGColor];<br>&#125;<br><br><br>// MARK: NSObject<br>- (BOOL)isKindOfClass:(Class)aClass &#123;<br>  static JYDynamicColor *dynamicColor = nil;<br>  static dispatch_once_t onceToken;<br>  dispatch_once(&amp;onceToken, ^&#123;<br>    dynamicColor = [[JYDynamicColor alloc] init];<br>  &#125;);<br>  return [dynamicColor isKindOfClass:aClass];<br>&#125;<br><br>// MARK: NSCopying<br>- (id)copy &#123;<br>  return [self copyWithZone:nil];<br>&#125;<br><br>- (id)copyWithZone:(NSZone *)zone &#123;<br>  return [[JYDynamicColorProxy alloc] initWithDynamicProvider:[self.dynamicProvider copy]];<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p> iOS13ä»¥ä¸‹ï¼Œå¦‚æœéœ€è¦åˆ‡æ¢é¢œè‰²ï¼Œè¯¥å¦‚ä½•åˆ·æ–°ï¼Ÿ<code>JYDynamicColorProxy</code>æ˜¯å¦‚ä½•å­˜å‚¨é¢œè‰²çš„å‘¢ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬<code>swizzle</code>å°†è®¾ç½®é¢œè‰²æ–¹æ³•è¿›è¡Œäº†hookï¼Œä¾‹å¦‚<code>@selector(setBackgroundColor:);</code>æ–¹æ³•ï¼Œå°†<code>backgroundColor</code>ä¸º<code>JYDynamicColor</code>çš„éƒ½è¿›è¡Œå¤„ç†</p><p>è¿™é‡Œé‡‡ç”¨äº†å…³è”å¯¹è±¡çš„æ€æƒ³ï¼Œå†™äº†ä¸€ä¸ª<code>UIView</code>çš„åˆ†ç±»,å°†<code>JYDynamicColorProxy</code>è¿›è¡Œå­˜å‚¨ï¼Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">...<br>@property (nullable, readonly) JYDynamicColor *jy_dynamicBackgroundColor;<br>...<br><br>- (JYDynamicColor *)jy_dynamicBackgroundColor &#123;<br>    return objc_getAssociatedObject(self, @selector(jy_dynamicBackgroundColor));<br>&#125;<br><br>- (void)setJy_dynamicBackgroundColor:(JYDynamicColor *)jy_dynamicBackgroundColor &#123;<br>  objc_setAssociatedObject(self,<br>                           @selector(jy_dynamicBackgroundColor),<br>                           jy_dynamicBackgroundColor,<br>                           OBJC_ASSOCIATION_COPY_NONATOMIC);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä¿®æ”¹å½“å‰æ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†åˆå§‹åŒ–æ‹¿åˆ°çš„<code>UIApplication</code>è¿›è¡Œéå†ï¼Œæ‹¿åˆ°<code>UIView</code>,ç„¶åè°ƒç”¨åˆ†ç±»å½“ä¸­çš„ä¿®æ”¹é¢œè‰²æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)jyTraitCollectionDidChange:(JYTraitCollection *)previousTraitCollection &#123;<br>  if (@available(iOS 13.0, *)) &#123;<br>    return;<br>  &#125;<br>    [self.subviews enumerateObjectsUsingBlock:^(__kindof UIView * _Nonnull view, NSUInteger idx, BOOL * _Nonnull stop) &#123;<br>        [view jyTraitCollectionDidChange:previousTraitCollection];<br>     &#125;];<br>     <br>    [self setNeedsLayout];<br>    [self setNeedsDisplay];<br>#if __IPHONE_OS_VERSION_MIN_REQUIRED &lt; __IPHONE_13_0<br>    [self jy_updateDynamicColors];<br>#endif<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)jy_updateDynamicColors&#123;<br>    JYDynamicColor * backgroundColor = [self jy_dynamicBackgroundColor];<br>    if (backgroundColor) &#123;<br>        [self setBackgroundColor:backgroundColor];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡å…³è”å¯¹è±¡å–åˆ°å¯¹åº”æ¨¡å¼çš„Color,ç„¶åèµ‹å€¼å³å¯ï¼Œå›¾ç‰‡ä¹Ÿæ˜¯ä¸€æ ·çš„åŸç†</p>]]></content>
    
    
    <categories>
      
      <category>iOSæºç </category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-åŠ¨æ€åº“ä¸é™æ€åº“çš„åŒºåˆ«</title>
    <link href="/2021/02/16/%E5%8A%A8%E6%80%81%E5%BA%93%E4%B8%8E%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <url>/2021/02/16/%E5%8A%A8%E6%80%81%E5%BA%93%E4%B8%8E%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h3 id="é™æ€åº“-Static-Library"><a href="#é™æ€åº“-Static-Library" class="headerlink" title="é™æ€åº“ (Static Library)"></a>é™æ€åº“ (Static Library)</h3><ul><li><p>åˆ†å‘æ–‡ä»¶å¤§</p></li><li><p>é™æ€åº“é»˜è®¤ä»…å°†æœ‰ç”¨åˆ°çš„ç±»æ–‡ä»¶<code>link</code>åˆ°<code>Mach-O</code>ä¸­(å·²ç±»æ–‡ä»¶ä¸ºæœ€å°é“¾æ¥å•ä½)</p></li><li><p>ipaåŒ…å°(ä¸ºäº†APPç˜¦èº«ï¼Œå°½é‡å°†ä»£ç æ”¾é™æ€åº“ä¸­) </p><ul><li>é™æ€åº“ä¸­æŸä¸ªç›®æ ‡æ–‡ä»¶çš„ä»£ç æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œåˆ™è¿™ä¸ªç›®æ ‡æ–‡ä»¶ä¸ä¼šè¢«é“¾æ¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»(å‰ææ˜¯ä¸è¦ä½¿ç”¨<code>-Objc</code>å’Œ<code>-all_load</code>é€‰é¡¹ï¼Œåˆ†ç±»ä»£ç ç»å¸¸è¢«ä¼˜åŒ–æ‰ï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨<code>-force_load</code>æ¥å¤„ç†é™æ€åº“åˆ†ç±»åŠ è½½é—®é¢˜)</li></ul></li><li><p>APPå†·å¯åŠ¨é€Ÿåº¦å¿«</p><ul><li>å‰ææ˜¯ä¸ä½¿ç”¨<code>åŠ¨æ€åº“æ‹†åˆ†</code>æ­é…<code>åŠ¨æ€åº“æ‡’åŠ è½½æ–¹æ¡ˆ</code></li><li>APPå¯åŠ¨æµç¨‹ä¸­æœ‰<code>rebase</code>å’Œ<code>bind</code>ï¼Œå¤šä¸ªé™æ€åº“åªéœ€è¦<code>rebase</code>å’Œ<code>bind</code>ä¸€æ¬¡</li></ul></li><li><p>å­˜åœ¨ç¬¦å·å†²çªå¯èƒ½</p></li><li><p>å…±äº«<code>TEXTæ®µ</code></p><ul><li>iOS9ä»¥å‰å•ä¸ªMach-Oçš„TEXTé™åˆ¶60M</li><li>iOS9ä»¥åå•ä¸ªMach-Oçš„TEXTé™åˆ¶500M</li></ul></li><li><p>ä¸éœ€è¦é¢å¤–ç­¾åéªŒè¯  </p></li><li><p>é™æ€åº“ç¬¦å·çš„å¯è§æ€§å¯ä»¥åœ¨é“¾æ¥æœŸé—´è¢«ä¿®æ”¹ </p></li><li><p>æ–‡ä»¶æ ¼å¼å¤šä¸º<code>fat</code>æ ¼å¼çš„é™æ€åº“æ–‡ä»¶</p></li><li><p>å½¢å¼å¤šä¸º<code>.a</code>ä¸<code>.framework</code></p></li><li><p>é™æ€åº“ä¸å«<code>bitcode</code>æ—¶ï¼Œå¼•ç”¨é™æ€åº“çš„ç›®æ ‡éƒ¨ç½²æ—¶å°±ä¸èƒ½åŒ…å«<code>bitcode</code></p></li></ul><h3 id="åŠ¨æ€åº“-Dynamic-Library"><a href="#åŠ¨æ€åº“-Dynamic-Library" class="headerlink" title="åŠ¨æ€åº“ (Dynamic Library)"></a>åŠ¨æ€åº“ (Dynamic Library)</h3><ul><li><p>åˆ†å‘æ–‡ä»¶å°</p></li><li><p>ipaåŒ…å¤§  ï¼ˆå‰ææ˜¯ä¸è€ƒè™‘æ‡’åŠ è½½çš„æƒ…å†µï¼‰</p><ul><li>åŠ¨æ€åº“ä¼šæŠŠæ•´ä¸ª<code>lib</code>å¤åˆ¶è¿›<code>ipa</code>ä¸­</li></ul></li><li><p>APPå†·å¯åŠ¨é€Ÿåº¦æ…¢</p><ul><li>APPå¯åŠ¨æµç¨‹ä¸­æœ‰<code>rebase</code>å’Œ<code>bind</code>ï¼Œå¤šä¸ªåŠ¨æ€åº“åªéœ€è¦å¤šæ¬¡<code>rebase</code>å’Œ<code>bind</code></li></ul></li><li><p>éœ€è¦è®¾ç½®åˆé€‚çš„<code>runpath</code> </p></li><li><p>éœ€è¦åŠ¨æ€åŠ è½½</p></li><li><p>éœ€è¦ç­¾åä¸”éœ€è¦éªŒè¯ç­¾å</p><ul><li>ä¼šæ£€æŸ¥<code>framework</code>çš„ç­¾åï¼Œç­¾åä¸­å¿…é¡»åŒ…å«<code>TeamIdentifier</code>,å¹¶ä¸”<code>framework</code>å’Œhost APPçš„<code>TeamIdentifier</code>å¿…é¡»ä¸€è‡´</li><li>Xcodeé‡ç­¾å‘½ï¼Œä¿è¯åŠ¨æ€åº“ç­¾åä¸€è‡´æ€§</li></ul></li><li><p>éœ€è¦å¯¼å‡ºç¬¦å·</p></li><li><p>é‡å¤çš„<code>arch</code>ç»“æ„</p></li><li><p>APPä¸åŠ¨æ€åº“ä¸­é‡å¤ä»£ç å¯ä»¥å…±å­˜ï¼Œä¸ä¼šå‘ç”Ÿç¬¦å·å†²çª</p><ul><li>å› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶åœ¨æ„å»ºé“¾æ¥é˜¶æ®µï¼Œé‡åˆ°é™æ€åº“åˆ™å¸é™„è¿›æ¥ï¼Œé‡åˆ°åŠ¨æ€åº“åˆ™æ‰“ä¸ªæ ‡è®°ï¼Œå½¼æ­¤ä¿æŒç‹¬ç«‹æ€§</li><li>å¯¹äºæ¥è‡ªåŠ¨æ€åº“çš„ç¬¦å·ï¼Œç¼–è¯‘å™¨ä¼šæ‰“ä¸ªæ ‡è®°ï¼Œäº¤ç»™<code>dyld</code>å»åŠ è½½å’Œé“¾æ¥ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯æŠŠé“¾æ¥çš„è¿‡ç¨‹æ¨è¿Ÿåˆ°äº†è¿è¡Œæ—¶æ‰§è¡Œã€‚ï¼ˆæ¯”å¦‚APPä½¿ç”¨çš„æ˜¯3.0ç‰ˆæœ¬SDKï¼ŒåŠ¨æ€åº“ä½¿ç”¨çš„æ˜¯1.0ç‰ˆæœ¬SDKï¼Œèƒ½æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¼šæœ‰é£é™©ï¼‰</li></ul></li><li><p>é“¾æ¥åéœ€è¦åŒ…å«åˆ†å‘å¤§å°</p></li><li><p>å†·å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œé»˜è®¤ä¼šåœ¨<code>main</code>å‡½æ•°ä¹‹å‰åŠ è½½</p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿‡å¤šçš„åŠ¨æ€åº“ä¼šæ‹–æ…¢å†·å¯åŠ¨é€Ÿåº¦</li><li>å¦‚æœé‡‡ç”¨æ‡’åŠ è½½åŠ¨æ€åº“çš„å½¢å¼ï¼Œèƒ½å¤ŸåŠ å¿«APPçš„å¯åŠ¨é€Ÿåº¦,å¯ä»¥ä½¿ç”¨<code>dlopen</code>å’Œ<code>bundle</code>æ‡’åŠ è½½ä¼˜åŒ–</li></ul></li><li><p>æ–‡ä»¶æ ¼å¼<code>Mach-O</code>ï¼ˆä¸€ä¸ªæ²¡æœ‰<code>main</code>å‡½æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰</p></li><li><p>åŠ¨æ€åº“ä¸åŒ…å«<code>bitcode</code>æ—¶ï¼Œå¼•ç”¨åŠ¨æ€åº“çš„ç›®æ ‡éƒ¨ç½²æ—¶å¯ä»¥åŒ…å«<code>bitcode</code></p></li><li><p><code>CocoaPods</code>ä»<code>v0.36.0</code>å¼€å§‹ï¼Œå¯æ·»åŠ å…³é”®å­—<code>use_frameworks!</code>ç¼–è¯‘æˆç±»ä¼¼<code>Embedded Framework</code>çš„ç»“æ„ï¼ˆå¯ä»¥ç§°ä¹‹ä¸º<code>umbrella framework</code>ï¼‰</p><ul><li>ç¼ºç‚¹ï¼šé»˜è®¤æŠŠé¡¹ç›®çš„ä¾èµ–å…¨éƒ¨æ”¹ä¸ºåŠ¨æ€åº“ï¼ˆå¯æ˜¯ä½¿ç”¨<code>use_modular_headers!</code>,ä¹Ÿå¯ä»¥åœ¨<code>podsepc</code>æ·»åŠ <code>s.static_framework = true</code>è§„é¿ï¼‰</li><li><code>CocoaPods</code>æ‰§è¡Œè„šæœ¬æŠŠåŠ¨æ€åº“åµŒå…¥åˆ°<code>.app</code>çš„<code>Framework</code>ç›®å½•ä¸‹ï¼ˆç›¸å½“äºåœ¨<code>Embedded Binaries</code>åŠ å…¥åŠ¨æ€åº“ï¼‰</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-åŒæ­¥æ–¹æ¡ˆï¼ˆé”ï¼‰</title>
    <link href="/2020/04/16/iOS%E4%B9%8B%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88%EF%BC%88%E9%94%81%EF%BC%89/"/>
    <url>/2020/04/16/iOS%E4%B9%8B%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88%EF%BC%88%E9%94%81%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>è¿‘æœŸè¦å†™ä¸€ä¸ªå¤šçº¿ç¨‹å·¥å…·ï¼ŒæŠŠä¹‹å‰å­¦ä¹ çš„å¤šçº¿ç¨‹ï¼Œä»¥åŠçº¿ç¨‹åŒæ­¥å¤ä¹ ä¸€ä¸‹ </p><p>å¤šçº¿ç¨‹çš„æœ¬è´¨ï¼šæœ‰å¤šæ¡çº¿ç¨‹ï¼Œä½†æ˜¯åªèƒ½æ‰§è¡Œä¸€æ¡ï¼Œå¦‚æœé—´éš”æ—¶é—´è®¾ç½®çš„è¶³å¤Ÿå°ï¼Œå°±ç»™äººçš„æ„Ÿè§‰æ˜¯å¤šæ¡çº¿ç¨‹æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•</p><p>iOSä¸­çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ</p><ul><li>OSSpinLock</li><li>os_unfair_lock</li><li>pthread_mutex</li><li>dispatch_semaphore</li><li>Dispatch_queue(DISPATCH_QUEUE_SERIAL)</li><li>NSLock</li><li>NSRecursiveLock</li><li>NSCondition</li><li>NSConditionLock</li><li>@synchronized</li></ul><h4 id="OSSpinLock-è‡ªæ—‹é”"><a href="#OSSpinLock-è‡ªæ—‹é”" class="headerlink" title="OSSpinLock - è‡ªæ—‹é”"></a>OSSpinLock - è‡ªæ—‹é”</h4><p> ç­‰å¾…é”ğŸ”çš„çº¿ç¨‹ä¼šå¤„äºå¿™ç­‰çŠ¶æ€ï¼Œä¸€ç›´å ç”¨CPUèµ„æº</p><p>ä¼šå‡ºç°ä¼˜å…ˆçº§ç¿»è½¬çš„é—®é¢˜ï¼Œå¦‚æœçº¿ç¨‹ä¹‹é—´çš„ä¼˜å…ˆçº§ä¸åŒï¼Œå¦‚æœä½ä¼˜å…ˆçº§çš„é”å…ˆè¿›æ¥ï¼ŒæŠŠé”é”ä½ï¼Œé‚£ä¹ˆé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹è¿›æ¥å°±ä¼šä¸€ç›´å¿™ç­‰ï¼Œä½†æ˜¯ç³»ç»Ÿåˆä¼šåˆ†é…æ—¶é—´èµ„æºç»™çº¿ç¨‹é«˜çš„ï¼Œä»è€Œå¯¼è‡´ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹æ— æ³•æ‰§è¡Œå®Œè‡ªå·±çš„ä»£ç ï¼Œä»è€Œå¯¼è‡´ä¼˜å…ˆçº§ä½çš„é”æ— æ³•é‡Šæ”¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–é”<br>self.lock = OS_SPINLOCK_INIT;<br>   <br>- (void)saleTicket&#123;<br>    /// åŠ é”<br>  OSSpinLockLock(&amp;_lock);<br>  //BOOL isLock =  OSSpinLockTry(&amp;_lock); <br>  int oldTicketsCount = self.ticketsCount;<br>  sleep(.2);<br>  oldTicketsCount--;<br>  self.ticketsCount = oldTicketsCount;<br>  NSLog(@&quot;è¿˜å‰©ä¸‹%då¼ ç¥¨ = %@&quot;,self.ticketsCount,[NSThread currentThread]);<br>  /// è§£é”<br>  OSSpinLockUnlock(&amp;_lock);<br>&#125;<br>   <br></code></pre></td></tr></table></figure><hr><h4 id="os-unfair-lock-iOS10åæ”¯æŒ-ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰"><a href="#os-unfair-lock-iOS10åæ”¯æŒ-ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰" class="headerlink" title="os_unfair_lock - iOS10åæ”¯æŒ ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰"></a>os_unfair_lock - iOS10åæ”¯æŒ ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰</h4><p>ç”¨äºæ›¿ä»£<code>OSSpinLock</code> çš„é”ï¼Œä½¿ç”¨çš„æŠ€æœ¯ä¸å†æ˜¯å¿™ç­‰ï¼Œè€Œæ˜¯ä¼‘çœ ç­‰å¾…å”¤é†’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–é”<br>self.lock = OS_UNFAIR_LOCK_INIT;<br>- (void)saleTicket&#123;   <br>    /// åŠ é”<br>    os_unfair_lock_lock(&amp;_lock);<br>//  BOOL isLock = os_unfair_lock_trylock(&amp;lock);<br>    // å–ç¥¨<br>    [self sale];<br>    /// è§£é”<br>    os_unfair_lock_unlock(&amp;_lock);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="pthread-mutex"><a href="#pthread-mutex" class="headerlink" title="pthread_mutex"></a>pthread_mutex</h4><p><code>mutex</code> å«åšâ€äº’æ–¥é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–å±æ€§    <br>pthread_mutexattr_t attr;<br>pthread_mutexattr_init(&amp;attr);<br>pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_DEFAULT);<br>/// åˆå§‹åŒ–é”<br>pthread_mutex_init(&amp;_lock, &amp;attr);<br><br>//é”€æ¯å±æ€§ pthread_mutexattr_destroy(&amp;attr);<br>//é”€æ¯é”   pthread_mutex_destroy(&amp;_lock);<br><br>- (void)saleTicket&#123; <br>    /// åŠ é”<br>    pthread_mutex_lock(&amp;_lock);<br>    ///å°è¯• åŠ é”<br>    //BOOL islock = pthread_mutex_trylock(&amp;_lock);<br>    // å–ç¥¨<br>    [self sale];<br>    /// è§£é”<br>    pthread_mutex_unlock(&amp;_lock);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/*<br> * Mutex type attributes<br> */<br>#define PTHREAD_MUTEX_NORMAL0  //æ™®é€šçŠ¶æ€é”<br>#define PTHREAD_MUTEX_ERRORCHECK1<br>#define PTHREAD_MUTEX_RECURSIVE2  //ç”¨äºå¤„ç†é€’å½’é”<br>#define PTHREAD_MUTEX_DEFAULTPTHREAD_MUTEX_NORMAL<br><br></code></pre></td></tr></table></figure><h5 id="é€’å½’é”"><a href="#é€’å½’é”" class="headerlink" title="é€’å½’é”"></a>é€’å½’é”</h5><p>é€’å½’é”ï¼šå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€æŠŠé”é‡å¤åŠ é”</p><p>çº¿ç¨‹ä¸€ : è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</p><ul><li>è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</li><li>è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</li></ul><p> çº¿ç¨‹äºŒï¼šè°ƒç”¨<code>saleTicket</code> (å‘ç°å·²ç»è¢«åŠ é”äº†ï¼Œç­‰å¾…) </p><p>å½“é”ä¸­é—´çš„ä»£ç é‡åˆ°é€’å½’è°ƒç”¨ï¼Œæ‰“å°çš„ç»“æœæ°¸è¿œåªæœ‰ä¸€æ¡<code>saleTicket</code>ï¼Œå› ä¸ºæ²¡æœ‰äººèƒ½å¤Ÿèµ°åˆ°è§£é”çš„é‚£ä¸€æ­¥ã€‚</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scss">- (void)saleTicket&#123;<br>    <span class="hljs-comment">/// åŠ é”</span><br>    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;_lock);<br>    <span class="hljs-comment">///å°è¯• åŠ é”</span><br>    <span class="hljs-comment">//BOOL islock = pthread_mutex_trylock(&amp;_lock);</span><br>    <span class="hljs-built_in">NSLog</span>(@&quot;%s&quot;,__func__);<br>    <span class="hljs-comment">// å–ç¥¨ é€’å½’è°ƒç”¨</span><br>    <span class="hljs-selector-attr">[self saleTicket]</span>;<br>    <span class="hljs-comment">/// è§£é”</span><br>    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;_lock);<br> <br>&#125;<br></code></pre></td></tr></table></figure><p> <code>pthread</code>æ˜¯æ”¯æŒé€’å½’é”çš„ï¼Œåªéœ€è¦æŠŠåˆå§‹åŒ–å±æ€§æ”¹ä¸ºé€’å½’é”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE);<br></code></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxupqijd8nj30c205igme.jpg"></p><h5 id="æ¡ä»¶é”"><a href="#æ¡ä»¶é”" class="headerlink" title="æ¡ä»¶é”"></a>æ¡ä»¶é”</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@property (nonatomic, assign) pthread_cond_t cond;<br><br>/// åˆå§‹åŒ–æ¡ä»¶<br>pthread_mutex_init(&amp;_lock, &amp;attr);<br><br>// é”€æ¯æ¡ä»¶<br>pthread_cond_destroy(&amp;_cond);<br><br>[[[NSThread alloc]initWithTarget:self selector:@selector(__remove) object:nil]start];<br>[[[NSThread alloc]initWithTarget:self selector:@selector(__add) object:nil]start];<br><br>- (void)__remove&#123;<br>   <br>    pthread_mutex_lock(&amp;_lock);<br>    <br>    if (self.dataArray.count == 0) &#123;<br>        //ä¸€æ—¦è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå°±ä¼šæ”¾å¼€è¿™æŠŠé”ï¼Œç›´åˆ°åˆ«äººå‘é€ä¿¡å·å”¤é†’<br>        pthread_cond_wait(&amp;_cond, &amp;_lock);<br>    &#125;<br>    [self.dataArray removeLastObject];<br>    NSLog(@&quot;åˆ é™¤äº†å…ƒç´ &quot;);<br>    pthread_mutex_unlock(&amp;_lock);<br>&#125;<br><br>- (void)__add&#123;<br>    <br>    pthread_mutex_lock(&amp;_lock);<br>    <br>    [self.dataArray addObject:@&quot;123&quot;];<br>    NSLog(@&quot;æ·»åŠ äº†å…ƒç´ &quot;);<br>     <br>    pthread_cond_signal(&amp;_cond);<br>    pthread_mutex_unlock(&amp;_lock);<br>    // è¿™é‡Œéœ€è¦ä¿è¯pthread_cond_signalåœ¨pthread_mutex_unlockä¹‹å‰<br>    // å¦‚æœåœ¨ä¹‹åçš„è¯ï¼Œé”è§£å¼€äº†ï¼Œå‘é€ä¿¡å·çš„è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å¯èƒ½è¢«åˆ«çš„é”æŠ¢å…ˆè¿›æ¥äº†<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><h4 id="NSLock-x2F-NSRecursiveLock-x2F-NSCondition"><a href="#NSLock-x2F-NSRecursiveLock-x2F-NSCondition" class="headerlink" title="NSLock&#x2F;NSRecursiveLock&#x2F;NSCondition"></a>NSLock&#x2F;NSRecursiveLock&#x2F;NSCondition</h4><ul><li><p><code>NSLock</code>æ˜¯å¯¹<code>mutex</code>æ™®é€šé”çš„å°è£…</p></li><li><p><code>NSRecursiveLock</code> æ˜¯å¯¹<code>mutex</code>é€’å½’é”çš„å°è£…</p></li><li><p><code>NSCondition</code> æ˜¯å¯¹<code>mutex</code>å’Œ<code>cont</code>çš„å°è£…</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@protocol NSLocking<br><br>- (void)lock;<br>- (void)unlock;<br><br>@end<br><br>@interface NSLock : NSObject &lt;NSLocking&gt; &#123;<br>@private<br>    void *_priv;<br>&#125;<br><br>- (BOOL)tryLock; // å°è¯•åŠ é”<br>- (BOOL)lockBeforeDate:(NSDate *)limit; //åœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰ç­‰ä¸åˆ°è¿™ä¸ªé”ï¼Œéƒ½ä¼šç¡çœ <br><br>@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));<br>@end<br></code></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥çœ‹GNUStepçœ‹åˆ°<code>NSLock</code>çš„å®ç°</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxusubtzxlj30js0b8400.jpg"></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface NSConditionLock : NSObject &lt;NSLocking&gt; &#123;<br>@private<br>    void *_priv;<br>&#125;<br><br>- (instancetype)initWithCondition:(NSInteger)condition NS_DESIGNATED_INITIALIZER;<br><br>@property (readonly) NSInteger condition;<br>- (void)lockWhenCondition:(NSInteger)condition;<br>- (BOOL)tryLock;<br>- (BOOL)tryLockWhenCondition:(NSInteger)condition;<br>- (void)unlockWithCondition:(NSInteger)condition;<br>- (BOOL)lockBeforeDate:(NSDate *)limit;<br>- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;<br><br>@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));<br><br>@end<br></code></pre></td></tr></table></figure><hr><h4 id="Dispatch-queue-DISPATCH-QUEUE-SERIAL-ä¸²è¡Œé˜Ÿåˆ—"><a href="#Dispatch-queue-DISPATCH-QUEUE-SERIAL-ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="Dispatch_queue(DISPATCH_QUEUE_SERIAL) - ä¸²è¡Œé˜Ÿåˆ—"></a>Dispatch_queue(DISPATCH_QUEUE_SERIAL) - ä¸²è¡Œé˜Ÿåˆ—</h4><ul><li>ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥ï¼Œä¿è¯äº†æ¯ä¸€æ¡çº¿ç¨‹çš„æ“ä½œéƒ½æ˜¯æŒ‰é¡ºåºçš„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">  @property (nonatomic, strong) dispatch_queue_t  queen;<br>  <br>  self.queen =  dispatch_queue_create(&quot;123&quot;, DISPATCH_QUEUE_SERIAL);<br>  <br>  - (void)test&#123;<br>    self.ticketsCount = 20;<br>    <br>    dispatch_async(self.queen, ^&#123;<br>        for (int i = 0; i&lt;5; i++) &#123;<br>            [self saleTicket];<br>        &#125;<br>    &#125;);<br>    <br>    dispatch_async(self.queen, ^&#123;<br>        for (int i = 0; i&lt;5; i++) &#123;<br>            [self saleTicket];<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="dispatch-semaphore-ä¿¡å·é‡"><a href="#dispatch-semaphore-ä¿¡å·é‡" class="headerlink" title="dispatch_semaphore - ä¿¡å·é‡"></a>dispatch_semaphore - ä¿¡å·é‡</h4><ul><li>ä¿¡å·é‡çš„åˆå§‹å€¼ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶çº¿ç¨‹çš„å¹¶å‘è®¿é—®çš„æœ€å¤§æ•°é‡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@property (nonatomic, strong) dispatch_semaphore_t semaphore;<br>  // è®¾ç½®æœ€å¤§å¹¶å‘æ•°     <br> self.semaphore = dispatch_semaphore_create(1);<br>      <br>  for (int i = 0; i&lt;20; i++) &#123;<br>     [[[NSThread alloc]initWithTarget:self selector:@selector(test) object:nil]start];<br>  &#125;<br>  <br>- (void)test&#123;    <br>    // å¦‚æœä¿¡å·é‡çš„å€¼&gt;0,å°±è®©ä¿¡å·é‡å‡1ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç <br>    // ç›´åˆ°ä¿¡å·é‡çš„å€¼&lt;=0çš„æ—¶å€™ï¼Œå°±ä¼šä¼‘çœ ç­‰å¾…<br>    // DISPATCH_TIME_FOREVERæ°¸è¿œ æˆ–è€… è®¾ç½®æˆ DISPATCH_TIME_NOWç°åœ¨ç«‹å³<br>    dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);<br>    self.ticketsCount--;<br>    sleep(2);<br>    NSLog(@&quot;å‰©ä¸‹çš„ç¥¨ä¸º %d&quot;,self.ticketsCount);<br>    //è®©ä¿¡å·é‡çš„å€¼+1<br>    dispatch_semaphore_signal(self.semaphore);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h4><ul><li><code>@synchronized</code>æ˜¯å¯¹<code>mutex</code>é€’å½’é”çš„å°è£…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@synchronized (self) &#123; //objc_sync_enter<br>&#125; // objc_sync_exit<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">int objc_sync_enter(id obj)<br>&#123;<br>    int result = OBJC_SYNC_SUCCESS;<br><br>    if (obj) &#123;<br>        SyncData* data = id2data(obj, ACQUIRE);<br>        ASSERT(data);<br>        data-&gt;mutex.lock();<br>    &#125; else &#123;<br>        // @synchronized(nil) does nothing<br>        if (DebugNilSync) &#123;<br>            _objc_inform(&quot;NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug&quot;);<br>        &#125;<br>        objc_sync_nil();<br>    &#125;<br><br>    return result;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>id2data</code> æ–¹æ³•å†…éƒ¨</p><p>![image-20211229175537934](&#x2F;Users&#x2F;karthrine&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20211229175537934.png)</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxuusl6m2wj30cm01z74g.jpg"></p><p>å†…éƒ¨æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ŒæŠŠ<code>obj</code>å½“åš<code>key</code> ï¼Œ<code>data-&gt;mutex.lock();</code> æ‹¿åˆ°å”¯ä¸€çš„mutexé”ï¼Œæ¥åŠ é”</p><hr><h4 id="è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”"><a href="#è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”" class="headerlink" title="è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”"></a>è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”</h4><p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨è‡ªæ—‹é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´å¾ˆçŸ­</li><li>åŠ é”çš„ä»£ç ï¼ˆä¸´ç•ŒåŒºï¼‰ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰æƒ…å†µå¾ˆå°‘å‘é€</li><li>CPUèµ„æºä¸ç´§å¼ </li><li>å¤šæ ¸å¤„ç†å™¨</li></ul><p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨äº’æ–¥é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´è¾ƒé•¿</li><li>å•æ ¸å¤„ç†å™¨</li><li>ä¸´ç•ŒåŒºæœ‰IOæ“ä½œ</li><li>ä¸´ç•ŒåŒºä»£ç å¤æ‚æˆ–è€…å¾ªç¯é‡å¤§</li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æµ‹è¯•æ–‡ç« </title>
    <link href="/2019/04/17/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/"/>
    <url>/2019/04/17/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
