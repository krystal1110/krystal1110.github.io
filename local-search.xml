<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>iOS-ç³»ç»ŸCå‡½æ•°çš„hook</title>
    <link href="/2022/02/01/iOS-C%E5%87%BD%E6%95%B0%E7%9A%84hook/"/>
    <url>/2022/02/01/iOS-C%E5%87%BD%E6%95%B0%E7%9A%84hook/</url>
    
    <content type="html"><![CDATA[<h3 id="fishhookæ–¹æ¡ˆ"><a href="#fishhookæ–¹æ¡ˆ" class="headerlink" title="fishhookæ–¹æ¡ˆ"></a>fishhookæ–¹æ¡ˆ</h3><p>é€šè¿‡è§£æ<code>bind</code>ã€<code>lazy_bind</code>ã€<code>weak_bind</code>å¯ä»¥è·å–åˆ°å…ƒç»„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç»„ä¼šå‘Šè¯‰æˆ‘ä»¬ç¬¦å·å’ŒæŒ‡é’ˆä¿¡æ¯ï¼ŒæŒ‡é’ˆä¿¡æ¯åŒ…æ‹¬æŒ‡é’ˆä½äºå“ªä¸ªæ®µä»¥åŠåœ¨æ®µçš„åç§»</p><p>åœ¨iOSä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”¨å˜é‡æˆ–ç±»ä¼¼<code>NSLog()</code>ç­‰å¤–éƒ¨å‡½æ•°å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨åœ°å€ï¼Œè€Œæ˜¯åœ¨ç»è¿‡bind æˆ– lazy_bindåæ‰èƒ½å¾—åˆ°çœŸæ­£çš„åœ°å€ã€‚bindæˆ–lazy_bindåçœŸæ­£çš„å‡½æ•°åœ°å€è®°å½•åœ¨ <code>nl_symbol_ptr</code> æˆ– <code>la_symbol_ptr</code>ä¸­ï¼Œé€šè¿‡ç¬¦å·è¡¨å¯ä»¥æ‰¾åˆ°æ¯ä¸ªå‡½æ•°å¯¹åº”åœ¨<code>nl_symbol_ptr</code>æˆ–<code>la_symbol_ptr</code>ä¸­çš„åœ°å€ã€‚fishhook å°±æ˜¯é€šè¿‡æŸ¥æ‰¾ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°è®°å½•å‡½æ•°æŒ‡é’ˆçš„åœ°å€ä¿®æ”¹å‡½æ•°æŒ‡é’ˆä»è€Œå®ç°Cå‡½æ•°çš„hookã€‚</p><p>bindæ˜¯åœ¨åŠ è½½é•œåƒçš„æ—¶å€™å°±å°±å·²ç»ç»‘å®šï¼Œè€Œlazy_bindæ˜¯åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰è§¦å‘ç»‘å®šã€‚</p><blockquote><p> lazy_bindæ˜¯å¦‚ä½•å®ç°åœ¨é¦–æ¬¡è°ƒç”¨å‡½æ•°æ—¶è¿›è¡Œbindçš„å‘¢ï¼Ÿ</p></blockquote><p>å‡è®¾å¼ ä¸‰å’Œæå››æ˜¯åŒå­¦ï¼Œè€å¸ˆæ‰‹é‡Œæœ‰ä¸ªåå•ï¼Œè¿™ä¸ªåå•ä¸Šè®°å½•ç€è¦å‚åŠ å€¼æ—¥çš„åŒå­¦ã€‚æœ¬æ¥ä»Šå¤©åº”è¯¥æ˜¯æå››å€¼æ—¥ï¼Œä½†æ˜¯ç”±äºæ‰“å°åå•æ—¶æ•™åŠ¡å¤„è€å¸ˆä¸çŸ¥é“æå››çš„åå­—ï¼Œå› æ­¤æ‰“å°äº†ç­é•¿å¼ ä¸‰çš„åå­—ã€‚è€å¸ˆåªè®¤åå•ï¼Œå› æ­¤è€å¸ˆæ‰¾æ¥å¼ ä¸‰æ‰“æ‰«å«ç”Ÿã€‚ä½†æ˜¯å¼ ä¸‰åªåšäº†ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯æŠŠåå•ä¸Šçš„åå­—æ”¹æˆäº†æå››ï¼Œå¹¶ä¸”å«æå››æ¥æ‰“æ‰«å«ç”Ÿã€‚è¿™æ ·è€å¸ˆä»¥åå¦‚æœå†å©å’æ‰“æ‰«å«ç”Ÿçš„äº‹æƒ…æ—¶å°±ç›´æ¥æ‰¾åˆ°äº†æå››ã€‚è¿™å°±æ˜¯lazy_bindã€‚æ•…äº‹ä¸­è€å¸ˆå°±æ˜¯æˆ‘ä»¬å†™çš„ä»£ç ï¼Œä»£ç åªè®¤åœ°å€ã€‚åå•å°±æ˜¯<code>la_symbol_ptr</code>ï¼Œä¸Šé¢è®°å½•äº†å€¼æ—¥åŒå­¦åã€‚å¼ ä¸‰å°±æ˜¯stubæœºåˆ¶ï¼Œå®ƒåªæ˜¯èµ·åˆ°äº†è¾…åŠ©ä½œç”¨ã€‚è€Œæå››åˆ™æ˜¯çœŸæ­£çš„å¤–éƒ¨å‡½æ•°ï¼Œéœ€è¦çœŸæ­£æ‰§è¡Œçš„å‡½æ•°ã€‚</p><h3 id="åŠ¨æ€åº“Cå‡½æ•°hook"><a href="#åŠ¨æ€åº“Cå‡½æ•°hook" class="headerlink" title="åŠ¨æ€åº“Cå‡½æ•°hook"></a>åŠ¨æ€åº“Cå‡½æ•°hook</h3><p>é™¤äº†<code>fishhook</code>å¤–ï¼Œç¬”è€…ä¹Ÿæœ‰ä¸€ç§Cå‡½æ•°çš„é™æ€hookæ–¹å¼ï¼Œç›¸æ¯”äº<code>fishhook</code>ï¼Œæ­¤æ–¹æ¡ˆä¸å­˜åœ¨è€—æ—¶çš„æŸ¥æ‰¾æ¯”å¯¹æ“ä½œã€‚ä¸‹é¢æˆ‘å°†ä»‹ç»è¿™ç§æ¯”è¾ƒç‰¹æ®Šçš„æ–¹æ¡ˆï¼šåŸºäºåŠ¨æ€åº“çš„Cå‡½æ•°hook </p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1dv8sqwtvj20xc0fjmyr.jpg"></p><p><strong>Step1</strong>: é¦–å…ˆåœ¨ä¸»å·¥ç¨‹ä¸­å®šä¹‰ä¸€ä¸ªåŒååŒå‚åŒè¿”å›çš„å‡½æ•°ï¼Œè¿™æ ·åœ¨<code>ld64</code>é“¾æ¥æ—¶ä¼šè®¤ä¸º<code>func1</code>å’Œ<code>func2</code> ä¸­ç”¨åˆ°çš„<code>NSLog</code>æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œè¿™æ ·å°±ä¸ä¼šè·Ÿç³»ç»Ÿåº“çš„å‡½æ•°è¿›è¡ŒåŒ¹é…ï¼Œ<code>NSLog</code>ä¹Ÿå°±ä¸ä¼šè¢«æ ‡è®°ä¸ºéœ€è¦<code>bind</code>çš„å‡½æ•°ã€‚</p><p><strong>Step2</strong>: åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>NSLog</code>å†…éƒ¨ï¼Œæˆ‘ä»¬è°ƒç”¨è‡ªå®šä¹‰åŠ¨æ€åº“çš„ä¸­é—´å‡½æ•°<code>MyNSLog</code>ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†èƒ½å¤Ÿè°ƒç”¨åˆ°çœŸæ­£çš„<code>NSLog</code></p><p><strong>Step3</strong>: ç”±äºåŠ¨æ€åº“ä¸­æˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰<code>NSLog</code>å»â€œæ¬ºéª—â€ld64ï¼Œå› æ­¤åŠ¨æ€ä¸­çš„<code>NSLog</code>ä¼šå»è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿå‡½æ•°ã€‚</p><p>åˆ°è¿™é‡Œå¯èƒ½æœ‰åŒå­¦ä¼šé—®ï¼Œâ€œéš¾é“åŠ¨æ€åº“çš„<code>NSLog</code>ä¸å­˜åœ¨é‡æ–°è°ƒç”¨åˆ°ä¸»ç¨‹åºçš„<code>NSLog</code>å‡½æ•°çš„é£é™©å—ï¼Ÿé‚£æ ·å²‚ä¸æ˜¯ä¼šæ­»å¾ªç¯ï¼Ÿâ€</p><p>ä¸ä¼šçš„ã€‚å› ä¸ºåŠ¨æ€åº“æ˜¯å…·å¤‡ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹çš„äº§ç‰©ã€‚ç»è¿‡é“¾æ¥æ—¶ï¼Œåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å°±å·²ç»å†™å®šäº†<code>NSLog</code>  <code>bind</code>åˆ°ç³»ç»Ÿåº“ä¸­çš„<code>NSLog</code>äº†ï¼Œå› æ­¤åœ¨å¯åŠ¨é˜¶æ®µ<code>dyld</code>ä¸ä¼šâ€œè¿æŠ—â€äºŒè¿›åˆ¶çš„å‘½ä»¤æ‰§è¡Œåˆ°ä¸»ç¨‹åºçš„<code>NSLog</code>ã€‚</p><p>ä½†æ˜¯ç”±äºä¾µå…¥æ€§è¾ƒå¼ºï¼Œä»…å¯¹éƒ¨åˆ†éœ€è¦<strong>åŒæ­¥å¯åŠ¨</strong>ç”¨åˆ°çš„å‡½æ•°ä½¿ç”¨ã€‚<code>fishhook</code> è¿˜æ˜¯é¡¹ç›®ä¸­æœ€ä¸»è¦çš„ä½¿ç”¨æ–¹å¼ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–</title>
    <link href="/2022/01/01/dyld%202%20%E5%92%8C%20dyld%203%20%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%20%E4%BB%A5%E5%8F%8AiOS15%E4%B8%8Adyld%E7%9A%84%E5%8F%98%E5%8C%96/"/>
    <url>/2022/01/01/dyld%202%20%E5%92%8C%20dyld%203%20%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8C%BA%E5%88%AB%20%E4%BB%A5%E5%8F%8AiOS15%E4%B8%8Adyld%E7%9A%84%E5%8F%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="dyld-2-å’Œ-dyld-3-æœ‰å“ªäº›åŒºåˆ«-ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–"><a href="#dyld-2-å’Œ-dyld-3-æœ‰å“ªäº›åŒºåˆ«-ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–" class="headerlink" title="dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–"></a>dyld 2 å’Œ dyld 3 æœ‰å“ªäº›åŒºåˆ«? ä»¥åŠiOS15ä¸Šdyldçš„å˜åŒ–</h3><p>dyld æ˜¯åŠ¨æ€åŠ è½½å™¨ï¼Œå®ƒä¸»è¦ç”¨äºåŠ¨æ€åº“çš„é“¾æ¥å’Œç¨‹åºå¯åŠ¨åŠ è½½å·¥ä½œï¼Œå®ƒç›®å‰æœ‰ä¸¤ä¸ªä¸»è¦ç‰ˆæœ¬ï¼šdyld 2 å’Œ dyld 3ã€‚</p><p><strong>dyld 2</strong></p><p><a href="https://github.com/opensource-apple/dyld/tree/master/src" title="dyldå¼€æºåœ°å€">dyld2</a> ä» iOS 3.1 å¼€å§‹å¼•å…¥ï¼Œä¸€ç›´åˆ° iOS 12 è¢« dyld 3 å…¨é¢ä»£æ›¿ã€‚å®ƒç»è¿‡äº†å¾ˆå¤šæ¬¡ç‰ˆæœ¬è¿­ä»£ï¼Œæˆ‘ä»¬ç°åœ¨å¸¸è§çš„ç‰¹æ€§æ¯”å¦‚ ASLRï¼ŒCode Signï¼ŒShared Cache ç­‰æŠ€æœ¯ï¼Œéƒ½æ˜¯åœ¨ dyld 2 ä¸­å¼•å…¥çš„ã€‚dyld 2 çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="http://cdn.zhangferry.com/Images/20220104235847.png"></p><ul><li>è§£æ <code>mach-o</code> å¤´æ–‡ä»¶ï¼Œæ‰¾åˆ°ä¾èµ–åº“ï¼Œä¾èµ–åº“åˆå¯èƒ½æœ‰åˆ«çš„ä¾èµ–ï¼Œè¿™é‡Œä¼šè¿›è¡Œé€’å½’åˆ†æï¼Œç›´åˆ°è·å¾—æ‰€æœ‰ dylib çš„å®Œæ•´å›¾ã€‚è¿™é‡Œæ•°æ®åºå¤§ï¼Œéœ€è¦è¿›è¡Œå¤§é‡çš„å¤„ç†ï¼›</li><li>æ˜ å°„æ‰€æœ‰ <code>mach-o</code> æ–‡ä»¶ï¼Œå°†å®ƒä»¬æ”¾å…¥åœ°å€ç©ºé—´ï¼›</li><li>æ‰§è¡Œç¬¦å·æŸ¥æ‰¾ï¼Œè‹¥ä½ çš„ç¨‹åºä½¿ç”¨ <code>printf</code> å‡½æ•°ï¼Œå°†ä¼šæŸ¥æ‰¾ <code>printf</code> æ˜¯å¦åœ¨åº“ç³»ç»Ÿä¸­ï¼Œç„¶åæˆ‘ä»¬æ‰¾åˆ°å®ƒçš„åœ°å€ï¼Œå°†å®ƒå¤åˆ¶åˆ°ä½ çš„ç¨‹åºä¸­çš„å‡½æ•°æŒ‡é’ˆä¸Šï¼›</li><li>è¿›è¡Œ bind å’Œ rebaseï¼Œä¿®å¤å†…éƒ¨å’Œå¤–éƒ¨æŒ‡é’ˆï¼›</li><li>è¿è¡Œä¸€äº›åˆå§‹åŒ–ä»»åŠ¡ï¼Œåƒæ˜¯åŠ è½½ categoryã€load æ–¹æ³•ç­‰ï¼›</li><li>æ‰§è¡Œ mainï¼›</li></ul><p><strong>dyld 3</strong></p><p>dyld 3 åœ¨ 2017 å¹´å°±è¢«å¼•å…¥è‡³ iOS 11ï¼Œå½“æ—¶ä¸»è¦ç”¨æ¥ä¼˜åŒ–ç³»ç»Ÿåº“ã€‚ç°åœ¨ï¼Œåœ¨ iOS 13 ä¸­å®ƒä¹Ÿå°†ç”¨äºå¯åŠ¨ç¬¬ä¸‰æ–¹ APPï¼Œå®Œå…¨æ›¿ä»£ dyld 2ã€‚</p><p>dyld 3 æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¼•å…¥äº†å¯åŠ¨é—­åŒ…ï¼Œé—­åŒ…é‡ŒåŒ…å«äº†å¯åŠ¨æ‰€éœ€è¦çš„ç¼“å­˜ä¿¡æ¯ï¼Œè€Œä¸”è¿™ä¸ªé—­åŒ…åœ¨è¿›ç¨‹å¤–å°±å®Œæˆäº†ã€‚åœ¨æ‰“å¼€ APP æ—¶ï¼Œå®é™…ä¸Šå·²ç»æœ‰ä¸å°‘å·¥ä½œéƒ½å®Œæˆäº†ï¼Œè¿™ä¼šä½¿ dyld çš„æ‰§è¡Œæ›´å¿«ã€‚</p><p>æœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯å¯åŠ¨é—­åŒ…ï¼Œé—­åŒ…é‡ŒåŒ…å«äº†å¯åŠ¨æ‰€éœ€è¦çš„ç¼“å­˜ä¿¡æ¯ï¼Œä»è€Œæé«˜å¯åŠ¨é€Ÿåº¦ã€‚ä¸‹å›¾æ˜¯ dyld 2 å’Œ dyld 3 çš„æ‰§è¡Œæ­¥éª¤å¯¹æ¯”ï¼š</p><p><img src="http://cdn.zhangferry.com/Images/20220105001119.png"></p><p>dyld 3 çš„æ‰§è¡Œæ­¥éª¤åˆ†ä¸¤å¤§æ­¥ï¼Œä»¥å›¾ä¸­è™šçº¿éš”å¼€ï¼Œè™šçº¿ä»¥ä¸Šè¿›ç¨‹å¤–æ‰§è¡Œï¼Œä»¥ä¸‹è¿›ç¨‹åˆ›å»ºæ—¶æ‰§è¡Œï¼š</p><ul><li>å‰ 3 æ­¥æŸ¥æ‰¾ä¾èµ–å’Œç¬¦å·ç›¸å¯¹è€—æ—¶ï¼Œä¸”æ¶‰åŠä¸€äº›å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥å°†è¿™äº›ä¿¡æ¯åšæˆç¼“å­˜é—­åŒ…å†™å…¥ç£ç›˜é‡Œï¼Œå¯¹åº”åœ°å€ï¼š<code>tmp/com.apple.dyld</code>ã€‚é—­åŒ…ä¼šåœ¨é‡å¯æ‰‹æœº&#x2F;æ›´æ–°&#x2F;ä¸‹è½½ App çš„é¦–å¯ç­‰æ—¶æœºåˆ›å»ºã€‚</li><li>è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œè¯»å–é—­åŒ…å¹¶éªŒè¯é—­åŒ…æœ‰æ•ˆæ€§ã€‚</li><li>åé¢æ­¥éª¤åŒ dyld 2</li></ul><h3 id="iOS-15-çš„LC-DYLD-CHAINED-FIXUPS"><a href="#iOS-15-çš„LC-DYLD-CHAINED-FIXUPS" class="headerlink" title="iOS 15 çš„LC_DYLD_CHAINED_FIXUPS"></a>iOS 15 çš„LC_DYLD_CHAINED_FIXUPS</h3><p>åœ¨iOS15 ä¸Šï¼ŒAPPçš„<code>rebase</code> &amp; <code>bind</code> çš„æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ã€‚</p><p>å¦‚æœæˆ‘ä»¬å°†<code>iOS Deployment Target</code>è®¾ç½®ä¸º15çš„è¯ï¼Œé€šè¿‡<code>MachOView</code>æŸ¥çœ‹æ‰“åŒ…åçš„Mach-Oæ–‡ä»¶ä¼šå‘ç°æ–°çš„äºŒè¿›åˆ¶ä¸Šå‡ºç°äº†ä¸æ”¯æŒçš„LCã€‚</p><p><img src="https://upload-images.jianshu.io/upload_images/4642217-76d3f18e9cc92b52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/830/format/webp" alt="img"></p><p>è¿™æ˜¯ç”±äº<code>LC_DYLD_INFO_ONLY</code>è¢«æ›¿æ¢æˆäº†æ–°å¢çš„<code>LC_DYLD_EXPORTS_TRIE</code>å’Œ<code>LC_DYLD_CHAINED_FIXUPS</code>ã€‚</p><p>æ–‡ä»¶çš„å˜åŒ–æ„å‘³ç€iOS 15çš„<code>rebase</code>å’Œ<code>bind</code>æœºåˆ¶å‘ç”Ÿäº†å˜åŒ–ã€‚å›é¡¾iOS 14åŠä»¥å‰ï¼Œ<code>dyld</code>æ˜¯é€šè¿‡è§£æå‹ç¼©å­—èŠ‚æµå®ç°äº†<code>rebase</code>å’Œ<code>bind</code>ã€‚è§£æå‹ç¼©å­—èŠ‚ä¼šå‘Šè¯‰<code>dyld</code> æ•´ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­æœ‰å“ªäº›åœ°å€éœ€è¦ä¿®æ­£ï¼Œä»¥åŠåœ¨<code>bind</code>æ—¶æ¯ä¸ªåœ°å€æ˜¯ä¸ºå“ªä¸ªå¤–éƒ¨ç¬¦å·é¢„ç•™ã€‚é‚£iOS 15 <code>dyld</code>æ˜¯å¦‚ä½•è¿›è¡Œè¿‡ä¿®æ­£çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬æ¢ç´¢ä¸‹<code>dyld</code>ã€‚</p><p> å‰æ®µæ—¶é—´å¬åˆ°æœ‰åŒå­¦è®¨è®ºiOS 15 <code>dyld3</code> æ›´æ–°ä¸º<code>dyld4</code>äº†ã€‚ç¬”è€…æ— æ³•ç¡®å®šè‹¹æœæ˜¯å¦å·å·åœ°å‡çº§äº†<code>dyld</code>ï¼Œä½†æ˜¯ä»è››ä¸é©¬è¿¹ä¸­å¯ä»¥çœ‹å‡ºæ¥<code>dyld</code> ç¡®å®æ˜¯æœ‰å˜åŒ–ï¼Œä¾‹å¦‚åœ¨<code>instrument</code> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°éƒ¨åˆ†å‡½æ•°çš„å‘½åç©ºé—´å˜æˆäº†<code>dyld4</code>ã€‚è¿˜æœ‰å°±æ˜¯ä¸€äº›APIçš„è°ƒç”¨ä¸Šå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">let header:UnsafePointer<span class="hljs-tag">&lt;<span class="hljs-name">mach_header</span>&gt;</span> = _dyld_get_image_header(0)<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨iOS 15ç³»ç»Ÿä¹‹å‰é€šè¿‡ç´¢å¼•è·å–<code>header</code>æ—¶ï¼Œå¦‚æœ<code>index == 0</code>ï¼Œè¿”å›çš„æ˜¯å¯æ‰§è¡Œç¨‹åºçš„<code>header</code>ã€‚ä½†æ˜¯åœ¨iOS 15ä¸­ï¼Œ<code>index == 0</code>è·å–åˆ°çš„å´æ˜¯ç³»ç»Ÿåº“ã€‚å½“ç„¶è¿™äº›å˜åŒ–å¯¹æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å¯èƒ½è¿˜ä¸è¶³ä»¥äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯å¯ä»¥è¯´æ˜<code>dyld</code> ç¡®å®šæ˜¯æœ‰æ”¹åŠ¨ã€‚é‚£<code>LC_DYLD_CHAINED_FIXUPS</code>æ˜¯<code>dyld</code>çš„æ–°ç‰¹æ€§å—ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å› ä¸ºä»<code>dyld3</code>çš„<code>dyld-852.2</code>ç‰ˆæœ¬ä¸­å¯ä»¥çœ‹åˆ°<code>LC_DYLD_CHAINED_FIXUPS</code>æ—©å°±é¢„åŸ‹åœ¨dyldä¸­äº†ï¼Œåªä¸è¿‡åœ¨<code>iOS Deployment Target == 15</code>æ—¶å¼•èµ·Mach-Oæ–‡ä»¶å˜åŒ–åï¼Œæ‰èƒ½è¿›å…¥ç›¸åº”çš„ä»£ç åˆ†æ”¯ã€‚</p><h3 id="iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ"><a href="#iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ" class="headerlink" title="iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ"></a>iOS15ä¸Šå¦‚ä½•è®©ä½ çš„åº”ç”¨å¯åŠ¨æ›´å¿«ï¼Ÿ</h3><p>åœ¨iOS 15ä¸­ï¼ŒåŸæœ¬ç”¨äºrebase &amp; bind çš„å‹ç¼©å­—èŠ‚æµè¢«æ›¿æ¢ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯fixup-chains(é“¾è¡¨ç»“æ„)ã€‚åœ¨iOS å¯åŠ¨æ—¶ï¼Œdyld å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨fixup-chainsï¼Œå¦‚æœå­˜åœ¨fixup-chains åˆ™æŒ‰ç…§fixup-chainsçš„æ–¹å¼è¿›è¡Œè§£æï¼Œå¦åˆ™è¿˜æ˜¯æŒ‰ç…§å‹ç¼©å­—èŠ‚æµçš„æ–¹å¼è§£æã€‚è§£æçš„ç›®çš„æ˜¯ä¸ºäº†å°†åº”ç”¨ç¨‹åºçš„åœ°å€è¿›è¡Œä¿®æ­£ã€‚fixup-chains æœºåˆ¶æ˜¯ç”±ä¸‰å±‚ç»“æ„è¿›è¡Œå­˜å‚¨ï¼Œåˆ†åˆ«æ˜¯segmentï¼ˆæ®µï¼‰-&gt; pages(é¡µ) -&gt; fixup-chains(æŒ‡é’ˆé“¾è¡¨) ç»„æˆã€‚LC_DYLD_CHAINED_FIXUPSæ‰€æŒ‡å‘çš„æ•°æ®ä¼šå‘Šè¯‰æˆ‘ä»¬æœ‰å¤šå°‘segmentsï¼Œæ¯ä¸ªsegmentçš„ä¿¡æ¯åˆä¼šå‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªsegmentæœ‰å¤šå°‘pagesï¼Œä»¥åŠæ¯ä¸ªpage çš„fixup-chainsåœ¨å“ªé‡Œã€‚ è€Œ fixup-chainsä¸­çš„æŒ‡é’ˆæŒ‡å‘äº†å½“å‰pageä¸­æ¯ä¸€ä¸ªéœ€è¦rebase æˆ–è€… bindçš„åœ°å€ï¼Œè¿™äº›åœ°å€ä¸­å­˜å‚¨çš„æ•°æ®å¹¶éåƒiOS 15ä¹‹å‰é‚£æ ·éƒ½æ˜¯0x00ï¼Œè€Œæ˜¯æœ‰ä¸€å®šæ ¼å¼çš„å…·æœ‰ä¸€å®šæ„ä¹‰çš„8å­—èŠ‚æ•°æ®ã€‚è€Œè¿™çŸ­çŸ­çš„8å­—èŠ‚æ•°æ®è¢«æŒ‰ç…§ä¸åŒçš„ç»“æ„ä½“æ‹†åˆ†æˆå¤šä¸ªbitï¼Œæ¯ä¸ªæˆ–è¿ç»­å‡ ä¸ªbitéƒ½å…·æœ‰å…¶ç‰¹æ®Šçš„å«ä¹‰ç”¨äºæ¨æ–­rebase æˆ– bind æ‰€éœ€è¦çš„ä¸€åˆ‡ä¿¡æ¯ã€‚iOS 15åºŸé™¤äº†lazy_bind(weak_bindä»ç„¶ä¿ç•™)ï¼Œç”±äºrebaseå’Œbind è¢«æ•´åˆä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œå› æ­¤éå†ä¸€æ¬¡é“¾è¡¨å³å¯å®Œæˆä¸€ä¸ªpageæ‰€éœ€çš„rebaseå’Œbindã€‚</p><p><strong>é‚£fixup-chainsä¸ºä»€ä¹ˆèƒ½åŠ å¿«å¯åŠ¨å‘¢ï¼Ÿ</strong></p><p>å› ä¸ºåœ¨iOS 15ä»¥å‰ï¼Œrebaseå’Œbindçš„ä¿¡æ¯åœ¨å‹ç¼©å­—èŠ‚æµä¸­æ˜¯åˆ†åˆ«å­˜å‚¨çš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨å¯åŠ¨æ—¶dyldåœ¨åšrebaseæ—¶ä¼šå…ˆéå†ä¸€érebaseå‹ç¼©å­—èŠ‚æµæ‰€è®°å½•çš„åœ°å€è¿›è¡Œåœ°å€ä¿®æ”¹ï¼Œå‡è®¾ä¸ºNæ¬¡page faultï¼Œç”±äºç»è¿‡rebase çš„page æ˜¯è¢«å†™å…¥æ•°æ®çš„dirty pageï¼Œå› æ­¤ä¸ä¼šè¢«é‡Šæ”¾ï¼ŒiOS ä¼šé€šè¿‡å‹ç¼©çš„æ–¹å¼ä¼˜åŒ–æœ€è¿‘æ²¡æœ‰ä½¿ç”¨åˆ°çš„dirty pageã€‚ç„¶ååœ¨è¿›è¡Œbindæ—¶ï¼Œåˆéå†bindå‹ç¼©å­—èŠ‚æµæ‰€è®°å½•çš„é‚£äº›åœ°å€è¿›è¡Œä¿®æ”¹ï¼Œå‡è®¾éœ€è¦bind Mä¸ªpageã€‚é‚£ä¹ˆåœ¨Nå’ŒMè¿™ä¸¤ä¸ªPagesé›†åˆä¸­å¯èƒ½å­˜åœ¨å¾ˆå¤šé‡å ï¼Œè¿™å°±é€ æˆäº†äºŒæ¬¡éå†ï¼Œå¹¶ä¸”iOSå¯èƒ½å¯¹å…¶ä¸­æŸäº›dirty pageåšäº†å‹ç¼©ä¼˜åŒ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œbindæ—¶å°±éœ€è¦å¯¹è¿™äº›é‡å çš„pagesåšè§£å‹æ“ä½œã€‚è€Œfixup-chainså¾ˆå·§å¦™åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåŒä¸€ä¸ªpageçš„rebaseå’Œbindæ•´åˆæˆä¸€ä¸ªé“¾è¡¨ï¼ŒåŒæ—¶è¿›è¡Œè¿™ä¸¤ç§æ“ä½œï¼Œè¿™æ ·å°±ä¸ä¼šå­˜åœ¨é‡å¤éå†ç›¸åŒçš„pageï¼Œä¹Ÿä¸ä¼šå­˜åœ¨è§£å‹çš„é—®é¢˜ã€‚</p><p><strong>ç–‘é—®</strong></p><p>fixup-chains ä¼šå‡å°‘page falutæ¬¡æ•°å—ï¼Ÿï¼šä¸ä¼šï¼Œä¾æ—§æ˜¯<code>M</code> âˆª<code>N</code></p><p>æœ‰äººé—®è¿™ä¸ªç®—ä¸ç®—iOS å¸®æˆ‘ä»¬åšäº†äºŒè¿›åˆ¶é‡æ’ï¼Ÿï¼šå®Œå…¨æ˜¯ä¸¤å›äº‹ã€‚è™½ç„¶éƒ½æåˆ°äº†page faultï¼Œä½†æ˜¯é˜¶æ®µæ˜¯ä¸åŒçš„ã€‚</p><p><a href="https://easeapi.com/blog/blog/83-ios13-dyld3.html" title="iOS 13ä¸­dyld 3çš„æ”¹è¿›å’Œä¼˜åŒ–">iOS 13ä¸­dyld 3çš„æ”¹è¿›å’Œä¼˜åŒ–</a></p><p><a href="https://www.yotrolz.com/posts/c2aae680/" title="iOS dyld å‰ä¸–ä»Šç”Ÿ">iOS dyld å‰ä¸–ä»Šç”Ÿ</a></p><p><a href="https://www.jianshu.com/p/6ff72443377b">ä»é‡æŒ‡é’ˆæ¢æµ‹åˆ°å¯¹iOS 15 bind çš„æ¢ç´¢</a></p>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Swift-weakçš„å®ç°</title>
    <link href="/2021/09/01/Swift-weak%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2021/09/01/Swift-weak%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>åœ¨Swiftä¸­, <code>SideTable</code> æ˜¯é’ˆå¯¹æœ‰éœ€è¦çš„å¯¹è±¡è€Œåˆ›å»ºï¼Œç³»ç»Ÿä¼šä¸ºç›®æ ‡å¯¹è±¡åˆ†é…ä¸€å—æ–°çš„å†…å­˜æ¥ä¿å­˜è¯¥å¯¹è±¡é¢å¤–çš„ä¿¡æ¯ã€‚ å› ä¸ºè¿™ä¸æ˜¯å¯¹è±¡å¿…é¡»çš„å†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ª <code>SideTable</code> å¯æœ‰å¯æ— ã€‚å¯¹è±¡ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘ <code>SideTable</code> çš„æŒ‡é’ˆï¼ŒåŒæ—¶ <code>SideTable</code> ä¹Ÿæœ‰ä¸€ä¸ªæŒ‡å›åŸå¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨å®ç°ä¸Šä¸ºäº†ä¸é¢å¤–å¤šå ç”¨å†…å­˜ï¼Œç›®å‰åªæœ‰åœ¨åˆ›å»ºå¼±å¼•ç”¨æ—¶ï¼Œä¼šå…ˆæŠŠå¯¹è±¡çš„å¼•ç”¨è®¡æ•°æ”¾åˆ°æ–°åˆ›å»ºçš„ <code>SideTable</code> å»ï¼Œå†æŠŠç©ºå‡ºæ¥çš„ç©ºé—´å­˜æ”¾ <code>SideTable</code> çš„åœ°å€ï¼Œä¼šé€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½æ¥åŒºåˆ†å¯¹è±¡æ˜¯å¦æœ‰ <code>SideTable</code>ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JYObject</span>&#123;<br>    <span class="hljs-keyword">var</span> age :<span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">18</span><br>    <span class="hljs-keyword">var</span> name:<span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;JY&quot;</span><br>&#125;<br> <br>  <span class="hljs-keyword">var</span> t <span class="hljs-operator">=</span> <span class="hljs-type">JYObject</span>()<br>    <br>  <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> t2 <span class="hljs-operator">=</span> t<br>    <br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;----&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨<code>print</code>å¤„æ‰“ä¸Šæ–­ç‚¹ï¼ŒæŸ¥çœ‹t2å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C">(lldb) po t2<br>â–¿ Optional&lt;JYObject&gt;<br>  â–¿ some : &lt;JYObject: <span class="hljs-number">0x6000001a9710</span>&gt;<br><br>(lldb) x/<span class="hljs-number">8</span>gx  <span class="hljs-number">0x6000001a9710</span><br><span class="hljs-number">0x6000001a9710</span>: <span class="hljs-number">0x0000000100491e18</span> <span class="hljs-number">0xc0000c00001f03dc</span><br><span class="hljs-number">0x6000001a9720</span>: <span class="hljs-number">0x0000000000000012</span> <span class="hljs-number">0x000000000000594a</span><br><span class="hljs-number">0x6000001a9730</span>: <span class="hljs-number">0xe200000000000000</span> <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6000001a9740</span>: <span class="hljs-number">0x00007efd22b59740</span> <span class="hljs-number">0x000000000000009c</span><br>(lldb) <br></code></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹æ±‡ç¼–ï¼Œå®šä¹‰äº†ä¸€ä¸ª<code>weak</code>å˜é‡ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨äº†<code>swift_weakInit</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”±<code>WeakReference</code>è°ƒç”¨çš„ã€‚è¯´æ˜<code>weak</code>å­—æ®µåœ¨ç¼–è¯‘å™¨å£°æ˜çš„è¿‡ç¨‹å½“ä¸­è‡ªåŠ¨ç”Ÿæˆäº†<code>WeakReference</code>å¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">WeakReference *<span class="hljs-title">swift::swift_weakInit</span><span class="hljs-params">(WeakReference *ref, HeapObject *value)</span> </span>&#123;<br>  ref-&gt;<span class="hljs-built_in">nativeInit</span>(value);<br>  <span class="hljs-keyword">return</span> ref;<br>&#125;<br><br> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">nativeInit</span><span class="hljs-params">(HeapObject *object)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> side = object ? object-&gt;refCounts.formWeakReference() : <span class="hljs-literal">nullptr</span>;<br>    nativeValue.<span class="hljs-built_in">store</span>(<span class="hljs-built_in">WeakReferenceBits</span>(side), std::memory_order_relaxed);<br>  &#125;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br>HeapObjectSideTableEntry* RefCounts&lt;InlineRefCountBits&gt;::formWeakReference()<br>&#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª Side Table</span><br>  <span class="hljs-keyword">auto</span> side = <span class="hljs-built_in">allocateSideTable</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">if</span> (side)<br>      <span class="hljs-comment">// å¢åŠ ä¸€ä¸ªå¼±å¼•ç”¨</span><br>    <span class="hljs-keyword">return</span> side-&gt;<span class="hljs-built_in">incrementWeak</span>();<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p> æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>allocateSideTable</code>æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ª<code>Side Table</code>çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">template</span> &lt;&gt;<br>HeapObjectSideTableEntry* RefCounts&lt;InlineRefCountBits&gt;::<span class="hljs-built_in">allocateSideTable</span>(<span class="hljs-type">bool</span> failIfDeiniting)<br>&#123;<br>  <span class="hljs-comment">//1.æ‹¿åˆ°åŸæœ‰çš„å¼•ç”¨è®¡æ•°</span><br>  <span class="hljs-keyword">auto</span> oldbits = refCounts.<span class="hljs-built_in">load</span>(SWIFT_MEMORY_ORDER_CONSUME);<br>  <br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰SideTableï¼Œ</span><br>  <span class="hljs-keyword">if</span> (oldbits.<span class="hljs-built_in">hasSideTable</span>()) &#123;<br>    <span class="hljs-comment">// Already have a side table. Return it.</span><br>    <span class="hljs-keyword">return</span> oldbits.<span class="hljs-built_in">getSideTable</span>();<br>  &#125; <br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (failIfDeiniting &amp;&amp; oldbits.<span class="hljs-built_in">getIsDeiniting</span>()) &#123;<br>    <span class="hljs-comment">// Already past the start of deinit. Do nothing.</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Preflight passed. Allocate a side table.</span><br>  <br>  <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> custom side table allocator</span><br> <br>  <span class="hljs-comment">//2.é€šè¿‡HeapObjectåˆ›å»ºäº†ä¸€ä¸ªHeapObjectSideTableEntryå®ä¾‹å¯¹è±¡</span><br>  HeapObjectSideTableEntry *side = <span class="hljs-keyword">new</span> <span class="hljs-built_in">HeapObjectSideTableEntry</span>(<span class="hljs-built_in">getHeapObject</span>());<br> <br>  <span class="hljs-comment">//3.å°†åˆ›å»ºçš„å®ä¾‹å¯¹è±¡åœ°å€ç»™äº†InlineRefCountBitsï¼Œä¹Ÿå°±æ˜¯ RefCountBitsT</span><br>  <span class="hljs-keyword">auto</span> newbits = <span class="hljs-built_in">InlineRefCountBits</span>(side);<br>  <br>  <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">if</span> (oldbits.<span class="hljs-built_in">hasSideTable</span>()) &#123;<br>      <span class="hljs-comment">// Already have a side table. Return it and delete ours.</span><br>      <span class="hljs-comment">// Read before delete to streamline barriers.</span><br>      <span class="hljs-keyword">auto</span> result = oldbits.<span class="hljs-built_in">getSideTable</span>();<br>      <span class="hljs-keyword">delete</span> side;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (failIfDeiniting &amp;&amp; oldbits.<span class="hljs-built_in">getIsDeiniting</span>()) &#123;<br>      <span class="hljs-comment">// Already past the start of deinit. Do nothing.</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>     <br>    <span class="hljs-comment">// å°†åŸæœ‰çš„å¼•ç”¨è®¡æ•°å­˜å‚¨</span><br>    side-&gt;<span class="hljs-built_in">initRefCounts</span>(oldbits);<br>     <br>  &#125; <span class="hljs-keyword">while</span> (! refCounts.<span class="hljs-built_in">compare_exchange_weak</span>(oldbits, newbits,<br>                                             std::memory_order_release,<br>                                             std::memory_order_relaxed));<br>  <span class="hljs-keyword">return</span> side;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢æ‰€åšçš„äº‹æƒ…</p><p>1.æ‹¿åˆ°åŸæœ‰çš„å¼•ç”¨è®¡æ•°<br>2.é€šè¿‡HeapObjectåˆ›å»ºäº†ä¸€ä¸ªHeapObjectSideTableEntryå®ä¾‹å¯¹è±¡<br>3.å°†åˆ›å»ºçš„å®ä¾‹å¯¹è±¡åœ°å€ç»™äº†<code>InlineRefCountBits</code>ï¼Œä¹Ÿå°±æ˜¯ RefCountBitsTã€‚</p></blockquote><p>æ„é€ å®Œ <code>Side Table</code> ä»¥åï¼Œå¯¹è±¡ä¸­çš„ <code>RefCountBitsT</code> å°±ä¸æ˜¯åŸæ¥çš„å¼•ç”¨è®¡æ•°äº†ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒ‡å‘ <code>Side Table</code> çš„æŒ‡é’ˆï¼Œç„¶è€Œç”±äºå®ƒä»¬å®é™…éƒ½æ˜¯ <code>uint64_t</code>ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥åŒºåˆ†ã€‚åŒºåˆ†çš„æ–¹æ³•æˆ‘ä»¬å¯ä»¥æ¥çœ‹ <code>InlineRefCountBits</code> çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//å¼±å¼•ç”¨</span><br><span class="hljs-function">LLVM_ATTRIBUTE_ALWAYS_INLINE</span><br><span class="hljs-function">  <span class="hljs-title">RefCountBitsT</span><span class="hljs-params">(HeapObjectSideTableEntry* side)</span></span><br><span class="hljs-function">    : bits((reinterpret_cast&lt;BitsType&gt;(side) &gt;&gt; Offsets::SideTableUnusedLowBits)</span><br><span class="hljs-function">           | (BitsType(<span class="hljs-number">1</span>) &lt;&lt; Offsets::UseSlowRCShift)</span><br><span class="hljs-function">           | (BitsType(<span class="hljs-number">1</span>) &lt;&lt; Offsets::SideTableMarkShift))</span><br><span class="hljs-function">  &#123;</span><br>    <span class="hljs-built_in">assert</span>(refcountIsInline);<br>  &#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨å¼±å¼•ç”¨æ–¹æ³•ä¸­æŠŠåˆ›å»ºå‡ºæ¥çš„åœ°å€åšäº†åç§»æ“ä½œç„¶åå­˜æ”¾åˆ°äº†å†…å­˜å½“ä¸­ã€‚</p><p><code>SideTableUnusedLowBits</code> &#x3D; 3ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼ è¿›æ¥çš„<code>side</code>å¾€å³ç§»äº† 3 ä½ï¼Œä¸‹é¢çš„ä¸¤ä¸ªæ˜¯ 62 ä½å’Œ 63 ä½æ ‡è®°æˆ 1</p></blockquote><p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸€ä¸‹ <code>HeapObjectSideTableEntry</code> çš„ç»“æ„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HeapObjectSideTableEntry</span> &#123;<br>  <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> does object need to be atomic?</span><br>  std::atomic&lt;HeapObject*&gt; object;<br>  SideTableRefCounts refCounts;<br><br>  <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">HeapObjectSideTableEntry</span>(HeapObject *newObject)<br>    : <span class="hljs-built_in">object</span>(newObject), <span class="hljs-built_in">refCounts</span>()<br>  &#123; &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥å°è¯•è¿˜åŸä¸€ä¸‹ æ‹¿åˆ°å¼±å¼•ç”¨è®¡æ•° </p><p><code>0xc0000c00001f03dc</code>62ä½å’Œ63ä½æ¸…0å¾—åˆ° <code>HeapObjectSideTableEntry</code> å®ä¾‹å¯¹è±¡çš„åœ°å€<code>0xC00001F03DC</code></p><p>å®ƒæ—¢ç„¶æ˜¯å³ç§» 3 ä½ï¼Œé‚£ä¹ˆæˆ‘å·¦ç§» 3 ä½æŠŠå®ƒè¿˜åŸï¼Œ<code>HeapObjectSideTableEntry</code>å·¦ç§»ä¸‰ä½ å¾—åˆ°<code>0x10062AFE0</code></p><p><img src="https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/20220302155825.png"></p><ul><li><code>0x6000001a9710</code> å°±æ˜¯å®ä¾‹å¯¹è±¡çš„åœ°å€ã€‚</li><li><code>0x0000000000000002</code>å°±æ˜¯å¼±å¼•ç”¨è®¡æ•°ã€‚<br>è¿™é‡Œå¼±å¼•ç”¨ä¸º<code>2</code>çš„åŸå› æ˜¯å› ä¸º<code>SideTableRefCountBits</code>åˆå§‹åŒ–çš„æ—¶å€™ä»<code>1</code>å¼€å§‹.</li></ul><p> <code>Side Table</code>çš„ç”Ÿå‘½å‘¨æœŸä¸å¯¹è±¡æ˜¯åˆ†ç¦»çš„ï¼Œå½“å¼ºå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œåªæœ‰ <code>HeapObject</code> è¢«é‡Šæ”¾äº†ï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾<code>Side Table</code>ï¼Œåªæœ‰æ‰€æœ‰çš„ <code>weak</code> å¼•ç”¨è€…éƒ½è¢«é‡Šæ”¾äº†æˆ–ç›¸å…³å˜é‡è¢«ç½® <code>nil</code> åï¼Œ<code>Side Table</code> æ‰èƒ½å¾—ä»¥é‡Šæ”¾</p>]]></content>
    
    
    <categories>
      
      <category>Swift</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†</title>
    <link href="/2021/08/02/iOS-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86/"/>
    <url>/2021/08/02/iOS-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†"><a href="#iOS-ç¼–è¯‘è¿‡ç¨‹æ¢³ç†" class="headerlink" title="iOS ç¼–è¯‘è¿‡ç¨‹æ¢³ç†"></a>iOS ç¼–è¯‘è¿‡ç¨‹æ¢³ç†</h1><p>ç¼–è¯‘è¯­è¨€åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¿…é¡»å…ˆé€šè¿‡ç¼–è¯‘å™¨ç”Ÿæˆæœºå™¨ç ï¼Œæœºå™¨ç å¯ä»¥ç›´æ¥åœ¨ CPU ä¸Šæ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡å¾ˆé«˜ã€‚</p><h2 id="ç¼–è¯‘å™¨çš„æ¦‚è¿°"><a href="#ç¼–è¯‘å™¨çš„æ¦‚è¿°" class="headerlink" title="ç¼–è¯‘å™¨çš„æ¦‚è¿°"></a>ç¼–è¯‘å™¨çš„æ¦‚è¿°</h2><p>ç¼–è¯‘å™¨çš„ä½œç”¨æ˜¯æŠŠæˆ‘ä»¬çš„é«˜çº§è¯­è¨€è½¬æ¢æˆæœºå™¨å¯ä»¥è¯†åˆ«çš„æœºå™¨ç ï¼Œç»å…¸çš„è®¾è®¡ç»“æ„å¦‚ä¸‹ï¼š</p><p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1dwrp77ruj20ki03z0sn.jpg"></p><ul><li>å‰ç«¯ï¼ˆFrontendï¼‰ï¼šè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æå’Œç”Ÿæˆä¸­é—´ä»£ç ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šå¯¹ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå‘ç°å‡ºé”™çš„æˆ–éœ€è¦è­¦å‘Šçš„ä¼šæ ‡æ³¨å‡ºæ¥ã€‚</li><li>ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ï¼šä¼šè¿›è¡Œ BitCode çš„ç”Ÿæˆï¼Œé“¾æ¥æœŸä¼˜åŒ–ç­‰å·¥ä½œã€‚</li><li>åç«¯ï¼ˆBackendï¼‰ï¼šé’ˆå¯¹ä¸åŒçš„æ¶æ„ï¼Œç”Ÿæˆå¯¹åº”çš„æœºå™¨ç ã€‚</li></ul><h2 id="Clang-LLVM-çš„ç¼–è¯‘è¿‡ç¨‹"><a href="#Clang-LLVM-çš„ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="Clang + LLVM çš„ç¼–è¯‘è¿‡ç¨‹"></a>Clang + LLVM çš„ç¼–è¯‘è¿‡ç¨‹</h2><ol><li><strong>é¢„å¤„ç†é˜¶æ®µ</strong>ï¼šimport å¤´æ–‡ä»¶æ›¿æ¢ï¼›macro å®å±•å¼€ï¼›å¤„ç†é¢„ç¼–è¯‘æŒ‡ä»¤</li><li><strong>è¯æ³•åˆ†æ</strong>ï¼šé¢„å¤„ç†å®Œæˆåè¿›å…¥è¯æ³•åˆ†æï¼Œå°†è¾“å…¥çš„ä»£ç è½¬åŒ–ä¸ºä¸€ç³»åˆ—ç¬¦åˆç‰¹å®šè¯­è¨€çš„è¯æ³•å•å…ƒï¼ˆtoken æµï¼‰ã€‚</li><li><strong>è¯­æ³•åˆ†æ</strong>ï¼šå°†è¯æ³•åˆ†æå¾—åˆ°çš„ token æµè¿›è¡Œè¯­æ³•é™æ€åˆ†æï¼ˆStatic Analysisï¼‰ï¼Œè¾“å‡º<strong>æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰</strong>ï¼Œè¿‡ç¨‹ä¸­ä¼šæ ¡éªŒè¯­æ³•æ˜¯å¦é”™è¯¯ã€‚</li><li><strong>CodeGen ç”Ÿæˆ IR ä¸­é—´ä»£ç </strong>ï¼šCodeGen è´Ÿè´£å°†è¯­æ³•æ ‘è‡ªé¡¶å‘ä¸‹éå†ç¿»è¯‘æˆ <code>LLVM IR</code>ï¼Œ<code>IR</code> æ˜¯ç¼–è¯‘è¿‡ç¨‹ä¸­å‰ç«¯çš„è¾“å‡ºåç«¯çš„è¾“å…¥ã€‚</li><li><strong>Optimize ä¼˜åŒ– IR</strong>ï¼šåˆ°è¿™é‡Œ LLVM ä¼šåšä¸€äº›ä¼˜åŒ–å·¥ä½œï¼Œåœ¨ Xcode çš„ç¼–è¯‘è®¾ç½®é‡Œå¯ä»¥è®¾ç½®ä¼˜åŒ–çº§åˆ« -01, -03, -0sï¼Œä¹Ÿå¯ä»¥å†™è‡ªå·±çš„ Passï¼ŒPass æ˜¯ LLVM ä¼˜åŒ–å·¥ä½œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹åšäº›äº‹ï¼Œä¸€èµ·åŠ èµ·æ¥å°±æ„æˆäº† LLVM å®Œæ•´çš„ä¼˜åŒ–å’Œè½¬åŒ–ã€‚é™„ä»¶ï¼š<a href="http://llvm.org/docs/WritingAnLLVMPass.html">å®˜æ–¹ Pass æ•™ç¨‹</a>ã€‚</li><li><strong>LLVM Bitcode ç”Ÿæˆå­—èŠ‚ç </strong>ï¼šå¦‚æœå¼€å¯äº† bitcodeï¼Œè‹¹æœä¼šåšè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚è‹¥æœ‰æ–°çš„åç«¯æ¶æ„ï¼Œä¾æ—§å¯ä»¥ç”¨è¿™ä»½ä¼˜åŒ–è¿‡çš„ bitcode å»ç”Ÿæˆã€‚</li><li><strong>ç”Ÿæˆæ±‡ç¼–</strong></li><li><strong>ç”Ÿæˆç›®æ ‡æ–‡ä»¶</strong></li><li><strong>ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</strong></li></ol><h2 id="Xcode-Build-çš„æµç¨‹"><a href="#Xcode-Build-çš„æµç¨‹" class="headerlink" title="Xcode Build çš„æµç¨‹"></a>Xcode Build çš„æµç¨‹</h2><p>æˆ‘ä»¬åœ¨ Xcode ä¸­ä½¿ç”¨ <strong>Command + B</strong> æˆ– <strong>Command + R</strong> æ—¶ï¼Œå³å®Œæˆäº†ä¸€æ¬¡ç¼–è¯‘ï¼Œæ¥çœ‹ä¸‹è¿™ä¸ªè¿‡ç¨‹åšäº†å“ªäº›äº‹æƒ…ã€‚</p><p>ç¼–è¯‘è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p><ul><li>é¢„ç¼–è¯‘ï¼ˆPre-processï¼‰ï¼šå®æ›¿æ¢ã€åˆ é™¤æ³¨é‡Šã€å±•å¼€å¤´æ–‡ä»¶ï¼Œäº§ç”Ÿ .i æ–‡ä»¶ã€‚</li><li>ç¼–è¯‘ï¼ˆComplilingï¼‰ï¼šæŠŠå‰é¢ç”Ÿæˆçš„ .i æ–‡ä»¶è½¬åŒ–ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œäº§ç”Ÿ .s æ–‡ä»¶ã€‚</li><li>æ±‡ç¼–ï¼ˆAsemblyï¼‰ï¼šæŠŠæ±‡ç¼–è¯­è¨€ .s æ–‡ä»¶è½¬åŒ–ä¸ºæœºå™¨ç æ–‡ä»¶ï¼Œäº§ç”Ÿ .0 æ–‡ä»¶ã€‚</li><li>é“¾æ¥ï¼ˆLinkï¼‰ï¼šå¯¹ .o æ–‡ä»¶ä¸­çš„å¯¹äºå…¶ä»–åº“çš„å¼•ç”¨çš„åœ°æ–¹è¿›è¡Œå¼•ç”¨ï¼Œç”Ÿæˆæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¹ŸåŒ…æ‹¬å¤šä¸ª .o æ–‡ä»¶è¿›è¡Œ linkã€‚</li></ul><p>é€šè¿‡è§£æ Xcode ç¼–è¯‘ logï¼Œå¯ä»¥å‘ç° Xcode æ˜¯æ ¹æ® Target è¿›è¡Œç¼–è¯‘çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Xcode ä¸­çš„ Build Phasesã€Build Settings åŠ Build Rules æ¥æ§åˆ¶ç¼–è¯‘è¿‡ç¨‹ã€‚</p><ul><li>Build Settingsï¼šè¿™ä¸€æ ä¸‹æ˜¯å¯¹ç¼–è¯‘çš„ç»†èŠ‚è¿›è¡Œè®¾å®šï¼ŒåŒ…å« build è¿‡ç¨‹çš„æ¯ä¸ªé˜¶æ®µçš„è®¾ç½®é€‰é¡¹ï¼ˆåŒ…å«ç¼–è¯‘ã€é“¾æ¥ã€ä»£ç ç­¾åã€æ‰“åŒ…ï¼‰ã€‚</li><li>Build Phasesï¼šç”¨äºæ§åˆ¶ä»æºæ–‡ä»¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¦‚ç¼–è¯‘å“ªäº›æ–‡ä»¶ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­æ‰§è¡Œå“ªäº›è‡ªå®šä¹‰è„šæœ¬ã€‚ä¾‹å¦‚ CocoaPods åœ¨è¿™é‡Œä¼šè¿›è¡Œç›¸å…³é…ç½®ã€‚</li><li>Build Rulesï¼šæŒ‡å®šäº†ä¸åŒçš„æ–‡ä»¶ç±»å‹è¯¥å¦‚ä½•ç¼–è¯‘ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹è¿™é‡Œçš„å†…å®¹ã€‚å¦‚æœéœ€è¦å¯¹ç‰¹å®šç±»å‹çš„æ–‡ä»¶æ·»åŠ å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§„åˆ™ã€‚</li></ul><p>æ¯ä¸ª Target çš„å…·ä½“ç¼–è¯‘è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡ log æ—¥å¿—è·å¾—ã€‚å¤§è‡´è¿‡ç¨‹ä¸ºï¼š</p><ul><li>ç¼–è¯‘ä¿¡æ¯å†™å…¥è¾…åŠ©æ–‡ä»¶ï¼ˆå¦‚Entitlements.plistï¼‰ï¼Œåˆ›å»ºç¼–è¯‘åçš„æ–‡ä»¶æ¶æ„</li><li>å†™å…¥è¾…åŠ©ä¿¡æ¯ï¼ˆ.hmap æ–‡ä»¶ï¼‰ã€‚å°†é¡¹ç›®çš„æ–‡ä»¶ç»“æ„å¯¹åº”è¡¨ã€å°†è¦æ‰§è¡Œçš„è„šæœ¬ã€é¡¹ç›®ä¾èµ–åº“çš„æ–‡ä»¶ç»“æ„å¯¹åº”è¡¨å†™æˆæ–‡ä»¶ã€‚</li><li>è¿è¡Œé¢„è®¾çš„è„šæœ¬ã€‚å¦‚ Cocoapods ä¼šåœ¨ Build Phases ä¸­é¢„è®¾ä¸€äº›è„šæœ¬ï¼ˆCheckPods Manifest.lockï¼‰ã€‚</li><li>ç¼–è¯‘ .m æ–‡ä»¶ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ Mach-Oã€‚æ¯æ¬¡è¿›è¡Œäº† LLVM çš„å®Œæ•´æµç¨‹ï¼šå‰ç«¯ï¼ˆè¯æ³•åˆ†æ - è¯­æ³•åˆ†æ - ç”Ÿæˆ IRï¼‰ã€ä¼˜åŒ–å™¨ï¼ˆä¼˜åŒ– IRï¼‰ã€åç«¯ï¼ˆç”Ÿæˆæ±‡ç¼– - ç”Ÿæˆç›®æ ‡æ–‡ä»¶ - ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚ä½¿ç”¨ <code>CompileC</code> å’Œ <code>clang</code> å‘½ä»¤ã€‚ CompileC æ˜¯ xcodebuild å†…éƒ¨å‡½æ•°çš„æ—¥å¿—è®°å½•è¡¨ç¤ºå½¢å¼ï¼Œå®ƒæ˜¯ build.log æ–‡ä»¶ä¸­æœ‰å…³ç¼–è¯‘çš„åŸºæœ¬ä¿¡æ¯æ¥æºã€‚</li><li>é“¾æ¥éœ€è¦çš„åº“ã€‚å¦‚ Foundation.frameworkï¼ŒAFNetworking.frameworkâ€¦</li><li>æ‹·è´èµ„æºæ–‡ä»¶åˆ°ç›®æ ‡åŒ…</li><li>ç¼–è¯‘ storyboard æ–‡ä»¶</li><li>é“¾æ¥ storyboard æ–‡ä»¶</li><li>ç¼–è¯‘ Asset æ–‡ä»¶ã€‚å¦‚æœä½¿ç”¨ Asset.xcassets æ¥ç®¡ç†å›¾ç‰‡ï¼Œè¿™äº›å›¾ç‰‡ä¼šè¢«ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œé™¤äº† icon å’Œ launchIamgeã€‚</li><li>å¤„ç† infoplist</li><li>æ‰§è¡Œ CocoaPods è„šæœ¬ï¼Œå°†åœ¨ç¼–è¯‘é¡¹ç›®å‰å·²ç¼–è¯‘å¥½çš„ä¾èµ–åº“å’Œç›¸å…³èµ„æºæ‹·è´åˆ°åŒ…ä¸­ã€‚</li><li>æ‹·è´ Swift æ ‡å‡†åº“</li><li>åˆ›å»º .app æ–‡ä»¶å¹¶å¯¹å…¶ç­¾å</li></ul>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-çº¿ç¨‹æ•°é‡ç›‘æ§</title>
    <link href="/2021/07/01/iOS-%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F%E7%9B%91%E6%8E%A7/"/>
    <url>/2021/07/01/iOS-%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F%E7%9B%91%E6%8E%A7/</url>
    
    <content type="html"><![CDATA[<p>åœ¨iOSå¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸å¼€è¾Ÿæ–°çš„çº¿ç¨‹å»åšä¸€äº›äº‹ï¼Œå¦‚ä½•åˆç†çš„å¼€è¾Ÿçº¿ç¨‹ï¼Œåœ¨Appå¼€å‘é˜¶æ®µï¼Œç›‘æ§çº¿ç¨‹çš„å¼€è¾Ÿæ•°é‡ï¼Œé¿å…çº¿ä¸Šå‘ç”Ÿæ„å¤–æƒ…å†µã€‚ </p><p>å½“çº¿ç¨‹è¿‡å¤šæˆ–ç¬é—´åˆ›å»ºå¤§é‡å­çº¿ç¨‹(çº¿ç¨‹çˆ†ç‚¸)ï¼Œå°±åœ¨æ§åˆ¶å°æ‰“å°ä¿¡æ¯ï¼Œå¹¶è®°å½•ä¿¡æ¯ã€‚</p><ol><li><p>åˆ›å»ºå­çº¿ç¨‹è¿‡å¤šï¼Œæ˜¯ä¼šé€ æˆæ€§èƒ½é—®é¢˜çš„ï¼Œå› ä¸ºåˆ›å»ºçº¿ç¨‹éœ€è¦å ç”¨å†…å­˜ç©ºé—´ï¼ˆé»˜è®¤çš„æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹å 1M,å­çº¿ç¨‹å ç”¨512KBï¼‰ã€‚</p></li><li><p>ä¸åˆç†åˆ›å»ºå’Œä½¿ç”¨çº¿ç¨‹ï¼Œå®¹æ˜“å¼•å‘æ•°æ®ä¸€è‡´æ€§ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰å’Œæ­»é”é—®é¢˜ã€‚</p></li></ol><p>å› ä¸ºåœ¨iOSä¸­åŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨çš„<code>p_thread</code>ï¼Œåœ¨<code>Mach</code>å±‚ä¸­<code>thread_basic_info</code> ç»“æ„ä½“å°è£…äº†å•ä¸ªçº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">struct thread_basic_info &#123;<br>    time_value_t  user_time;      /* user run time */<br>    time_value_t  system_time;    /* system run time */<br>    integer_t    cpu_usage;       /* scaled cpu usage percentage */<br>    policy_t     policy;          /* scheduling policy in effect */<br>    integer_t    run_state;       /* run state (see below) */<br>    integer_t    flags;           /* various flags (see below) */<br>    integer_t    suspend_count;   /* suspend count for thread */<br>    integer_t    sleep_time;      /* number of seconds that thread  has been sleeping */<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>Mach Task</code>åŒ…å«å®ƒçš„çº¿ç¨‹åˆ—è¡¨ã€‚å†…æ ¸æä¾›äº†<code>task_threads</code> API è°ƒç”¨è·å–æŒ‡å®š task çš„çº¿ç¨‹åˆ—è¡¨ï¼Œç„¶åå¯ä»¥é€šè¿‡<code>thread_info</code> APIè°ƒç”¨æ¥æŸ¥è¯¢æŒ‡å®šçº¿ç¨‹çš„ä¿¡æ¯ï¼Œåœ¨ thread_act.h ä¸­æœ‰ç›¸å…³å®šä¹‰ã€‚</p><p><code>task_threads</code> å°†<code>target_task</code> ä»»åŠ¡ä¸­çš„æ‰€æœ‰çº¿ç¨‹ä¿å­˜åœ¨<code>act_list</code>æ•°ç»„ä¸­ï¼Œact_listCntè¡¨ç¤ºçº¿ç¨‹ä¸ªæ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">kern_return_t task_threads<br>(<br>    task_t target_task,<br>    thread_act_array_t *act_list,<br>    mach_msg_type_number_t *act_listCnt<br>);<br></code></pre></td></tr></table></figure><p> <code>thread_info</code>ç»“æ„å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">kern_return_t</span> <span class="hljs-title">thread_info</span></span><br><span class="hljs-function"><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_act_t</span> target_act,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_flavor_t</span> flavor,  <span class="hljs-comment">// ä¼ å…¥ä¸åŒçš„å®å®šä¹‰è·å–ä¸åŒçš„çº¿ç¨‹ä¿¡æ¯</span></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">thread_info_t</span> thread_info_out,  <span class="hljs-comment">// æŸ¥è¯¢åˆ°çš„çº¿ç¨‹ä¿¡æ¯</span></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">mach_msg_type_number_t</span> *thread_info_outCnt  <span class="hljs-comment">// ä¿¡æ¯çš„å¤§å°</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br></code></pre></td></tr></table></figure><p> å¦‚æœé¢‘ç¹è°ƒç”¨<code>task_threads</code>å‡½æ•°ï¼Œæ¥è·å–çº¿ç¨‹æ•°é‡å’Œå¢é•¿é€Ÿåº¦ï¼Œå¤§é‡è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šé€ æˆä¸€å®šçš„æ€§èƒ½é—®é¢˜</p><p>é€šè¿‡<code>hook</code>çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæ¥ç›‘å¬çº¿ç¨‹çš„æ•°é‡</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//åœ¨#include &lt;pthread/introspection.h&gt;æ–‡ä»¶é‡Œ</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">å®šä¹‰å‡½æ•°æŒ‡é’ˆï¼špthread_introspection_hook_t</span><br><span class="hljs-comment">event  : çº¿ç¨‹å¤„äºçš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¸‹é¢æšä¸¾äº†çº¿ç¨‹çš„4ä¸ªç”Ÿå‘½å‘¨æœŸï¼‰</span><br><span class="hljs-comment">thread ï¼šçº¿ç¨‹</span><br><span class="hljs-comment">addr   ï¼šçº¿ç¨‹æ ˆå†…å­˜åŸºå€</span><br><span class="hljs-comment">size   ï¼šçº¿ç¨‹æ ˆå†…å­˜å¯ç”¨å¤§å°</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*<span class="hljs-type">pthread_introspection_hook_t</span>)</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> event,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> size)</span></span>;<br><br><span class="hljs-keyword">enum</span> &#123;<br>PTHREAD_INTROSPECTION_THREAD_CREATE = <span class="hljs-number">1</span>, <span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹</span><br>PTHREAD_INTROSPECTION_THREAD_START, <span class="hljs-comment">// çº¿ç¨‹å¼€å§‹è¿è¡Œ</span><br>PTHREAD_INTROSPECTION_THREAD_TERMINATE,  <span class="hljs-comment">//çº¿ç¨‹è¿è¡Œç»ˆæ­¢</span><br>PTHREAD_INTROSPECTION_THREAD_DESTROY, <span class="hljs-comment">//é”€æ¯çº¿ç¨‹</span><br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">çœ‹è¿™ä¸ªå‡½æ•°åï¼Œå¾ˆåƒæˆ‘ä»¬å¹³æ—¶hookå‡½æ•°ä¸€æ ·çš„ã€‚</span><br><span class="hljs-comment">è¿”å›å€¼æ˜¯ä¸Šé¢å£°æ˜çš„pthread_introspection_hook_tå‡½æ•°æŒ‡é’ˆï¼šè¿”å›åŸçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚</span><br><span class="hljs-comment">å‚æ•°ä¹Ÿæ˜¯å‡½æ•°æŒ‡é’ˆï¼šä¼ å…¥çš„æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span><br><span class="hljs-comment">*/</span><br>__attribute__((__nonnull__, __warn_unused_result__))<br><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-type">pthread_introspection_hook_t</span></span><br><span class="hljs-function"><span class="hljs-title">pthread_introspection_hook_install</span><span class="hljs-params">(<span class="hljs-type">pthread_introspection_hook_t</span> hook)</span></span>;<br><br></code></pre></td></tr></table></figure><h4 id="ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor"><a href="#ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor" class="headerlink" title="ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ªMonitor"></a>ä¸‹é¢å¼€å§‹å†™ä¸€ä¸ª<code>Monitor</code></h4><p>å…ˆæ¥å®šä¹‰ä¸€äº›å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">static pthread_introspection_hook_t original_pthread_introspection_hook_t = NULL;<br><br>/// åˆ›å»ºä¿¡å·é‡<br>static dispatch_semaphore_t semaphore;<br><br>/// çº¿ç¨‹æ€»æ•°<br>static int threadCount = 0;<br><br>/// æ˜¯å¦å¼€å¯ç›‘æ§<br>static bool isMonitor = false;<br><br>/// çº¿ç¨‹æ€»æ•°é˜ˆå€¼<br>static int averageThreadCount = 40;<br><br>/// çº¿ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…æ–°å¢æ•°<br>static int newThreadCount = 0;<br><br>/// çº¿ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…æ–°å¢é˜ˆå€¼<br>static int newAverageThreadCount = 10;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// å¼€å¯ç›‘æ§<br>+ (void)startMonitor&#123;<br>    // åˆ›å»ºä¿¡å·é‡ æœ€å¤§å¹¶å‘æ•°ä¸º1<br>    semaphore = dispatch_semaphore_create(1);<br>    // ç­‰å¾…<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    <br>    mach_msg_type_number_t count;<br>    thread_act_array_t threads;<br>    // è·å–åˆ°count<br>    task_threads(mach_task_self(), &amp;threads, &amp;count);<br>   <br>    // ä¿è¯åŠ é”çš„æ—¶å€™ï¼Œçº¿ç¨‹æ•°é‡ä¸å˜<br>    threadCount = count;<br>    <br>    // æ·»åŠ ğŸªé’©å­å‡½æ•°<br>    original_pthread_introspection_hook_t = pthread_introspection_hook_install(kry_pthread_introspection_hook_t);<br>    <br>    // è§£é” ä¿¡å·é‡+1<br>    dispatch_semaphore_signal(semaphore);<br>    <br>    // å¼€å§‹ç›‘æ§<br>    isMonitor = true;<br>    <br>    <br>    // å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ æ£€æµ‹æ¯ç§’çº¿ç¨‹åˆ›å»º ç„¶åé€šè¿‡clearNewThreadCountç½®ä½0<br>    const char *queenIdentifier = dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL);<br>    if (queenIdentifier == dispatch_queue_get_label(dispatch_get_main_queue())) &#123;<br>        [NSTimer scheduledTimerWithTimeInterval:1.0 target:self selector:@selector(clearNewThreadCount) userInfo:nil repeats:YES];<br>    &#125;else&#123;<br>        dispatch_async(dispatch_get_main_queue(), ^&#123;<br>        [NSTimer scheduledTimerWithTimeInterval:1.0 target:self selector:@selector(clearNewThreadCount) userInfo:nil repeats:YES];<br>        &#125;);<br>    &#125;<br>&#125;<br><br>// å½“å‰çº¿ç¨‹æ€»æ•°<br>+ (int)currentThreadCount&#123;<br>    return threadCount;<br>&#125;<br><br>void kry_pthread_introspection_hook_t(unsigned int event,<br>                                      pthread_t thread, void *addr, size_t size)&#123;<br>    <br>    // æ­£å¸¸è°ƒç”¨åŸæœ‰é€»è¾‘<br>    if (original_pthread_introspection_hook_t) &#123;<br>        original_pthread_introspection_hook_t(event,thread,addr,size);<br>    &#125;<br>    <br>    // å¼€å§‹è®°å½•<br>    <br>    // å¦‚æœæ˜¯åˆ›å»ºçº¿ç¨‹,åˆ™çº¿ç¨‹çš„æ•°é‡+1ï¼Œæ–°å¢æ•°+1<br>    if (event == PTHREAD_INTROSPECTION_THREAD_CREATE) &#123;<br>        threadCount +=1;<br>        if (isMonitor &amp;&amp; threadCount &gt; averageThreadCount) &#123;<br>            // æ€»æ•° è¶…è¿‡é˜ˆå€¼ è­¦å‘Šæˆ–è€…è®°å½•å †æ ˆ<br>            kry_Log_CallStack(false, 0);<br>        &#125;<br>        <br>        newThreadCount +=1;<br>        if (isMonitor &amp;&amp; newThreadCount &gt; newAverageThreadCount) &#123;<br>            // æ–°å¢æ•° è¶…è¿‡é˜ˆå€¼ è­¦å‘Šæˆ–è€…è®°å½•å †æ ˆ<br>            kry_Log_CallStack(true, newThreadCount);<br>        &#125;<br>    &#125;<br>    <br>    <br>    // é”€æ¯çº¿ç¨‹ï¼Œåˆ™çº¿ç¨‹æ•°é‡-1ï¼Œæ–°å¢æ•°-1<br>    if (event == PTHREAD_INTROSPECTION_THREAD_DESTROY) &#123;<br>        threadCount -=1;<br>       <br>        if (newThreadCount &gt; 0 ) &#123;<br>            newThreadCount -=1;<br>        &#125;<br>        <br>    &#125;<br>&#125;<br><br><br>void kry_Log_CallStack(bool isIncreaseLog, int num)<br>&#123;<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    if (isIncreaseLog) &#123;<br>        printf(&quot;\nğŸ”¥ä¸€ç§’é’Ÿå¼€å¯ %d æ¡çº¿ç¨‹ï¼ï¼ï¼ï¼\n&quot;, num);<br>    &#125;<br>    // å¯ä»¥è®°å½•å †æ ˆä¿¡æ¯<br>    dispatch_semaphore_signal(semaphore);<br>&#125;<br><br>+ (void)clearNewThreadCount&#123;<br>    newThreadCount = 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆç®€å•ï¼Œéƒ½æœ‰æ³¨é‡Šï¼Œè¿‘æœŸåœ¨çœ‹PCLçš„å †æ ˆè®°å½•ï¼ŒåæœŸä¼šæŠŠå †æ ˆè®°å½•å®Œå–„ä¸Šå»</p><h3 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h3><p><a href="https://www.jianshu.com/p/95df83780c8f">APPæ€§èƒ½æ£€æµ‹æ–¹æ¡ˆæ±‡æ€»</a></p><p><a href="https://juejin.cn/post/6844904122248855560">iOSçº¿ç¨‹æ•°é‡ç›‘æ§å·¥å…·</a></p>]]></content>
    
    
    <categories>
      
      <category>iOSæºç </category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-è‡ªå®šä¹‰Sectionå»¶è¿ŸloadåŠ è½½</title>
    <link href="/2021/07/01/iOS-%E8%87%AA%E5%AE%9A%E4%B9%89Section%E5%BB%B6%E8%BF%9Fload%E5%8A%A0%E8%BD%BD/"/>
    <url>/2021/07/01/iOS-%E8%87%AA%E5%AE%9A%E4%B9%89Section%E5%BB%B6%E8%BF%9Fload%E5%8A%A0%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<h4 id="åœ¨æŒ‡å®šçš„segmentå’Œsectionä¸­å­˜å…¥æ•°æ®"><a href="#åœ¨æŒ‡å®šçš„segmentå’Œsectionä¸­å­˜å…¥æ•°æ®" class="headerlink" title="åœ¨æŒ‡å®šçš„segmentå’Œsectionä¸­å­˜å…¥æ•°æ®"></a>åœ¨æŒ‡å®šçš„segmentå’Œsectionä¸­å­˜å…¥æ•°æ®</h4><p>ä¹‹å‰æˆ‘ä»¬å·²ç»äº†è§£è¿‡<code>machO</code>çš„ç»“æ„äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•å»ä¿®æ”¹æˆ–è€…æ–°å¢<code>segment</code>å’Œ<code>section</code>å½“ä¸­çš„æ•°æ®å‘¢ï¼Œç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½¿ç”¨<code>__attribute__ section</code>å°†æŒ‡å®šçš„æ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„<code>segmemt</code>å’Œ<code>section</code>ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨é€šè¿‡åœ¨<code>Build Settings</code>ä¸­çš„<code>Other Linker Flags</code>è®¾ç½®é“¾æ¥å‚æ•°ï¼Œä»è€Œè¾¾åˆ°ç§»åŠ¨æ®µï¼Œæ–°å¢æ®µï¼Œèµ‹äºˆæƒé™ç­‰æ“ä½œ</p><h4 id="attribute-çš„ç”¨æ³•"><a href="#attribute-çš„ç”¨æ³•" class="headerlink" title=" __attribute__çš„ç”¨æ³•"></a><code> __attribute__</code>çš„ç”¨æ³•</h4><p><code>__attribute__</code> å¯ä»¥ç”¨æ¥è®¾ç½®å‡½æ•°å±æ€§ï¼ˆFunction Attributeï¼‰ã€å˜é‡å±æ€§ï¼ˆVariable Attributeï¼‰å’Œç±»å‹å±æ€§ï¼ˆType Attributeï¼‰</p><ul><li><code>__attribute__((format()))</code> æŒ‰ç…§æŒ‡å®šæ ¼å¼è¿›è¡Œå‚æ•°æ£€æŸ¥ã€‚</li></ul><hr><ul><li><code>__attribute__((__always_inline__))</code> å¼ºåˆ¶å†…è”ã€‚</li></ul><hr><ul><li><code>__attribute__((deprecated(&quot;Use xxx: instead&quot;)</code> è¿™ä¸ªå¯èƒ½æ˜¯æˆ‘ä»¬è§çš„æ¯”è¾ƒå¤šçš„ï¼Œç”¨æ¥æ ‡è®°æŸä¸ªæ–¹æ³•å·²ç»è¢«åºŸå¼ƒäº†ï¼Œéœ€è¦ç”¨å…¶å®ƒçš„æ–¹æ³•ä»£æ›¿ã€‚</li></ul><hr><ul><li><code>__attribute__((__unused__))</code> æ ‡è®°å‡½æ•°æˆ–å˜é‡å¯èƒ½ä¸ä¼šç”¨åˆ°ã€‚</li></ul><hr><ul><li><p><code>__attribute__((visibility(&quot;visibility_type&quot;)))</code> æ ‡è®°åŠ¨æ€åº“ç¬¦å·æ˜¯å¦å¯è§ï¼Œæœ‰ä»¥ä¸‹å–å€¼ï¼š</p><pre><code class="hljs">   1.  `default` ç¬¦å·å¯è§ï¼Œå¯å¯¼å‡ºã€‚          2.  `hidden` ç¬¦å·éšè—ï¼Œä¸å¯å¯¼å‡ºï¼Œåªèƒ½åœ¨æœ¬åŠ¨æ€åº“å†…è°ƒç”¨ã€‚</code></pre></li></ul><hr><ul><li><code>__attribute__((objc_designated_initializer))</code> æ˜ç¡®æŒ‡å®šç”¨äºåˆå§‹åŒ–çš„æ–¹æ³•ã€‚ä¸€ä¸ªä¼˜ç§€çš„è®¾è®¡ï¼Œåˆå§‹åŒ–æ¥å£å¯ä»¥æœ‰å¤šä¸ªï¼Œä½†æœ€ç»ˆå¤šä¸ªåˆå§‹åŒ–åˆå§‹åŒ–æ¥å£éƒ½ä¼šè°ƒç”¨ <code>designed initializer</code> æ–¹æ³•ã€‚</li></ul><hr><ul><li><code>__attribute__((unavailable))</code>ã€<code>__attribute__((unavailable(&quot;Must use xxx: instead.&quot;)));</code> æ ‡è®°æ–¹æ³•è¢«ç¦ç”¨ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€è¯¥æ–¹æ³•ä¸èƒ½è¢«è°ƒç”¨ï¼Œåœ¨ Objective-C ä¸­ä½¿ç”¨ runtime ä¾ç„¶å¯ä»¥è°ƒç”¨ã€‚</li></ul><hr><ul><li><code>__attribute__((section(&quot;segment,section&quot;)))</code> å°†ä¸€ä¸ªæŒ‡å®šçš„æ•°æ®å‚¨å­˜åˆ°æˆ‘ä»¬éœ€è¦çš„ segment å’Œ section ä¸­ã€‚</li></ul><hr><ul><li><code>__attribute__((constructor))</code> è¢« <code>attribute((constructor))</code> æ ‡è®°çš„å‡½æ•°ï¼Œä¼šåœ¨ <code>main</code> å‡½æ•°ä¹‹å‰æˆ–åŠ¨æ€åº“åŠ è½½æ—¶æ‰§è¡Œã€‚åœ¨ mach-o ä¸­ï¼Œè¢« <code>attribute((constructor))</code> æ ‡è®°çš„å‡½æ•°ä¼šåœ¨ <code>_DATA</code> æ®µçš„ <code>__mod_init_func</code> åŒºä¸­ã€‚å½“å¤šä¸ªè¢«æ ‡è®° <code>attribute((constructor))</code> çš„æ–¹æ³•æƒ³è¦æœ‰é¡ºåºçš„æ‰§è¡Œï¼Œæ€ä¹ˆåŠï¼Ÿ<code>attribute((constructor))</code> æ˜¯æ”¯æŒä¼˜å…ˆçº§çš„ï¼š<code>_attribute((constructor(1)))</code></li></ul><hr><ul><li><code>__attribute__((destructor))</code> å’Œ <code>attribute((constructor))</code> ç›¸åï¼šè¢« <code>attribute((destructor))</code> æ ‡è®°çš„å‡½æ•°ï¼Œä¼šåœ¨ <code>main</code> å‡½æ•°é€€å‡ºæˆ–åŠ¨æ€åº“å¸è½½æ—¶æ‰§è¡Œã€‚åœ¨ mach-o ä¸­æ­¤ç±»å‡½æ•°ä¼šæ”¾åœ¨ <code>_DATA</code> æ®µçš„ <code>__mod_term_func</code> åŒºä¸­</li></ul><p>â€¦ è¿˜æœ‰å¾ˆå¤š è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">JYProtocolInfo</span>&#123;<br>    <span class="hljs-type">char</span> *className;<br>    <span class="hljs-type">char</span> *method;<br>&#125;;<br><br> <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> JYProtocolRegister(_className_,_method_)\</span><br><span class="hljs-meta">__attribute__((used)) static struct JYProtocolInfo JYProtocolInfo##_className_ \</span><br><span class="hljs-meta">__attribute__ ((used, section (<span class="hljs-string">&quot;__DATA,JYLoadDelayData&quot;</span>))) =\</span><br><span class="hljs-meta">&#123;\</span><br><span class="hljs-meta">    .className = #_className_,\</span><br><span class="hljs-meta">    .method = #_method_,\</span><br><span class="hljs-meta">&#125;;</span><br><br><br>@interface JYLoadDelayTool : NSObject<br><br>+ (<span class="hljs-type">void</span>)readDataFromMachO;<br><br>+ (<span class="hljs-type">void</span>)xxx;<br><br>@end<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">JYProtocolRegister</span>(JYLoadDelayTool,xxx)<br><br>+ (<span class="hljs-type">void</span>)xxx&#123;<br>    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;123&quot;</span>);<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)readDataFromMachO &#123;<br>   <br>     Dl_info info;<br>     <span class="hljs-built_in">dladdr</span>((__bridge <span class="hljs-type">void</span> *)[self <span class="hljs-keyword">class</span>], &amp;info);<br><br>    <span class="hljs-comment">// è¯»å–__DATAä¸­è‡ªå®šä¹‰çš„ProtocolInfoDatazæ•°æ®</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __LP64__</span><br>        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">mach_header</span> *mhp = (<span class="hljs-keyword">struct</span> mach_header*)info.dli_fbase;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> schemeSize = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">uint32_t</span> *schemeMemory = (<span class="hljs-type">uint32_t</span>*)<span class="hljs-built_in">getsectiondata</span>(mhp, <span class="hljs-string">&quot;__DATA&quot;</span>, <span class="hljs-string">&quot;JYLoadDelayData&quot;</span>, &amp;schemeSize);<br>    <span class="hljs-meta">#<span class="hljs-keyword">else</span> <span class="hljs-comment">/* defined(__LP64__) */</span></span><br>        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">mach_header_64</span> *mhp = (<span class="hljs-keyword">struct</span> mach_header_64*)info.dli_fbase;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> schemeSize = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">uint64_t</span> *schemeMemory = (<span class="hljs-type">uint64_t</span>*)<span class="hljs-built_in">getsectiondata</span>(mhp, <span class="hljs-string">&quot;__DATA&quot;</span>, <span class="hljs-string">&quot;JYLoadDelayData&quot;</span>, &amp;schemeSize);<br><br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* defined(__LP64__) */</span></span><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> schemeCounter = schemeSize/<span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> JYProtocolInfo);<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JYProtocolInfo</span> *items = (<span class="hljs-keyword">struct</span> JYProtocolInfo*)schemeMemory;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>; idx &lt; schemeCounter; ++idx)&#123;<br>        <br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JYProtocolInfo</span> * info = (<span class="hljs-keyword">struct</span> JYProtocolInfo*)&amp;items[idx];<br>        <br>        Class JYClass = <span class="hljs-built_in">NSClassFromString</span>([NSString stringWithUTF8String:info-&gt;className]);<br><br>        SEL sel = <span class="hljs-built_in">NSSelectorFromString</span>([NSString stringWithUTF8String:info-&gt;method]);<br>        <br>        <span class="hljs-built_in">id</span> (*func)(Class, SEL) = (<span class="hljs-built_in">id</span> (*)(Class, SEL))objc_msgSend;<br>       <br>        <span class="hljs-built_in">func</span>(JYClass, sel);<br>    &#125;<br>&#125;<br> <br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå¯ä»¥æŠŠä¸€äº›<code>+load</code>çš„æ–¹æ³•éƒ½é€šè¿‡æŒ‡å®š<code>JYProtocolRegister</code>æ¥åŠ è½½ï¼Œè¿™æ ·å¯ä»¥ä¼˜åŒ–å¯åŠ¨æ—¶é—´ï¼Œå¦å¤–æˆ‘ä»¬APMçš„ç›‘æ§ï¼Œåº”è¯¥æ˜¯æœ€æ—©çš„ï¼Œè¿™æ ·åœ¨APPå¯åŠ¨åçš„é—®é¢˜éƒ½èƒ½å¤Ÿæ£€æµ‹åˆ°ï¼Œå¦‚æœ<code>load</code>é‡Œé¢çš„æ–¹æ³•æœ‰æ€§èƒ½é—®é¢˜ï¼Œè€ŒAPMç›‘æ§å´æ˜¯åœ¨<code>load</code>ä¹‹åï¼Œé‚£ä¹ˆå°±ä¼šæ£€æŸ¥ä¸åˆ°ï¼Œæ‰€ä»¥ä¸€äº›éå¿…è¦æ€§çš„<code>load</code>æ–¹æ³•å¯ä»¥æ”¾åœ¨APMä¹‹ååŠ è½½ï¼Œé€šè¿‡ä¸Šè¿°æ–¹å¼</p><h4 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h4><p><a href="https://juejin.cn/post/6980545001126101005">iOS APP å¯åŠ¨ä¼˜åŒ–(å…­)ï¼šåœ¨æŒ‡å®šçš„ segment å’Œ section ä¸­å­˜å…¥æ•°æ®</a></p><p><a href="https://xiaozhuanlan.com/topic/9204153876">iOSå¼€å‘ä¹‹runtimeï¼ˆ12ï¼‰ï¼šæ·±å…¥ Mach-O</a></p>]]></content>
    
    
    <categories>
      
      <category>iOSè¿›é˜¶</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-é€†å‘é˜²æŠ¤</title>
    <link href="/2021/06/01/iOS-%E9%80%86%E5%90%91%E9%98%B2%E6%8A%A4/"/>
    <url>/2021/06/01/iOS-%E9%80%86%E5%90%91%E9%98%B2%E6%8A%A4/</url>
    
    <content type="html"><![CDATA[<hr><h3 id="MethodSwizzle"><a href="#MethodSwizzle" class="headerlink" title="**MethodSwizzle **"></a>**MethodSwizzle **</h3><ul><li>åˆ©ç”¨OCçš„è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰ç‰¹æ€§ä¿®æ”¹ <code>SEL</code> å’Œ <code>IMP(å‡½æ•°æŒ‡é’ˆ)</code> çš„å…³ç³»ï¼Œæ‰“åˆ°Hook OCæ–¹æ³•çš„ç›®çš„</li><li><code>method_exchangeIMP</code>äº¤æ¢ä¸¤ä¸ª <code>IMP</code></li><li><code>class_replaceMethod</code>æ›¿æ¢æŸä¸ª <code>SEL</code>çš„ <code>IMP</code> ï¼ˆå¦‚æœæ²¡æœ‰è¯¥æ–¹æ³•å°±æ·»åŠ ï¼Œç›¸å½“äºæ¢æ‰è¿™ä¸ªæ–¹æ³•ï¼‰</li><li><code>method_getImplementation</code> ã€<code>method_setImplementation</code> è·å–å’Œè®¾ç½®æŸä¸ªæ–¹æ³•çš„IMP ï¼ˆå¾ˆå¤šç¬¬ä¸‰æ–¹æ¡†æ¶éƒ½ä½¿ç”¨ï¼‰</li></ul><hr><h3 id="MonKey-Hook"><a href="#MonKey-Hook" class="headerlink" title="MonKey Hook"></a>MonKey Hook</h3><p>Monkeyä¸­ä½¿ç”¨äº†  <code>libsubstrate.dylib</code></p><ul><li><code>method_setImplementation</code></li><li><code>method_getImplementation</code></li></ul><h4 id="MonKeyå·²ç»æ›¿æ¢çš„ç³»ç»Ÿå‡½æ•°"><a href="#MonKeyå·²ç»æ›¿æ¢çš„ç³»ç»Ÿå‡½æ•°" class="headerlink" title="MonKeyå·²ç»æ›¿æ¢çš„ç³»ç»Ÿå‡½æ•°"></a><strong>MonKeyå·²ç»æ›¿æ¢çš„ç³»ç»Ÿå‡½æ•°</strong></h4><ul><li>dlsym </li><li>sysctl</li><li>ptrace</li></ul><hr><h3 id="Dobby-ï¼ˆä¿®æ”¹é™æ€å‡½æ•°-C-å’Œ-swiftï¼‰"><a href="#Dobby-ï¼ˆä¿®æ”¹é™æ€å‡½æ•°-C-å’Œ-swiftï¼‰" class="headerlink" title="Dobby ï¼ˆä¿®æ”¹é™æ€å‡½æ•° C å’Œ swiftï¼‰"></a>Dobby ï¼ˆä¿®æ”¹é™æ€å‡½æ•° C å’Œ swiftï¼‰</h3><ul><li>å®é™…ä¸Šæ˜¯æ›¿æ¢ <code>Textæ®µ</code>   </li><li>åŠ¨æ€ä¿®æ”¹ ï¼ˆåŠ è½½åˆ°å†…å­˜çš„æ—¶å€™ä¿®æ”¹ï¼‰</li></ul><hr><h3 id="é˜²æŠ¤-ï¼šlldb-ptrace"><a href="#é˜²æŠ¤-ï¼šlldb-ptrace" class="headerlink" title="é˜²æŠ¤ ï¼šlldb - ptrace"></a>é˜²æŠ¤ ï¼š<code>lldb - ptrace</code></h3><ul><li><code>ptrace</code> æ˜¯ å‘½ä»¤è¡Œå·¥ç¨‹ä»¥åŠ Mac OS å·¥ç¨‹é‡Œçš„ <code>&lt;sys/ptrace.h&gt;</code>æä¾›çš„ä¸€ä¸ªå‡½æ•° , å¯ä»¥ç”¨æ¥æ¥æ§åˆ¶è¿›ç¨‹é™„åŠ ç®¡ç† , å®ƒå¯ä»¥å®ç°ç¦æ­¢åº”ç”¨ç¨‹åºè¿›ç¨‹è¢«é™„åŠ çš„æ•ˆæœ . åœ¨ iOS ä¸­å¹¶æ²¡æœ‰æš´éœ²å‡ºæ¥ , ä½†æ˜¯ iOS æ˜¯å¯ä»¥ä½¿ç”¨çš„ .</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> arg1: ptraceè¦åšçš„äº‹æƒ…: PT_DENY_ATTACH è¡¨ç¤ºè¦æ§åˆ¶çš„æ˜¯å½“å‰è¿›ç¨‹ä¸å…è®¸è¢«é™„åŠ </span><br><span class="hljs-comment"> arg2: è¦æ“ä½œè¿›ç¨‹çš„PID , 0å°±ä»£è¡¨è‡ªå·±</span><br><span class="hljs-comment"> arg3: åœ°å€ å–å†³äºç¬¬ä¸€ä¸ªå‚æ•°è¦åšçš„å¤„ç†ä¸åŒä¼ é€’ä¸åŒ</span><br><span class="hljs-comment"> arg4: æ•°æ® å–å†³äºç¬¬ä¸€ä¸ªå‚æ•°è¦åšçš„å¤„ç†ä¸åŒä¼ é€’ä¸åŒ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">ptrace</span>(PT_DENY_ATTACH, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><ul><li><p>æ•ˆæœï¼š</p><ul><li>è¿è¡Œå·¥ç¨‹ , ç¨‹åºé—ªé€€ .</li><li>ä»æ‰‹æœºç‚¹å¼€åº”ç”¨ , åº”ç”¨æ­£å¸¸ .</li><li>ä½¿ç”¨Xcode è‡ªå¸¦çš„ Debug - Attach to process å‘ç°é™„åŠ å¤±è´¥</li></ul></li><li><p>ç ´è§£ï¼š</p><ul><li>é€šè¿‡ç¬¦å·æ–­ç‚¹æ£€æµ‹</li><li>ä½¿ç”¨ <code>fishhook</code>  HOOKæ‰ptraceè¿™ä¸ªå‡½æ•°</li></ul></li></ul><hr><h3 id="é˜²æŠ¤ï¼š-sysctl"><a href="#é˜²æŠ¤ï¼š-sysctl" class="headerlink" title="é˜²æŠ¤ï¼š sysctl"></a>é˜²æŠ¤ï¼š sysctl</h3><ul><li><code>sysctl ( system control )</code> æ˜¯ç”± <code>&lt;sys/sysctl.h&gt;</code> æä¾›çš„ä¸€ä¸ªå‡½æ•° , å®ƒæœ‰å¾ˆå¤šä½œç”¨ , å…¶ä¸­ä¸€ä¸ªæ˜¯å¯ä»¥ç›‘æµ‹å½“å‰è¿›ç¨‹æœ‰æ²¡æœ‰è¢«é™„åŠ  . ä½†æ˜¯å› ä¸ºå…¶ç‰¹æ€§ , åªæ˜¯ç›‘æµ‹å½“å‰æ—¶åˆ»åº”ç”¨æœ‰æ²¡æœ‰è¢«é™„åŠ  .</li><li>å› æ­¤æ­£å‘å¼€å‘ä¸­æˆ‘ä»¬å¾€å¾€ç»“åˆå®šæ—¶å™¨ä¸€èµ·ä½¿ç”¨ , æˆ–è€… å®šæ—¶ &#x2F; å®šæœŸ &#x2F; åœ¨ç‰¹å®šæ—¶æœŸ å»ä½¿ç”¨ .</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#import <span class="hljs-string">&quot;ViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;sys/sysctl.h&gt;</span></span><br>@<span class="hljs-function">interface <span class="hljs-title">ViewController</span> <span class="hljs-params">()</span></span><br><span class="hljs-function">@end</span><br><span class="hljs-function"></span><br><span class="hljs-function">@implementation ViewController</span><br><span class="hljs-function">BOOL <span class="hljs-title">isDebug</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> name[<span class="hljs-number">4</span>];             <span class="hljs-comment">//é‡Œé¢æ”¾å­—èŠ‚ç ã€‚æŸ¥è¯¢çš„ä¿¡æ¯</span><br>    name[<span class="hljs-number">0</span>] = CTL_KERN;      <span class="hljs-comment">//å†…æ ¸æŸ¥è¯¢</span><br>    name[<span class="hljs-number">1</span>] = KERN_PROC;     <span class="hljs-comment">//æŸ¥è¯¢è¿›ç¨‹</span><br>    name[<span class="hljs-number">2</span>] = KERN_PROC_PID; <span class="hljs-comment">//ä¼ é€’çš„å‚æ•°æ˜¯è¿›ç¨‹çš„ID</span><br>    name[<span class="hljs-number">3</span>] = <span class="hljs-built_in">getpid</span>();      <span class="hljs-comment">//è·å–å½“å‰è¿›ç¨‹ID</span><br>    <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kinfo_proc</span> info;  <span class="hljs-comment">//æ¥å—æŸ¥è¯¢ç»“æœçš„ç»“æ„ä½“</span><br>    <span class="hljs-type">size_t</span> info_size = <span class="hljs-built_in">sizeof</span>(info);  <span class="hljs-comment">//ç»“æ„ä½“å¤§å°</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">sysctl</span>(name, <span class="hljs-number">4</span>, &amp;info, &amp;info_size, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))&#123;<br>        <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;æŸ¥è¯¢å¤±è´¥&quot;</span>);<br>        <span class="hljs-keyword">return</span> NO;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    æŸ¥è¯¢ç»“æœçœ‹info.kp_proc.p_flag çš„ç¬¬12ä½ã€‚å¦‚æœä¸º1ï¼Œè¡¨ç¤ºè°ƒè¯•çŠ¶æ€ã€‚</span><br><span class="hljs-comment">    (info.kp_proc.p_flag &amp; P_TRACED) å°±æ˜¯0x800, å³å¯è·å–ç¬¬12ä½</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">return</span> ((info.kp_proc.p_flag &amp; P_TRACED) != <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">dispatch_source_t</span> timer;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debugCheck</span><span class="hljs-params">()</span></span>&#123;<br>    timer = <span class="hljs-built_in">dispatch_source_create</span>(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">dispatch_get_global_queue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));<br>    <span class="hljs-built_in">dispatch_source_set_timer</span>(timer, DISPATCH_TIME_NOW, <span class="hljs-number">1.0</span> * NSEC_PER_SEC, <span class="hljs-number">0.0</span> * NSEC_PER_SEC);<br>    <span class="hljs-built_in">dispatch_source_set_event_handler</span>(timer, ^&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isDebug</span>()) &#123;<span class="hljs-comment">//åœ¨è¿™é‡Œå†™ä½ æ£€æµ‹åˆ°è°ƒè¯•è¦åšçš„æ“ä½œ</span><br>            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;è°ƒè¯•çŠ¶æ€!&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;æ­£å¸¸ï¼&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-built_in">dispatch_resume</span>(timer);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [super viewDidLoad];<br>    <span class="hljs-built_in">debugCheck</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>æ•ˆæœï¼š</p><ul><li>å¯ä»¥ä¸ŠæŠ¥æˆ–è€… <code>exit</code></li></ul></li><li><p>ç ´è§£ï¼š</p><ul><li>å› ä¸º <code>sysctl</code>å‡½æ•°ä¹Ÿæ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨fishHookæ¥äº¤æ¢</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">int</span>  (*sysctl_ptr)(<span class="hljs-type">int</span> *, u_int, <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span> *, <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>);<br><br><span class="hljs-function"><span class="hljs-type">int</span>  <span class="hljs-title">my_sysctl</span><span class="hljs-params">(<span class="hljs-type">int</span> * name, u_int namelen, <span class="hljs-type">void</span> * info, <span class="hljs-type">size_t</span> * infoSize, <span class="hljs-type">void</span> * newInfo, <span class="hljs-type">size_t</span> newInfoSize)</span></span>&#123;<br>    <span class="hljs-keyword">if</span> (name[<span class="hljs-number">0</span>] == CTL_KERN &amp;&amp; name[<span class="hljs-number">1</span>] == KERN_PROC &amp;&amp; name[<span class="hljs-number">2</span>] == KERN_PROC_PID &amp;&amp; *infoSize == <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> kinfo_proc)) &#123;<br>        <br>        <span class="hljs-type">int</span> old = <span class="hljs-built_in">sysctl_ptr</span>(name,namelen,info,infoSize,newInfo,newInfoSize);<br>        <span class="hljs-comment">//æ‹¿å‡ºinfo</span><br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kinfo_proc</span> * myinfo = (<span class="hljs-keyword">struct</span> kinfo_proc *)info;<br>        <br>        <span class="hljs-keyword">if</span> ((myinfo-&gt;kp_proc.p_flag &amp; P_TRACED ) != <span class="hljs-number">0</span> ) &#123;<br>            <span class="hljs-comment">//ä½¿ç”¨å¼‚æˆ–å–å</span><br>            myinfo-&gt;kp_proc.p_flag ^= P_TRACED;<br>        &#125;<br>        <span class="hljs-keyword">return</span> old;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sysctl_ptr</span>(name,namelen,info,infoSize,newInfo,newInfoSize);<br>&#125;<br><br>+(<span class="hljs-type">void</span>)load&#123;<br>  <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rebinding</span> rebingSysctl;<br>    rebingSysctl.name = <span class="hljs-string">&quot;sysctl&quot;</span>;<br>    rebingSysctl.replacement = my_sysctl;<br>    rebingSysctl.replaced = (<span class="hljs-type">void</span> *)&amp;sysctl_ptr;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rebinding</span> rebs[<span class="hljs-number">1</span>] = &#123;rebingSysctl&#125;;<br>    <span class="hljs-built_in">rebind_symbols</span>(rebs, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼š<ul><li>éœ€è¦æ…ç”¨ <code>exit</code> å‡½æ•°</li><li>é€†å‘ä¸­é€šè¿‡ <code>exit</code>  æ·»åŠ ç¬¦å·æ–­ç‚¹ï¼Œå°±å¯ä»¥æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆï¼Œä»è€Œå¯ä»¥çœ‹åˆ°è°ƒç”¨ <code>exit</code>çš„å‡½æ•°åœ°å€ï¼Œåœ¨å‡å»é¦–åœ°å€å°±å¯ä»¥æ‹¿åˆ°å‡½æ•°çš„åç§»é‡ï¼Œæ¥ç€åœ¨ <code>Hopper</code> å½“ä¸­å°±å¯ä»¥çŸ¥é“è°ƒç”¨ <code>exit</code> çš„åœ°å€äº†</li><li>æˆ‘ä»¬è‡ªå·±å¼€å‘æ‰€ä½¿ç”¨çš„ <code> framework</code> ä¼šæ¯”æ³¨å…¥çš„åŠ¨æ€åº“æ›´æ—©çš„æ‰§è¡Œï¼Œè™½ç„¶è¿˜æ˜¯ä¼šè¢« <code>fishhook</code> æ›¿æ¢æ‰ï¼Œä½†æ˜¯å¯ä»¥åœ¨æ­¤ä¹‹å‰ï¼Œç¦ç”¨æ‰ <code>fishhook</code> æˆ–è€…å®Œæˆæ£€æµ‹</li><li>åªä¸è¿‡å¦‚æœç ´è§£äººå‘˜æ‰¾åˆ°è¿™ä¸ª <code>framework</code> ï¼Œç„¶ååœ¨ <code>load</code> æ–¹æ³•ä¸­ç›´æ¥ <code>Return</code></li></ul></li></ul><hr><hr><h3 id="é˜²æŠ¤ï¼š-é€šè¿‡å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨-ptrace-å’Œ-sysctl"><a href="#é˜²æŠ¤ï¼š-é€šè¿‡å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨-ptrace-å’Œ-sysctl" class="headerlink" title="é˜²æŠ¤ï¼š é€šè¿‡å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨ ptrace å’Œ sysctl"></a>é˜²æŠ¤ï¼š é€šè¿‡å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨ <code>ptrace</code> å’Œ <code>sysctl</code></h3><ul><li><p>åœ¨æˆ‘å·¥ç¨‹å¼€å§‹æˆ‘å°±è·å– <code>ptrace / sysctl</code> çš„åœ°å€ , åé¢ç›´æ¥ä½¿ç”¨åœ°å€è°ƒç”¨è¿™ä¸ªå‡½æ•° . å®é™…ä¸Šæ˜¯å¯è¡Œçš„ , åˆ©ç”¨ <code>dlsym</code>è¿™ä¸ªå‡½æ•° .</p><ul><li>é€šè¿‡ç¬¦å·è·å–å‡½æ•°åœ°å€ ( dladdr å‡½æ•° ) </li><li>é€šè¿‡å‡½æ•°å†…éƒ¨åœ°å€æ‰¾åˆ°å‡½æ•°ç¬¦å· ( dlsym å‡½æ•° )</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#import <span class="hljs-string">&quot;MyPtraceHeader.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br>  <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">callFunAddres</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>    <span class="hljs-type">int</span> name[<span class="hljs-number">4</span>];             <span class="hljs-comment">//é‡Œé¢æ”¾å­—èŠ‚ç ã€‚æŸ¥è¯¢çš„ä¿¡æ¯</span><br>    name[<span class="hljs-number">0</span>] = CTL_KERN;      <span class="hljs-comment">//å†…æ ¸æŸ¥è¯¢</span><br>    name[<span class="hljs-number">1</span>] = KERN_PROC;     <span class="hljs-comment">//æŸ¥è¯¢è¿›ç¨‹</span><br>    name[<span class="hljs-number">2</span>] = KERN_PROC_PID; <span class="hljs-comment">//ä¼ é€’çš„å‚æ•°æ˜¯è¿›ç¨‹çš„ID</span><br>    name[<span class="hljs-number">3</span>] = <span class="hljs-built_in">getpid</span>();      <span class="hljs-comment">//è·å–å½“å‰è¿›ç¨‹ID</span><br>    <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">kinfo_proc</span> info;  <span class="hljs-comment">//æ¥å—æŸ¥è¯¢ç»“æœçš„ç»“æ„ä½“</span><br>    <span class="hljs-type">size_t</span> info_size = <span class="hljs-built_in">sizeof</span>(info);  <span class="hljs-comment">//ç»“æ„ä½“å¤§å°</span><br>    <br>    <span class="hljs-comment">//è¿™é‡Œåšæ³•æ˜¯éšè—å¸¸é‡å­—ç¬¦ä¸²</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> str[] = &#123;<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;s&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;y&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;s&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;c&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;t&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;l&#x27;</span>),<br>        (<span class="hljs-string">&#x27;a&#x27;</span> ^ <span class="hljs-string">&#x27;\0&#x27;</span>)<br>    &#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * p = str;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, str);<br>    <span class="hljs-keyword">while</span> (((*p) ^= <span class="hljs-string">&#x27;a&#x27;</span>) != <span class="hljs-string">&#x27;\0&#x27;</span>) p++;<br>    <br>    <span class="hljs-type">void</span> * handle = <span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;/usr/lib/system/libsystem_c.dylib&quot;</span>, RTLD_LAZY);<br><br>    <span class="hljs-built_in">int</span>  (*sysctl_ptr)(<span class="hljs-type">int</span> *, u_int, <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span> *, <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>);<br>    <span class="hljs-comment">//è·å–sysctlå‡½æ•°æŒ‡é’ˆ</span><br>    sysctl_ptr = <span class="hljs-built_in">dlsym</span>(handle,(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)str);<br>    <span class="hljs-keyword">if</span> (sysctl_ptr) &#123;<br>        <br>        <span class="hljs-built_in">sysctl_ptr</span>(name, <span class="hljs-number">4</span>, &amp;info, &amp;info_size, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>      <br>        <span class="hljs-keyword">if</span> ((info.kp_proc.p_flag &amp; P_TRACED ) != <span class="hljs-number">0</span> )&#123;<br>            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;è°ƒè¯•çŠ¶æ€&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;æ­£å¸¸&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç ´è§£ <ul><li>ä½¿ç”¨ <code>fishhook </code> å°†  <code>dlopen</code> ä¸ <code>dlsym</code> è¿™ä¸¤ä¸ªç³»ç»Ÿå‡½æ•°å¹²æ‰</li></ul></li></ul><hr><hr><h3 id="é˜²æŠ¤-æ±‡ç¼–"><a href="#é˜²æŠ¤-æ±‡ç¼–" class="headerlink" title="é˜²æŠ¤ æ±‡ç¼–"></a>é˜²æŠ¤ æ±‡ç¼–</h3><ul><li>ä½¿ç”¨æ±‡ç¼–ç›´æ¥è°ƒç”¨</li></ul><hr><hr><h3 id="å­—ç¬¦ä¸²å¸¸é‡éšè—"><a href="#å­—ç¬¦ä¸²å¸¸é‡éšè—" class="headerlink" title="å­—ç¬¦ä¸²å¸¸é‡éšè—"></a>å­—ç¬¦ä¸²å¸¸é‡éšè—</h3><ul><li>ä¾‹å¦‚åœ¨Appå†…æ³¨å†Œç¬¬ä¸‰æ–¹APPçš„Key,SecretKeyç­‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡éšè—</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> kWxAppID @<span class="hljs-string">&quot;krystal69d7xxxxxx&quot;</span>  </span><br> - (<span class="hljs-type">void</span>)configureForWXSDK&#123;<br>    [WXApi registerApp:kWxAppID<br>         universalLink:@<span class="hljs-string">&quot;123123&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨Hopperæ‰“å¼€MachOå°±å¯ä»¥çœ‹åˆ°<br><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gslif4da10j31lw0egmze.jpg">  </p><ul><li>è§£å†³åŠæ³•<ul><li>åœ¨æ–¹æ³•ä¸­è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> KRYSTAL_ENCRYPT_KEY @<span class="hljs-string">&quot;krystal_key&quot;</span></span><br>@implementation ViewController<br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [super viewDidLoad];<br>    <span class="hljs-comment">//ä½¿ç”¨å‡½æ•°ä»£æ›¿å­—ç¬¦ä¸²</span><br>    [self uploadDataWithKey:<span class="hljs-built_in">AES_KEY</span>()];  <br>&#125;<br><br>- (<span class="hljs-type">void</span>)uploadDataWithKey:(NSString *)key&#123;<br>    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;%@&quot;</span>,key);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> NSString * <span class="hljs-title">AES_KEY</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> key[] = &#123;<br>        <span class="hljs-string">&#x27;k&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;k&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> [NSString stringWithUTF8String:(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)key];<br>&#125;<br>@end<br></code></pre></td></tr></table></figure><ul><li><p><strong>ç ´è§£ï¼š</strong></p><ul><li>é™æ€åˆ†æéœ€è¦æ‰¾åˆ°è¿™ä¸ªè¿”å› <code> Key</code> å‡½æ•°</li></ul></li><li><p><strong>å‡çº§é˜²æŠ¤</strong></p><ul><li>é€šè¿‡å¼‚æˆ–æ–¹å¼</li><li>è¿™äº›å­—ç¬¦ä¸ä¼šè¿›å…¥å­—ç¬¦å¸¸é‡åŒº . ç¼–è¯‘å™¨ç›´æ¥æ¢ç®—æˆå¼‚æˆ–ç»“æœ .<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> STRING_ENCRYPT_KEY @<span class="hljs-string">&quot;demo_AES_key&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ENCRYPT_KEY 0xAC</span><br>@<span class="hljs-function">interface <span class="hljs-title">ViewController</span> <span class="hljs-params">()</span></span><br><span class="hljs-function">@end</span><br><span class="hljs-function"></span><br><span class="hljs-function">@implementation ViewController</span><br><span class="hljs-function">- <span class="hljs-params">(<span class="hljs-type">void</span>)</span>viewDidLoad </span>&#123;<br>    [super viewDidLoad];<br><span class="hljs-comment">//    [self uploadDataWithKey:STRING_ENCRYPT_KEY]; //ä½¿ç”¨å®/å¸¸é‡å­—ç¬¦ä¸²</span><br>    [self uploadDataWithKey:<span class="hljs-built_in">AES_KEY</span>()]; <span class="hljs-comment">//ä½¿ç”¨å‡½æ•°ä»£æ›¿å­—ç¬¦ä¸²</span><br>&#125;<br><br>- (<span class="hljs-type">void</span>)uploadDataWithKey:(NSString *)key&#123;<br>    <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;%@&quot;</span>,key);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> NSString * <span class="hljs-title">AES_KEY</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> key[] = &#123;<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;d&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;e&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;m&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;o&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;_&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;A&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;E&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;S&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;_&#x27;</span>),<br>        (ENCRYPT_KEY ^ <span class="hljs-string">&#x27;\0&#x27;</span>),<br>    &#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * p = key;<br>    <span class="hljs-keyword">while</span> (((*p) ^= ENCRYPT_KEY) != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        p++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> [NSString stringWithUTF8String:(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)key];<br>&#125;<br>@end<br></code></pre></td></tr></table></figure></li></ul><ul><li><strong>æ•ˆæœï¼š</strong><br><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gsm44y5b44j30o80ka76l.jpg"></li></ul></li></ul><hr><hr><hr><h3 id="åŠ¨æ€åº“æ£€æµ‹"><a href="#åŠ¨æ€åº“æ£€æµ‹" class="headerlink" title="åŠ¨æ€åº“æ£€æµ‹"></a>åŠ¨æ€åº“æ£€æµ‹</h3><ul><li><p>å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šå­˜å‚¨ä¸€ä»½ <code> _dyld_image_name</code></p></li><li><p>ç„¶åæœ¬åœ°è¿è¡Œåè·å–åˆ°çš„ä¸Šä¼ æœåŠ¡å™¨åšæ¯”å¯¹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++">+ (BOOL)isExternalLibs&#123;<br>    <span class="hljs-keyword">if</span>(TARGET_IPHONE_SIMULATOR)<span class="hljs-keyword">return</span> NO;<br>    <span class="hljs-type">int</span> dyld_count = _dyld_image_count();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; dyld_count; i++) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> * imageName = _dyld_get_image_name(i);<br>        NSString *res = [NSString stringWithUTF8String:imageName];<br>        <span class="hljs-keyword">if</span>([res hasPrefix:@<span class="hljs-string">&quot;/var/containers/Bundle/Application&quot;</span>])&#123;<br>            <span class="hljs-keyword">if</span>([res hasSuffix:@<span class="hljs-string">&quot;.dylib&quot;</span>])&#123;<br>                <span class="hljs-comment">//è¿™è¾¹è¿˜éœ€è¦è¿‡æ»¤æ‰è‡ªå·±é¡¹ç›®ä¸­æœ¬èº«æœ‰çš„åŠ¨æ€åº“</span><br>                <span class="hljs-keyword">return</span> YES;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> NO;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ç ´è§£ï¼š</strong> </p><ul><li>å¯ä»¥hook NSStringçš„hasPrefixæ–¹æ³•ç»•è¿‡æ£€æµ‹</li></ul></li></ul><hr><hr><h3 id="é˜²æŠ¤-NSFileManager"><a href="#é˜²æŠ¤-NSFileManager" class="headerlink" title="é˜²æŠ¤  NSFileManager"></a>é˜²æŠ¤  NSFileManager</h3><ul><li>ä½¿ç”¨NSFileManageré€šè¿‡æ£€æµ‹ä¸€äº›è¶Šç‹±åçš„å…³é”®æ–‡ä»¶&#x2F;è·¯å¾„æ˜¯å¦å¯ä»¥è®¿é—®æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹± å¸¸è§çš„æ–‡ä»¶&#x2F;è·¯å¾„æœ‰<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++"> <span class="hljs-type">static</span> <span class="hljs-type">char</span> *JailbrokenPathArr[] = &#123;<span class="hljs-string">&quot;/Applications/Cydia.app&quot;</span>,<br>                                     <span class="hljs-string">&quot;/usr/sbin/sshd&quot;</span>,<br>                                     <span class="hljs-string">&quot;/bin/bash&quot;</span>,<br>                                     <span class="hljs-string">&quot;/etc/apt&quot;</span>,<br>                                     <span class="hljs-string">&quot;/Library/MobileSubstrate&quot;</span>,<br>                                     <span class="hljs-string">&quot;/User/Applications/&quot;</span>&#125;; <br>      <br>      <br>+ (BOOL)isJailbroken1&#123;<br>    <span class="hljs-keyword">if</span>(TARGET_IPHONE_SIMULATOR)<span class="hljs-keyword">return</span> NO;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-built_in">sizeof</span>(JailbrokenPathArr) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span> *);i++) &#123;<br>        <span class="hljs-keyword">if</span>([[NSFileManager defaultManager] fileExistsAtPath:[NSString stringWithUTF8String:JailbrokenPathArr[i]]])&#123;<br>            <span class="hljs-keyword">return</span> YES;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> NO;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>ç ´è§£<ul><li>æ”»å‡»è€…å¯ä»¥é€šè¿‡hook NSFileManagerçš„fileExistsAtPathæ–¹æ³•æ¥ç»•è¿‡æ£€æµ‹<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//ç»•è¿‡ä½¿ç”¨NSFileManageråˆ¤æ–­ç‰¹å®šæ–‡ä»¶æ˜¯å¦å­˜åœ¨çš„è¶Šç‹±æ£€æµ‹ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›NOåŠ¿å¿…ä¼šå½±å“ç¨‹åºä¸­å¯¹è¿™ä¸ªæ–¹æ³•çš„æ­£å¸¸ä½¿ç”¨ï¼Œå› æ­¤å¯ä»¥å…ˆæ‰“å°ä¸€ä¸‹pathï¼Œç„¶ååˆ¤æ–­å¦‚æœpathæ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦è¶Šç‹±åˆ™è¿”å›NOï¼Œå¦åˆ™æŒ‰ç…§æ­£å¸¸é€»è¾‘è¿”å›</span><br>%hook NSFileManager<br>- (BOOL)fileExistsAtPath:(NSString *)path&#123;<br>    <span class="hljs-keyword">if</span>(TARGET_IPHONE_SIMULATOR)<span class="hljs-keyword">return</span> NO;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-built_in">sizeof</span>(JailbrokenPathArr) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span> *);i++) &#123;<br>        NSString *jPath = [NSString stringWithUTF8String:JailbrokenPathArr[i]];<br>        <span class="hljs-keyword">if</span>([path isEqualToString:jPath])&#123;<br>            <span class="hljs-keyword">return</span> NO;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> %orig;<br>&#125;<br>%end<br><br></code></pre></td></tr></table></figure></li></ul></li></ul><hr><hr><h3 id="é˜²æŠ¤-stat-å‡½æ•°"><a href="#é˜²æŠ¤-stat-å‡½æ•°" class="headerlink" title="é˜²æŠ¤ stat å‡½æ•°"></a>é˜²æŠ¤ <code>stat</code> å‡½æ•°</h3><ul><li><p>ä½¿ç”¨Cè¯­è¨€å‡½æ•°statåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨(æ³¨:statå‡½æ•°ç”¨äºè·å–å¯¹åº”æ–‡ä»¶ä¿¡æ¯ï¼Œè¿”å›0åˆ™ä¸ºè·å–æˆåŠŸï¼Œ-1ä¸ºè·å–å¤±è´¥)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++">+ (BOOL)isJailbroken2&#123;<br>    <span class="hljs-keyword">if</span>(TARGET_IPHONE_SIMULATOR)<span class="hljs-keyword">return</span> NO;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-built_in">sizeof</span>(JailbrokenPathArr) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span> *);i++) &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> stat_info;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">stat</span>(JailbrokenPathArr[i], &amp;stat_info)) &#123;<br>            <span class="hljs-keyword">return</span> YES;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> NO;<br>&#125;      <br></code></pre></td></tr></table></figure></li><li><p>ç ´è§£ï¼š</p><ul><li>ä½¿ç”¨fishhookå¯hook Cå‡½æ•°ï¼Œfishhooké€šè¿‡åœ¨mac-oæ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶æ›¿æ¢å‡½æ•°åœ°å€è¾¾åˆ°hookçš„ç›®çš„<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-title">int</span> <span class="hljs-params">(*orig_stat)</span><span class="hljs-params">(<span class="hljs-type">char</span> *c, <span class="hljs-keyword">struct</span> stat *s)</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">hook_stat</span><span class="hljs-params">(<span class="hljs-type">char</span> *c, <span class="hljs-keyword">struct</span> stat *s)</span></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-built_in">sizeof</span>(JailbrokenPathArr) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span> *);i++) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> == <span class="hljs-built_in">strcmp</span>(c, JailbrokenPathArr[i]))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">orig_stat</span>(c,s);<br>&#125;<br>+(<span class="hljs-type">void</span>)statHook&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rebinding</span> stat_rebinding = &#123;<span class="hljs-string">&quot;stat&quot;</span>, hook_stat, (<span class="hljs-type">void</span> *)&amp;orig_stat&#125;;<br>    <span class="hljs-built_in">rebind_symbols</span>((<span class="hljs-keyword">struct</span> rebinding[<span class="hljs-number">1</span>])&#123;stat_rebinding&#125;, <span class="hljs-number">1</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure> åœ¨åŠ¨æ€åº“åŠ è½½çš„æ—¶å€™ï¼Œè°ƒç”¨statHook    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"> %ctor&#123;<br>    [StatHook statHook];<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>åˆ¤æ–­statçš„æ¥æºæ˜¯å¦æ¥è‡ªäºç³»ç»Ÿåº“ï¼Œå› ä¸ºfishhooké€šè¿‡äº¤æ¢å‡½æ•°åœ°å€æ¥å®ç°hookï¼Œè‹¥hookäº†statï¼Œåˆ™statæ¥æºå°†æŒ‡å‘æ”»å‡»è€…æ³¨å…¥çš„åŠ¨æ€åº“ä¸­ å› æ­¤æˆ‘ä»¬å¯ä»¥å®Œå–„ä¸Šæ–¹çš„isJailbroken2åˆ¤æ–­è§„åˆ™ï¼Œè‹¥statæ¥æºéç³»ç»Ÿåº“ï¼Œåˆ™ç›´æ¥è¿”å›å·²è¶Šç‹±      </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C++">+ (BOOL)isJailbroken2&#123;<br>    <span class="hljs-keyword">if</span>(TARGET_IPHONE_SIMULATOR)<span class="hljs-keyword">return</span> NO;<br>    <span class="hljs-type">int</span> ret ;<br>    Dl_info dylib_info;<br>    <span class="hljs-built_in">int</span> (*func_stat)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-keyword">struct</span> stat *) = stat;<br>    <span class="hljs-keyword">if</span> ((ret = <span class="hljs-built_in">dladdr</span>(func_stat, &amp;dylib_info))) &#123;<br>        NSString *fName = [NSString stringWithUTF8String:dylib_info.dli_fname];<br>        <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;fname--%@&quot;</span>,fName);<br>        <span class="hljs-keyword">if</span>(![fName isEqualToString:@<span class="hljs-string">&quot;/usr/lib/system/libsystem_kernel.dylib&quot;</span>])&#123;<br>            <span class="hljs-keyword">return</span> YES;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-built_in">sizeof</span>(JailbrokenPathArr) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span> *);i++) &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> stat_info;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">stat</span>(JailbrokenPathArr[i], &amp;stat_info)) &#123;<br>            <span class="hljs-keyword">return</span> YES;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> NO;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul><hr><hr><hr><h3 id="BundleIDæ£€æµ‹"><a href="#BundleIDæ£€æµ‹" class="headerlink" title="BundleIDæ£€æµ‹"></a>BundleIDæ£€æµ‹</h3><ul><li>è¿›è¡ŒBundleIDæ£€æµ‹å¯ä»¥æœ‰æ•ˆé˜²æ­¢å¤šå¼€</li><li>è·å–å½“å‰é¡¹ç›®çš„BundleIDæœ‰å¤šç§æ–¹æ³•ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ï¼Œç»•è¿‡æ£€æµ‹åˆ™æ˜¯hookå¯¹åº”çš„æ–¹æ³•ï¼Œè¿”å›åŸæœ‰çš„BundleID</li><li>é˜²æ­¢æ”»å‡»è€…ç»•è¿‡æ£€æµ‹ï¼Œå¯ä»¥åœ¨è‡ªè¡Œlinkçš„frameworkä¸­è·å–BundleIDå¹¶è¿›è¡Œæ£€æµ‹ï¼Œä»¥åœ¨è¢«hookå‰è¿›è¡Œæ ¡éªŒ<br> BundleIDå¹¶è¿›è¡Œæ ¡éªŒä»¥é¿å…å¸¸è§çš„BundleIDè·å–æ–¹æ³•è¢«hook<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//è·å–Boundle ID</span><br><span class="hljs-type">char</span>  * bundleName =  getenv(<span class="hljs-string">&quot;XPC_SERVICE_NAME&quot;</span>);<br>    NSLog(@<span class="hljs-string">&quot;%s&quot;</span>,bundleName);<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>iOSé€†å‘</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-å¤œé—´æ¨¡å¼æ¡†æ¶</title>
    <link href="/2021/05/01/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/"/>
    <url>/2021/05/01/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<p>iOSå¤œé—´æ¨¡å¼çš„é€‚é…ï¼Œä¸»è¦ç”¨åˆ°äº†<code>NSProxy</code>è½¬å‘åŸç† ï¼Œå…¶ä¸­JYDynamicColorç»§æ‰¿äºUIColor</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface JYDynamicColor : UIColor<br><br>@property (nonatomic, readonly) UIColor * lightColor;<br><br>@property (nonatomic, readonly) UIColor * darkColor;<br><br>+ (UIColor *)colorWithLightColor:(UIColor *)lightColor darkColor:(UIColor *)darkColor;<br><br>+ (UIColor *)colorWithDynamicProvider:(UIColor * (^)(JYTraitCollection *traitCollection))dynamicProvider;<br><br>@end<br></code></pre></td></tr></table></figure><p>  ä½†æ˜¯åœ¨.mæ–‡ä»¶ä¸­,æˆ‘ä»¬å®é™…å°†æ¶ˆæ¯ç»™äº†JYDynamicColorProxyå¤„ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@implementation JYDynamicColor<br><br>+ (UIColor *)colorWithLightColor:(UIColor *)lightColor darkColor:(UIColor *)darkColor &#123;<br>  return [self colorWithDynamicProvider:^(JYTraitCollection *traitCollection)&#123;<br>    return traitCollection.userInterfaceStyle == JYInterfaceStyleDark ? darkColor : lightColor;<br>  &#125;];<br>&#125;<br><br>+ (UIColor *)colorWithDynamicProvider:(UIColor * _Nonnull (^)(JYTraitCollection * _Nonnull))dynamicProvider &#123;<br>    <br>    return (JYDynamicColor *)[[JYDynamicColorProxy alloc] initWithDynamicProvider:dynamicProvider];<br>&#125;<br><br>- (UIColor *)lightColor &#123;<br>  NSAssert(NO, @&quot;This should never be called&quot;);<br>  return nil;<br>&#125;<br><br>- (UIColor *)darkColor &#123;<br>  NSAssert(NO, @&quot;This should never be called&quot;);<br>   return nil;<br>&#125;<br><br>@end<br></code></pre></td></tr></table></figure><p>æ¥ç€çœ‹åˆ°<code>JYDynamicColorProxy</code>æ˜¯ç»§æ‰¿äº<code>NSProxy</code>ï¼Œå°†æ‰€æœ‰çš„äº‹ä»¶éƒ½è½¬å‘åˆ°äº†<code>resolvedColor</code>ï¼Œè€Œ<code>resolvedColor</code>æ˜¯æ ¹æ®å½“å‰æ¨¡å¼è¿”å› <code>lightColor</code> æˆ–è€… <code>darkColor</code>,è¿™æ ·å°±å®ç°äº†ï¼Œå¯¹å¤–å…¶å®æ˜¯ä¸€ä¸ª<code>UIColor</code>ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸€ä¸ª<code>JYDynamicColorProxy</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface JYDynamicColorProxy : NSProxy &lt;NSCopying&gt;<br><br>@property (nonatomic, readonly) UIColor * resolvedColor;<br><br>@property (nonatomic, strong) UIColor *(^dynamicProvider)(JYTraitCollection *);<br><br>@end<br><br><br>@implementation JYDynamicColorProxy<br><br>- (instancetype)initWithDynamicProvider:(UIColor * (^)(JYTraitCollection *traitCollection))dynamicProvider &#123;<br>  self.dynamicProvider = dynamicProvider;<br>  return self;<br>&#125;<br><br>// MARK: NSProxy - è½¬å‘æ¶ˆæ¯ å°†æ¶ˆæ¯å…¨éƒ¨è½¬å‘åˆ° resolvedColor<br>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;<br>  return [self.resolvedColor methodSignatureForSelector:sel];<br>&#125;<br><br>- (void)forwardInvocation:(NSInvocation *)invocation &#123;<br>  [invocation invokeWithTarget:self.resolvedColor];<br>&#125;<br><br>- (UIColor *)resolvedColor &#123;<br>  return [self resolvedColorWithTraitCollection:JYTraitCollection.overrideTraitCollection];<br>&#125;<br><br>- (UIColor *)resolvedColorWithTraitCollection:(JYTraitCollection *)traitCollection &#123;<br>    return self.dynamicProvider(traitCollection);<br>&#125;<br><br>// MARK: UIColor<br>- (UIColor *)colorWithAlphaComponent:(CGFloat)alpha &#123;<br>  return [JYDynamicColor colorWithDynamicProvider:^UIColor *(JYTraitCollection *traitCollection) &#123;<br>    return [self.dynamicProvider(traitCollection) colorWithAlphaComponent:alpha];<br>  &#125;];<br>&#125;<br><br>- (CGColorRef)CGColor &#123;<br>  return [[self resolvedColor] CGColor];<br>&#125;<br><br><br>// MARK: NSObject<br>- (BOOL)isKindOfClass:(Class)aClass &#123;<br>  static JYDynamicColor *dynamicColor = nil;<br>  static dispatch_once_t onceToken;<br>  dispatch_once(&amp;onceToken, ^&#123;<br>    dynamicColor = [[JYDynamicColor alloc] init];<br>  &#125;);<br>  return [dynamicColor isKindOfClass:aClass];<br>&#125;<br><br>// MARK: NSCopying<br>- (id)copy &#123;<br>  return [self copyWithZone:nil];<br>&#125;<br><br>- (id)copyWithZone:(NSZone *)zone &#123;<br>  return [[JYDynamicColorProxy alloc] initWithDynamicProvider:[self.dynamicProvider copy]];<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p> iOS13ä»¥ä¸‹ï¼Œå¦‚æœéœ€è¦åˆ‡æ¢é¢œè‰²ï¼Œè¯¥å¦‚ä½•åˆ·æ–°ï¼Ÿ<code>JYDynamicColorProxy</code>æ˜¯å¦‚ä½•å­˜å‚¨é¢œè‰²çš„å‘¢ï¼Ÿ</p></blockquote><p>æˆ‘ä»¬<code>swizzle</code>å°†è®¾ç½®é¢œè‰²æ–¹æ³•è¿›è¡Œäº†hookï¼Œä¾‹å¦‚<code>@selector(setBackgroundColor:);</code>æ–¹æ³•ï¼Œå°†<code>backgroundColor</code>ä¸º<code>JYDynamicColor</code>çš„éƒ½è¿›è¡Œå¤„ç†</p><p>è¿™é‡Œé‡‡ç”¨äº†å…³è”å¯¹è±¡çš„æ€æƒ³ï¼Œå†™äº†ä¸€ä¸ª<code>UIView</code>çš„åˆ†ç±»,å°†<code>JYDynamicColorProxy</code>è¿›è¡Œå­˜å‚¨ï¼Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">...<br>@property (nullable, readonly) JYDynamicColor *jy_dynamicBackgroundColor;<br>...<br><br>- (JYDynamicColor *)jy_dynamicBackgroundColor &#123;<br>    return objc_getAssociatedObject(self, @selector(jy_dynamicBackgroundColor));<br>&#125;<br><br>- (void)setJy_dynamicBackgroundColor:(JYDynamicColor *)jy_dynamicBackgroundColor &#123;<br>  objc_setAssociatedObject(self,<br>                           @selector(jy_dynamicBackgroundColor),<br>                           jy_dynamicBackgroundColor,<br>                           OBJC_ASSOCIATION_COPY_NONATOMIC);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä¿®æ”¹å½“å‰æ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†åˆå§‹åŒ–æ‹¿åˆ°çš„<code>UIApplication</code>è¿›è¡Œéå†ï¼Œæ‹¿åˆ°<code>UIView</code>,ç„¶åè°ƒç”¨åˆ†ç±»å½“ä¸­çš„ä¿®æ”¹é¢œè‰²æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)jyTraitCollectionDidChange:(JYTraitCollection *)previousTraitCollection &#123;<br>  if (@available(iOS 13.0, *)) &#123;<br>    return;<br>  &#125;<br>    [self.subviews enumerateObjectsUsingBlock:^(__kindof UIView * _Nonnull view, NSUInteger idx, BOOL * _Nonnull stop) &#123;<br>        [view jyTraitCollectionDidChange:previousTraitCollection];<br>     &#125;];<br>     <br>    [self setNeedsLayout];<br>    [self setNeedsDisplay];<br>#if __IPHONE_OS_VERSION_MIN_REQUIRED &lt; __IPHONE_13_0<br>    [self jy_updateDynamicColors];<br>#endif<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)jy_updateDynamicColors&#123;<br>    JYDynamicColor * backgroundColor = [self jy_dynamicBackgroundColor];<br>    if (backgroundColor) &#123;<br>        [self setBackgroundColor:backgroundColor];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡å…³è”å¯¹è±¡å–åˆ°å¯¹åº”æ¨¡å¼çš„Color,ç„¶åèµ‹å€¼å³å¯ï¼Œå›¾ç‰‡ä¹Ÿæ˜¯ä¸€æ ·çš„åŸç†</p>]]></content>
    
    
    <categories>
      
      <category>iOSæºç </category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-æ¸²æŸ“æœºåˆ¶</title>
    <link href="/2021/04/01/iOS-%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/"/>
    <url>/2021/04/01/iOS-%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="CALayer-ä¸-UIView"><a href="#CALayer-ä¸-UIView" class="headerlink" title="CALayer ä¸ UIView"></a>CALayer ä¸ UIView</h3><p>UIViewæ‹¥æœ‰ä¸€ä¸ªå±æ€§ä¸º<code>layer</code>å’Œ<code>layerClass</code>å±æ€§</p><ul><li><code>layer</code> å±æ€§è¿”å›çš„æ˜¯ <code>UIView</code> æ‰€æŒæœ‰çš„ä¸» <code>Layer(RootLayer)</code> å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶æ¥è®¾ç½® <code>UIView</code> æ²¡æœ‰å°è£…çš„ä¸€äº› <code>layer</code> å±æ€§ï¼›</li><li><code>layerClass</code> åˆ™è¿”å› <code>RootLayer</code> æ‰€ä½¿ç”¨çš„ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™è¯¥å±æ€§ï¼Œæ¥è®© <code>UIView</code> ä½¿ç”¨ä¸åŒçš„ <code>CALayer</code> æ¥æ˜¾ç¤º</li></ul><p><code>CALayer</code>ç»§æ‰¿è‡ª<code>NSObject</code>ï¼Œè´Ÿè´£å›¾åƒæ¸²æŸ“</p><p><code>UIView</code>ç»§æ‰¿è‡ª<code>UIResponder</code>ï¼Œè´Ÿè´£äº‹ä»¶çš„å“åº”</p><h3 id="å›¾åƒæ˜¾ç¤ºåŸç†"><a href="#å›¾åƒæ˜¾ç¤ºåŸç†" class="headerlink" title="å›¾åƒæ˜¾ç¤ºåŸç†"></a>å›¾åƒæ˜¾ç¤ºåŸç†</h3><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024844.png" alt="image-20190312112603570"></p><p>CPUå’ŒGPUé€šè¿‡æ€»çº¿è¿æ¥ï¼ŒCPUä¸­è®¡ç®—å‡ºçš„å¾€å¾€æ˜¯<code>bitmap</code>ä½å›¾ï¼Œé€šè¿‡æ€»çº¿ç”±åˆé€‚çš„æ—¶æœºä¼ é€’ç»™GPUï¼ŒGPUæ‹¿åˆ°ä½å›¾åï¼Œæ¸²æŸ“åˆ°å¸§ç¼“å­˜åŒº<code>FrameBuffer</code>,ç„¶åç”±è§†é¢‘æ§åˆ¶å™¨æ ¹æ®<code>Vsync</code>ä¿¡å·åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰å»å¸§ç¼“å†²åŒºæå–å†…å®¹ï¼Œæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚</p><p>CPUå·¥ä½œå†…å®¹: </p><ol><li>layoutï¼ˆUIå¸ƒå±€ï¼Œæ–‡æœ¬è®¡ç®—ï¼‰</li><li>displayï¼ˆç»˜åˆ¶ drawRectï¼‰</li><li>prepare(å›¾ç‰‡è§£ç )</li><li>commitï¼ˆæäº¤ä½å›¾ï¼‰</li></ol><p><code>GPUå·¥ä½œå†…å®¹:</code> é¡¶ç‚¹ç€è‰²ï¼Œå›¾å…ƒè£…é…ï¼Œå…‰æ …åŒ–ï¼Œç‰‡æ®µç€è‰²ï¼Œç‰‡æ®µå¤„ç†ï¼Œæœ€åæäº¤å¸§ç¼“å†²åŒº</p><h3 id="Viewç»˜åˆ¶æ¸²æŸ“æœºåˆ¶å’ŒRunloopä»€ä¹ˆå…³ç³»"><a href="#Viewç»˜åˆ¶æ¸²æŸ“æœºåˆ¶å’ŒRunloopä»€ä¹ˆå…³ç³»" class="headerlink" title="Viewç»˜åˆ¶æ¸²æŸ“æœºåˆ¶å’ŒRunloopä»€ä¹ˆå…³ç³»"></a>Viewç»˜åˆ¶æ¸²æŸ“æœºåˆ¶å’ŒRunloopä»€ä¹ˆå…³ç³»</h3><p>ä¾‹å¦‚æœ‰ä»¥ä¸‹ <code>UIView</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@implementation JYView<br>- (void)drawRect:(CGRect)rect &#123;<br>    CGContextRef con = UIGraphicsGetCurrentContext();<br>    CGContextAddEllipseInRect(con, CGRectMake(0,0,100,200));<br>    CGContextSetRGBFillColor(con, 0, 0, 1, 1);<br>    CGContextFillPath(con);<br>&#125;<br>@end<br><br><br>@implementation ViewController<br><br>- (void)viewDidLoad &#123;<br>    [super viewDidLoad];<br>    JYView *view = [[JYView alloc] init];<br>    view.backgroundColor = [UIColor whiteColor];<br>    view.bounds = CGRectMake(0, 0, 100, 100);<br>    view.center = CGPointMake(100, 100);<br>    [self.view addSubview:view];<br>&#125;<br><br>@end<br></code></pre></td></tr></table></figure><p>é‡å†™äº† <code>UIView</code> çš„ <code>DrawRect</code>æ–¹æ³•.å±•ç°åœ¨å±å¹•å‰ç»å†ä»¥ä¸‹å †æ ˆ</p><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2020-03-03-093059.jpg" alt="img"></p><h3 id="åº•å±‚åŸç†"><a href="#åº•å±‚åŸç†" class="headerlink" title="åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h3><p>å½“åœ¨æ“ä½œ UI æ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº†<code>Frame</code> ã€æ›´æ–°äº† <code>UIView/CALayer</code> çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† <code>UIView/CALayer</code> çš„ <code>setNeedsLayout/setNeedsDisplay</code> æ–¹æ³•åï¼Œè¿™ä¸ª <code>UIView/CALayer</code> å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚ è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(å³å°†è¿›å…¥ä¼‘çœ ) å’Œ Exit (å³å°†é€€å‡ºLoop) äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š <code>_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()</code>ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView&#x2F;CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()<br>QuartzCore:CA::Transaction::observer_callback:<br>CA::Transaction::commit();<br>CA::Context::commit_transaction();<br>CA::Layer::layout_and_display_if_needed();<br>CA::Layer::layout_if_needed();<br>[CALayer layoutSublayers];<br>[UIView layoutSubviews];<br>CA::Layer::display_if_needed();<br>[CALayer display];<br>[UIView drawRect];<br></code></pre></td></tr></table></figure><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2020-03-04-A4.png" alt="img"></p><h3 id="Viewå¸ƒå±€ä¸çº¦æŸæ—¶æœº"><a href="#Viewå¸ƒå±€ä¸çº¦æŸæ—¶æœº" class="headerlink" title="Viewå¸ƒå±€ä¸çº¦æŸæ—¶æœº"></a>Viewå¸ƒå±€ä¸çº¦æŸæ—¶æœº</h3><p>ä¸€ä¸ªè§†å›¾çš„å¸ƒå±€æŒ‡çš„æ˜¯å®ƒåœ¨å±å¹•ä¸Šçš„çš„å¤§å°å’Œä½ç½®ã€‚æ¯ä¸ª view éƒ½æœ‰ä¸€ä¸ª frame å±æ€§ï¼Œç”¨æ¥è¡¨ç¤ºåœ¨çˆ¶ view åæ ‡ç³»ä¸­çš„ä½ç½®å’Œå…·ä½“çš„å¤§å°ã€‚<code>UIView</code> ç»™ä½ æä¾›äº†ç”¨æ¥é€šçŸ¥ç³»ç»ŸæŸä¸ª view å¸ƒå±€å‘ç”Ÿå˜åŒ–çš„æ–¹æ³•ï¼Œä¹Ÿæä¾›äº†åœ¨ view å¸ƒå±€é‡æ–°è®¡ç®—åè°ƒç”¨çš„å¯é‡å†™çš„æ–¹æ³•ã€‚</p><h4 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€:"></a>å¸ƒå±€:</h4><p><strong>layoutSubviews()</strong></p><p>å®ƒè´Ÿè´£ç»™å‡ºå½“å‰ view å’Œæ¯ä¸ªå­ view çš„ä½ç½®å’Œå¤§å°ã€‚è¿™ä¸ªæ–¹æ³•å¾ˆå¼€é”€å¾ˆå¤§ï¼Œå› ä¸ºå®ƒä¼šåœ¨æ¯ä¸ªå­è§†å›¾ä¸Šèµ·ä½œç”¨å¹¶ä¸”è°ƒç”¨å®ƒä»¬ç›¸åº”çš„ <code>layoutSubviews</code> æ–¹æ³•ã€‚ç³»ç»Ÿä¼šåœ¨ä»»ä½•å®ƒéœ€è¦é‡æ–°è®¡ç®—è§†å›¾çš„ frame çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä½ åº”è¯¥åœ¨éœ€è¦æ›´æ–° frame æ¥é‡æ–°å®šä½æˆ–æ›´æ”¹å¤§å°æ—¶é‡è½½å®ƒã€‚ç„¶è€Œä½ ä¸åº”è¯¥åœ¨ä»£ç ä¸­æ˜¾å¼è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ç›¸åï¼Œæœ‰è®¸å¤šå¯ä»¥åœ¨ run loop çš„ä¸åŒæ—¶é—´ç‚¹è§¦å‘ <code>layoutSubviews</code> è°ƒç”¨çš„æœºåˆ¶ï¼Œè¿™äº›è§¦å‘æœºåˆ¶æ¯”ç›´æ¥è°ƒç”¨ <code>layoutSubviews</code> çš„èµ„æºæ¶ˆè€—è¦å°å¾—å¤šã€‚</p><p><strong>è‡ªåŠ¨åˆ·æ–°è§¦å‘å™¨</strong></p><p>æœ‰è®¸å¤šäº‹ä»¶ä¼šè‡ªåŠ¨ç»™è§†å›¾æ‰“ä¸Š â€œupdate layoutâ€ æ ‡è®°ï¼Œå› æ­¤ <code>layoutSubviews</code> ä¼šåœ¨<strong>ä¸‹ä¸€ä¸ªå‘¨æœŸä¸­ï¼ˆé‡ç‚¹ï¼ï¼ï¼ï¼‰</strong>è¢«è°ƒç”¨ï¼Œè€Œä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨æ“ä½œã€‚è¿™äº›è‡ªåŠ¨é€šçŸ¥ç³»ç»Ÿ view çš„å¸ƒå±€å‘ç”Ÿå˜åŒ–çš„æ–¹å¼æœ‰ï¼š</p><ul><li>ä¿®æ”¹ view çš„å¤§å°</li><li>æ–°å¢ subview</li><li>ç”¨æˆ·åœ¨ <code>UIScrollView</code> ä¸Šæ»šåŠ¨ï¼ˆ<code>layoutSubviews</code> ä¼šåœ¨ <code>UIScrollView</code> å’Œå®ƒçš„çˆ¶ view ä¸Šè¢«è°ƒç”¨ï¼‰</li><li>ç”¨æˆ·æ—‹è½¬è®¾å¤‡</li><li>æ›´æ–°è§†å›¾çš„ constraints</li></ul><p>è¿™äº›æ–¹å¼éƒ½ä¼šå‘ŠçŸ¥ç³»ç»Ÿ view çš„ä½ç½®éœ€è¦è¢«é‡æ–°è®¡ç®—ï¼Œç»§è€Œä¼šè‡ªåŠ¨è½¬åŒ–ä¸ºä¸€ä¸ªæœ€ç»ˆçš„ <code>layoutSubviews</code> è°ƒç”¨ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ç›´æ¥è§¦å‘ <code>layoutSubviews</code> çš„æ–¹æ³•ã€‚</p><p><strong>setNeedsLayout()</strong></p><p>è§¦å‘ <code>layoutSubviews</code> è°ƒç”¨çš„æœ€çœèµ„æºçš„æ–¹æ³•å°±æ˜¯åœ¨ä½ çš„è§†å›¾ä¸Šè°ƒç”¨ <code>setNeedsLaylout</code> æ–¹æ³•ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä»£è¡¨å‘ç³»ç»Ÿè¡¨ç¤ºè§†å›¾çš„å¸ƒå±€éœ€è¦é‡æ–°è®¡ç®—ã€‚<code>setNeedsLayout</code> æ–¹æ³•ä¼šç«‹åˆ»æ‰§è¡Œå¹¶è¿”å›ï¼Œä½†åœ¨è¿”å›å‰ä¸ä¼šçœŸæ­£æ›´æ–°è§†å›¾ã€‚è§†å›¾ä¼šåœ¨ä¸‹ä¸€ä¸ª update cycle ä¸­æ›´æ–°ï¼Œå°±åœ¨ç³»ç»Ÿè°ƒç”¨è§†å›¾ä»¬çš„ <code>layoutSubviews</code> ä»¥åŠä»–ä»¬çš„æ‰€æœ‰å­è§†å›¾çš„ <code>layoutSubviews</code> æ–¹æ³•çš„æ—¶å€™ã€‚</p><p><strong>layoutIfNeeded()</strong></p><p><code>layoutIfNeeded</code> æ˜¯å¦ä¸€ä¸ªä¼šè®© <code>UIView</code> è§¦å‘ <code>layoutSubviews</code> çš„æ–¹æ³•ã€‚ å½“è§†å›¾éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œä¸ <code>setNeedsLayout()</code> ä¼šè®©è§†å›¾åœ¨ä¸‹ä¸€å‘¨æœŸè°ƒç”¨ <code>layoutSubviews</code> æ›´æ–°è§†å›¾ä¸åŒï¼Œ<code>layoutIfNeeded</code> ä¼šç«‹å³è°ƒç”¨ <code>layoutSubviews</code> æ–¹æ³•ã€‚ä½†æ˜¯å¦‚æœä½ è°ƒç”¨äº† <code>layoutIfNeeded</code> ä¹‹åï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æ“ä½œå‘ç³»ç»Ÿè¡¨æ˜éœ€è¦åˆ·æ–°è§†å›¾ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè°ƒç”¨ <code>layoutsubview</code>ã€‚å¦‚æœä½ åœ¨åŒä¸€ä¸ª run loop å†…è°ƒç”¨ä¸¤æ¬¡ <code>layoutIfNeeded</code>ï¼Œå¹¶ä¸”ä¸¤æ¬¡ä¹‹é—´æ²¡æœ‰æ›´æ–°è§†å›¾ï¼Œç¬¬äºŒä¸ªè°ƒç”¨åŒæ ·ä¸ä¼šè§¦å‘ <code>layoutSubviews</code> æ–¹æ³•ã€‚</p><p>ä½¿ç”¨ <code>layoutIfNeeded</code>ï¼Œåˆ™å¸ƒå±€å’Œé‡ç»˜ä¼šç«‹å³å‘ç”Ÿå¹¶åœ¨å‡½æ•°è¿”å›ä¹‹å‰å®Œæˆï¼ˆé™¤éæœ‰æ­£åœ¨è¿è¡Œä¸­çš„åŠ¨ç”»ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ä½ éœ€è¦ä¾èµ–æ–°å¸ƒå±€ï¼Œæ— æ³•ç­‰åˆ°ä¸‹ä¸€æ¬¡ update cycle çš„æ—¶å€™ä¼šæ¯” <code>setNeedsLayout</code> æœ‰ç”¨</p><p>å½“å¯¹å¸Œæœ›é€šè¿‡ä¿®æ”¹ constraint è¿›è¡ŒåŠ¨ç”»æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ç‰¹åˆ«æœ‰ç”¨ã€‚ä½ éœ€è¦åœ¨ animation block ä¹‹å‰å¯¹ self.view è°ƒç”¨ <code>layoutIfNeeded</code>ï¼Œä»¥ç¡®ä¿åœ¨åŠ¨ç”»å¼€å§‹ä¹‹å‰ä¼ æ’­æ‰€æœ‰çš„å¸ƒå±€æ›´æ–°ã€‚åœ¨ animation block ä¸­è®¾ç½®æ–° constrait åï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ <code>layoutIfNeeded</code> æ¥åŠ¨ç”»åˆ°æ–°çš„çŠ¶æ€ã€‚</p><p>(<strong>æ³¨:</strong> Masonry åŠ¨ç”»éœ€è¦è¿™ä¸ª)</p><h4 id="æ˜¾ç¤ºï¼š"><a href="#æ˜¾ç¤ºï¼š" class="headerlink" title="æ˜¾ç¤ºï¼š"></a>æ˜¾ç¤ºï¼š</h4><p>ä¸€ä¸ªè§†å›¾çš„æ˜¾ç¤ºåŒ…å«äº†é¢œè‰²ã€æ–‡æœ¬ã€å›¾ç‰‡å’Œ Core Graphics ç»˜åˆ¶ç­‰è§†å›¾å±æ€§ï¼Œä¸åŒ…æ‹¬å…¶æœ¬èº«å’Œå­è§†å›¾çš„å¤§å°å’Œä½ç½®ã€‚å’Œå¸ƒå±€çš„æ–¹æ³•ç±»ä¼¼ï¼Œæ˜¾ç¤ºä¹Ÿæœ‰è§¦å‘æ›´æ–°çš„æ–¹æ³•ï¼Œå®ƒä»¬ç”±ç³»ç»Ÿåœ¨æ£€æµ‹åˆ°æ›´æ–°æ—¶è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ç›´æ¥åˆ·æ–°ã€‚</p><p><strong>setNeedsDisplay()</strong></p><p>è¿™ä¸ªæ–¹æ³•ç±»ä¼¼äºå¸ƒå±€ä¸­çš„ <code>setNeedsLayout</code> ã€‚å®ƒä¼šç»™æœ‰å†…å®¹æ›´æ–°çš„è§†å›¾è®¾ç½®ä¸€ä¸ªå†…éƒ¨çš„æ ‡è®°ï¼Œä½†åœ¨è§†å›¾é‡ç»˜ä¹‹å‰å°±ä¼šè¿”å›ã€‚ç„¶ååœ¨ä¸‹ä¸€ä¸ª update cycle ä¸­ï¼Œç³»ç»Ÿä¼šéå†æ‰€æœ‰å·²æ ‡æ ‡è®°çš„è§†å›¾ï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„ <code>draw</code> æ–¹æ³•ã€‚</p><p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œåœ¨è§†å›¾ä¸­æ›´æ–°ä»»ä½• UI ç»„ä»¶éƒ½ä¼šæŠŠç›¸åº”çš„è§†å›¾æ ‡è®°ä¸ºâ€œdirtyâ€ï¼Œé€šè¿‡è®¾ç½®è§†å›¾â€œå†…éƒ¨æ›´æ–°æ ‡è®°â€ï¼Œåœ¨ä¸‹ä¸€æ¬¡ update cycle ä¸­å°±ä¼šé‡ç»˜ï¼Œè€Œä¸éœ€è¦æ˜¾å¼çš„ <code>setNeedsDisplay</code> è°ƒç”¨</p><h4 id="çº¦æŸï¼š"><a href="#çº¦æŸï¼š" class="headerlink" title="çº¦æŸï¼š"></a>çº¦æŸï¼š</h4><p><strong>updateConstraints()</strong></p><p>è¿™ä¸ªæ–¹æ³•ç”¨æ¥åœ¨è‡ªåŠ¨å¸ƒå±€ä¸­åŠ¨æ€æ”¹å˜è§†å›¾çº¦æŸã€‚å’Œå¸ƒå±€ä¸­çš„ <code>layoutSubviews()</code> æ–¹æ³•æˆ–è€…æ˜¾ç¤ºä¸­çš„ <code>draw</code> æ–¹æ³•ç±»ä¼¼ï¼Œ<code>updateConstraints()</code> åªåº”è¯¥è¢«é‡è½½ï¼Œ<strong>ç»ä¸è¦åœ¨ä»£ç ä¸­æ˜¾å¼åœ°è°ƒç”¨</strong>ã€‚é€šå¸¸ä½ åªåº”è¯¥åœ¨ <code>updateConstraints</code> æ–¹æ³•ä¸­å®ç°å¿…é¡»è¦æ›´æ–°çš„çº¦æŸã€‚</p><p><strong>setNeedsUpdateConstraints()</strong></p><p>è°ƒç”¨ <code>setNeedsUpdateConstraints()</code> ä¼šä¿è¯åœ¨ä¸‹ä¸€æ¬¡æ›´æ–°å‘¨æœŸä¸­æ›´æ–°çº¦æŸã€‚å®ƒé€šè¿‡æ ‡è®°â€œupdate constraintsâ€æ¥è§¦å‘ <code>updateConstraints()</code>ã€‚è¿™ä¸ªæ–¹æ³•å’Œ <code>setNeedsDisplay()</code> ä»¥åŠ <code>setNeedsLayout()</code> æ–¹æ³•çš„å·¥ä½œæœºåˆ¶ç±»ä¼¼ã€‚</p><p><strong>updateConstraintsIfNeeded()</strong></p><p>å¯¹äºä½¿ç”¨è‡ªåŠ¨å¸ƒå±€çš„è§†å›¾æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ <code>layoutIfNeeded</code> ç­‰ä»·ã€‚å®ƒä¼šæ£€æŸ¥ â€œupdate constraintsâ€æ ‡è®°ï¼ˆå¯ä»¥è¢« <code>setNeedsUpdateConstraints</code> æˆ–è€… <code>invalidateInstrinsicContentSize</code>æ–¹æ³•è‡ªåŠ¨è®¾ç½®ï¼‰ã€‚å¦‚æœå®ƒè®¤ä¸ºè¿™äº›çº¦æŸéœ€è¦è¢«æ›´æ–°ï¼Œå®ƒä¼šç«‹å³è§¦å‘ <code>updateConstraints()</code> ï¼Œ<strong>è€Œä¸ä¼šç­‰åˆ° RunLoop çš„æœ«å°¾ã€‚</strong></p><h3 id="UI-å¡é¡¿-åˆ—è¡¨å¡é¡¿ã€æ‰å¸§åŸç†"><a href="#UI-å¡é¡¿-åˆ—è¡¨å¡é¡¿ã€æ‰å¸§åŸç†" class="headerlink" title="UI å¡é¡¿,åˆ—è¡¨å¡é¡¿ã€æ‰å¸§åŸç†"></a>UI å¡é¡¿,åˆ—è¡¨å¡é¡¿ã€æ‰å¸§åŸç†</h3><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024849.png" alt="image-20190312140156990"></p><p>iOSçš„ <code>mainRunloop</code>æ˜¯ä¸€ä¸ª60fpsçš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´æ¯16.7ms(VSyncä¿¡å·æ—¶é—´)ä¼šç»˜åˆ¶ä¸€æ¬¡å±å¹•ï¼Œè¿™ä¸ªæ—¶é—´æ®µå†…è¦å®Œæˆviewçš„ç¼“å†²åŒºåˆ›å»ºï¼Œviewå†…å®¹çš„ç»˜åˆ¶ï¼ˆå¦‚æœé‡å†™äº†drawRectï¼‰ï¼Œè¿™äº›CPUçš„å·¥ä½œã€‚ç„¶åå°†è¿™ä¸ªç¼“å†²åŒºäº¤ç»™GPUæ¸²æŸ“ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆåŒ…æ‹¬å¤šä¸ªviewçš„æ‹¼æ¥(compositing)ï¼Œçº¹ç†çš„æ¸²æŸ“ï¼ˆTextureï¼‰ç­‰ï¼Œæœ€ç»ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç”»çš„æµç¨‹å›¾ã€‚ å› æ­¤ï¼Œå¦‚æœåœ¨16.7mså†…å®Œä¸æˆè¿™äº›æ“ä½œï¼Œæ¯”å¦‚ï¼ŒCPUåšäº†å¤ªå¤šçš„å·¥ä½œï¼Œæˆ–è€…viewå±‚æ¬¡è¿‡äºå¤šï¼Œå›¾ç‰‡è¿‡äºå¤§ï¼Œå¯¼è‡´GPUå‹åŠ›å¤ªå¤§ï¼Œå°±ä¼šå¯¼è‡´â€œå¡â€çš„ç°è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸¢å¸§.</p><blockquote><p>åœ¨è§„å®šçš„16.7mså†…ï¼Œåœ¨ä¸‹ä¸€ä¸ªVSyncä¿¡å·åˆ°æ¥ä¹‹å‰ï¼ŒCPUå’ŒGPUå¹¶æ²¡æœ‰å…±åŒå®Œæˆä¸‹ä¸€å¸§è§†é¢‘çš„åˆæˆï¼Œå°±ä¼šå‡ºç°æ‰å¸§ã€å¡é¡¿ã€‚</p></blockquote><h5 id="æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆæ€è·¯ï¼š"><a href="#æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆæ€è·¯ï¼š" class="headerlink" title="æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆæ€è·¯ï¼š"></a>æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆæ€è·¯ï¼š</h5><ul><li>CPUï¼š<ul><li>å¯¹è±¡çš„åˆ›å»ºã€è°ƒæ•´ã€é”€æ¯å¯ä»¥æ”¾åœ¨å­çº¿ç¨‹ä¸­å»åšASDKï¼›</li><li>é¢„æ’ç­ã€‚å¸ƒå±€è®¡ç®—ã€æ–‡æœ¬è®¡ç®—ç­‰äº‹å…ˆæ”¾åˆ°å­çº¿ç¨‹ä¸­å»åšï¼›</li><li>ä½¿ç”¨è½»é‡çº§å¯¹è±¡ï¼Œæ¯”å¦‚CALayerä»£æ›¿UIView</li><li>é¢„æ¸²æŸ“ã€‚æ–‡æœ¬ç­‰å¼‚æ­¥ç»˜åˆ¶ï¼Œå›¾ç‰‡ç¼–è§£ç ç­‰ã€‚</li><li>æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°é‡</li><li>å‡å°‘é‡å¤è®¡ç®—å¸ƒå±€ï¼Œå‡å°‘ä¿®æ”¹frameç­‰</li><li>autolayoutæ¯”frameæ›´æ¶ˆè€—èµ„æº</li><li>å¯ä»¥è®©å›¾ç‰‡çš„sizeè·Ÿframeä¸€è‡´</li></ul></li><li>GPUï¼š<ul><li>çº¹ç†æ¸²æŸ“ã€‚é¿å…ç¦»å±æ¸²æŸ“</li><li>è§†å›¾æ··åˆã€‚å‡å°‘è§†å›¾å±‚çº§çš„å¤æ‚æ€§ï¼Œå‡å°‘é€æ˜è§†å›¾ï¼›ä¸é€æ˜çš„opaqueè®¾ç½®ä¸ºYES</li><li>GPUèƒ½å¤„ç†çš„æœ€å¤§çº¹ç†æ˜¯4096 * 4096ï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸å°±ä¼šè°ƒç”¨CPUè¿›è¡Œèµ„æºå¤„ç†ï¼Œæ‰€ä»¥çº¹ç†å°½é‡ä¸è¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸</li></ul></li></ul><h3 id="UIViewçš„ç»˜åˆ¶åŸç†"><a href="#UIViewçš„ç»˜åˆ¶åŸç†" class="headerlink" title="UIViewçš„ç»˜åˆ¶åŸç†"></a>UIViewçš„ç»˜åˆ¶åŸç†</h3><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024854.png" alt="image-20190312141642996"></p><p><code>[UIView setNeedsDisplay]</code> å¹¶æ²¡æœ‰å‘ç”Ÿå½“å‰è§†å›¾ç«‹å³ç»˜åˆ¶å·¥ä½œ,æ‰“ä¸Šéœ€è¦é‡ç»˜çš„è„æ ‡è®°ï¼Œæœ€åæ˜¯åœ¨æŸä¸ªæ—¶æœºå®Œæˆ</p><p><code>[UIView setLayoutIfNeed]</code> ç«‹å³é‡æ–°å¸ƒå±€è§†å›¾(ä¸‹ä¸€ä¸ªRunloop)</p><p><code>[view layouIfNeeded]</code> å½“å‰RunLoopä¼‘çœ å‰æ›´æ–°</p><p>å½“æˆ‘ä»¬è°ƒç”¨UIViewçš„<code>setNeedsDisplay</code>çš„æ–¹æ³•æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>layer</code>çš„åŒåæ–¹æ³•ï¼Œç›¸å½“äºåœ¨å½“å‰<code>layer</code>æ‰“ä¸Šç»˜åˆ¶æ ‡è®°ï¼Œåœ¨å½“å‰<code>runloop</code>å°†è¦ç»“æŸçš„æ—¶å€™ï¼Œæ‰ä¼šè°ƒç”¨CALayerçš„<code>display</code>æ–¹æ³•è¿›å…¥åˆ°çœŸæ­£çš„ç»˜åˆ¶å½“ä¸­ã€‚</p><p>CALayerçš„<code>display</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­layerçš„delegateæ–¹æ³•<code>displayLayerï¼š</code>æ˜¯å¦å®ç°ï¼Œå¦‚æœä»£ç†æ²¡æœ‰å“åº”è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™è¿›å…¥åˆ°ç³»ç»Ÿç»˜åˆ¶æµç¨‹ï¼›å¦‚æœä»£ç†å“åº”äº†è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™è¿›å…¥åˆ°å¼‚æ­¥ç»˜åˆ¶æµç¨‹</p><h3 id="ç³»ç»Ÿç»˜åˆ¶æµç¨‹"><a href="#ç³»ç»Ÿç»˜åˆ¶æµç¨‹" class="headerlink" title="ç³»ç»Ÿç»˜åˆ¶æµç¨‹"></a>ç³»ç»Ÿç»˜åˆ¶æµç¨‹</h3><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024857.png" alt="image-20190312142115333"></p><p>åœ¨CALayerå†…éƒ¨ï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªbackingStoreï¼ˆå¯ä»¥ç†è§£ä¸ºCGContextRefï¼ŒdrawRectä¸­å–åˆ°çš„currentRefå°±æ˜¯è¿™ä¸ªä¸œè¥¿ï¼‰ï¼Œç„¶ålayerå›åˆ¤æ–­æ˜¯å¦æœ‰delegateï¼Œå¦‚æœæ²¡æœ‰ä»£ç†ï¼Œå°±è°ƒç”¨CALayerçš„<code>drawInContextï¼š</code>æ–¹æ³•ï¼›å¦‚æœæœ‰ä»£ç†ï¼Œåˆ™è°ƒç”¨layerä»£ç†çš„<code>drawLayer:inContext:</code>æ–¹æ³•ï¼Œè¿™ä¸€æ­¥å‘ç”Ÿåœ¨ç³»ç»Ÿå†…éƒ¨ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´ç»™ä¸æˆ‘ä»¬å›è°ƒä¸€ä¸ªç†Ÿæ‚‰çš„UIViewçš„<code>drawRectï¼š</code>æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯åœ¨ç³»ç»Ÿå†…éƒ¨çš„ç»˜åˆ¶ä¹‹ä¸Šï¼Œå…è®¸æˆ‘ä»¬å†åšä¸€äº›é¢å¤–çš„ç»˜åˆ¶ã€‚æœ€åCALayeræŠŠbackting storeï¼ˆä½å›¾ï¼‰ä¼ ç»™GPUã€‚</p><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-07-23-134925.jpg" alt="15420320733034"></p><ol><li>é¦–å…ˆä¸€ä¸ªè§†å›¾ç”± CPU è¿›è¡Œ Frame å¸ƒå±€ï¼Œå‡†å¤‡è§†å›¾å’Œå›¾å±‚çš„å±‚çº§å…³ç³»ï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰é‡å†™ <code>drawRect:</code> æˆ– <code>drawLayer:inContext:</code>æ–¹æ³•ï¼Œ<strong>æ³¨æ„ï¼šå¦‚æœæœ‰é‡å†™çš„è¯ï¼Œè¿™é‡Œçš„æ¸²æŸ“æ˜¯ä¼šå ç”¨CPUè¿›è¡Œå¤„ç†çš„ã€‚</strong></li><li>CPU ä¼šå°†å¤„ç†è§†å›¾å’Œå›¾å±‚çš„å±‚çº§å…³ç³»æ‰“åŒ…ï¼Œé€šè¿‡ IPCï¼ˆå†…éƒ¨å¤„ç†é€šä¿¡ï¼‰é€šé“æäº¤ç»™æ¸²æŸ“æœåŠ¡ï¼Œæ¸²æŸ“æœåŠ¡ç”± OpenGL ES å’Œ GPU ç»„æˆã€‚</li><li>æ¸²æŸ“æœåŠ¡é¦–å…ˆå°†å›¾å±‚æ•°æ®äº¤ç»™ OpenGL ES è¿›è¡Œçº¹ç†ç”Ÿæˆå’Œç€è‰²ã€‚ç”Ÿæˆå‰åå¸§ç¼“å­˜ï¼Œå†æ ¹æ®æ˜¾ç¤ºç¡¬ä»¶çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬ä»¥è®¾å¤‡çš„Vsyncä¿¡å·å’ŒCADisplayLinkä¸ºæ ‡å‡†ï¼Œè¿›è¡Œå‰åå¸§ç¼“å­˜çš„åˆ‡æ¢ã€‚</li><li>æœ€åï¼Œå°†æœ€ç»ˆè¦æ˜¾ç¤ºåœ¨ç”»é¢ä¸Šçš„åå¸§ç¼“å­˜äº¤ç»™ GPUï¼Œè¿›è¡Œé‡‡é›†å›¾ç‰‡å’Œå½¢çŠ¶ï¼Œè¿è¡Œå˜æ¢ï¼Œåº”ç”¨æ–‡ç†å’Œæ··åˆã€‚æœ€ç»ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</li></ol><blockquote><p>åœ¨iOSä¸­æ˜¯åŒç¼“å†²æœºåˆ¶ï¼Œæœ‰å‰å¸§ç¼“å­˜ã€åå¸§ç¼“å­˜ï¼Œå³GPUä¼šé¢„å…ˆæ¸²æŸ“å¥½ä¸€å¸§æ”¾å…¥ä¸€ä¸ªç¼“å†²åŒºå†…ï¼ˆå‰å¸§ç¼“å­˜ï¼‰ï¼Œè®©è§†é¢‘æ§åˆ¶å™¨è¯»å–ï¼Œå½“ä¸‹ä¸€å¸§æ¸²æŸ“å¥½åï¼ŒGPUä¼šç›´æ¥æŠŠè§†é¢‘æ§åˆ¶å™¨çš„æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒä¸ªç¼“å†²å™¨ï¼ˆåå¸§ç¼“å­˜ï¼‰ã€‚å½“ä½ è§†é¢‘æ§åˆ¶å™¨å·²ç»è¯»å®Œä¸€å¸§ï¼Œå‡†å¤‡è¯»ä¸‹ä¸€å¸§çš„æ—¶å€™ï¼ŒGPUä¼šç­‰å¾…æ˜¾ç¤ºå™¨çš„VSyncä¿¡å·å‘å‡ºåï¼Œå‰å¸§ç¼“å­˜å’Œåå¸§ç¼“å­˜ä¼šç¬é—´åˆ‡æ¢ï¼Œåå¸§ç¼“å­˜ä¼šå˜æˆæ–°çš„å‰å¸§ç¼“å­˜ï¼ŒåŒæ—¶æ—§çš„å‰å¸§ç¼“å­˜ä¼šå˜æˆæ–°çš„åå¸§ç¼“å­˜ã€‚</p></blockquote><h3 id="å¼‚æ­¥ç»˜åˆ¶æµç¨‹"><a href="#å¼‚æ­¥ç»˜åˆ¶æµç¨‹" class="headerlink" title="å¼‚æ­¥ç»˜åˆ¶æµç¨‹"></a>å¼‚æ­¥ç»˜åˆ¶æµç¨‹</h3><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024902.png" alt="image-20190312142425272"></p><p>layerçš„delegateå¦‚æœå®ç°äº†<code>displayLayer:</code>æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥åˆ°å¼‚æ­¥ç»˜åˆ¶çš„æµç¨‹ã€‚åœ¨å¼‚æ­¥ç»˜åˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä»£ç†æ¥ç”Ÿæˆå¯¹åº”çš„bitmapä½å›¾æ–‡ä»¶ï¼Œå¹¶æŠŠæ­¤bitmapä½œä¸ºlayerçš„contentså±æ€§</p><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2019-03-22-024910.png" alt="image-20190312142514299"></p><h3 id="drawRectæ–¹æ³•å†…ä¸ºä½•ç¬¬ä¸€è¡Œä»£ç æ€»è¦è·å–å›¾å½¢çš„ä¸Šä¸‹æ–‡"><a href="#drawRectæ–¹æ³•å†…ä¸ºä½•ç¬¬ä¸€è¡Œä»£ç æ€»è¦è·å–å›¾å½¢çš„ä¸Šä¸‹æ–‡" class="headerlink" title="drawRectæ–¹æ³•å†…ä¸ºä½•ç¬¬ä¸€è¡Œä»£ç æ€»è¦è·å–å›¾å½¢çš„ä¸Šä¸‹æ–‡"></a>drawRectæ–¹æ³•å†…ä¸ºä½•ç¬¬ä¸€è¡Œä»£ç æ€»è¦è·å–å›¾å½¢çš„ä¸Šä¸‹æ–‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">CGContextRef con = UIGraphicsGetCurrentContext();<br></code></pre></td></tr></table></figure><p><img src="http://sylarimage.oss-cn-shenzhen.aliyuncs.com/2020-03-04-082448.jpg" alt="img"></p><p>æ¯ä¸€ä¸ªUIViewéƒ½æœ‰ä¸€ä¸ªlayerï¼Œæ¯ä¸€ä¸ªlayeréƒ½æœ‰ä¸ªcontentï¼Œè¿™ä¸ªcontentæŒ‡å‘çš„æ˜¯ä¸€å—ç¼“å­˜ï¼Œå«åšbacking store å½“UIViewè¢«ç»˜åˆ¶æ—¶ï¼ˆä» CA::Transaction::commit:ä»¥åï¼‰ï¼ŒCPUæ‰§è¡ŒdrawRectï¼Œé€šè¿‡contextå°†æ•°æ®å†™å…¥backing store å½“backing storeå†™å®Œåï¼Œé€šè¿‡render serveräº¤ç»™GPUå»æ¸²æŸ“ï¼Œå°†backing storeä¸­çš„bitmapæ•°æ®æ˜¾ç¤ºåœ¨å±å¹•ä¸Š æ‰€ä»¥åœ¨ drawRect æ–¹æ³•ä¸­ è¦é¦–å…ˆè·å– context</p><h3 id="ä¸ºä»€ä¹ˆè¦å°†å›¾åƒæ¸²æŸ“å’Œäº‹ä»¶å“åº”è¿™ä¸¤ä¸ªåŠŸèƒ½åˆ†å¼€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦å°†å›¾åƒæ¸²æŸ“å’Œäº‹ä»¶å“åº”è¿™ä¸¤ä¸ªåŠŸèƒ½åˆ†å¼€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å°†å›¾åƒæ¸²æŸ“å’Œäº‹ä»¶å“åº”è¿™ä¸¤ä¸ªåŠŸèƒ½åˆ†å¼€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦å°†å›¾åƒæ¸²æŸ“å’Œäº‹ä»¶å“åº”è¿™ä¸¤ä¸ªåŠŸèƒ½åˆ†å¼€ï¼Ÿ</h3><p>å› ä¸º<code>CALayer</code>å±äº<code>QuartzCore</code>æ¡†æ¶ï¼Œ<code>UIView</code>å±äº<code>UIKit</code>æ¡†æ¶ï¼Œ</p><p><code>QuartzCore</code> æ¡†æ¶æ˜¯å¯ä»¥è·¨å¹³å°ä½¿ç”¨çš„ï¼Œä½†æ˜¯<code>UIKit</code>æ¡†æ¶åªèƒ½åœ¨iOSä¸­ï¼Œåœ¨MacOså½“ä¸­è§¦æ‘¸æ˜¯é¼ æ ‡é”®ç›˜ï¼Œè€ŒiOSæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œéµå¾ªè®¾è®¡åŸåˆ™ä¸­çš„å•ä¸€èŒè´£ã€‚</p><h3 id="CALayerä¸ºä»€ä¹ˆå¯ä»¥å‘ˆç°å¯è§†åŒ–å†…å®¹å‘¢ï¼Ÿ"><a href="#CALayerä¸ºä»€ä¹ˆå¯ä»¥å‘ˆç°å¯è§†åŒ–å†…å®¹å‘¢ï¼Ÿ" class="headerlink" title="CALayerä¸ºä»€ä¹ˆå¯ä»¥å‘ˆç°å¯è§†åŒ–å†…å®¹å‘¢ï¼Ÿ"></a>CALayerä¸ºä»€ä¹ˆå¯ä»¥å‘ˆç°å¯è§†åŒ–å†…å®¹å‘¢ï¼Ÿ</h3><p>CALayeråŒ…å«ä¸€ä¸ª<code>contents</code>å±æ€§,<code>CALayer</code> ä¸­çš„ <code>contents</code> å±æ€§ä¿å­˜äº†ç”±è®¾å¤‡æ¸²æŸ“æµæ°´çº¿æ¸²æŸ“å¥½çš„ä½å›¾ <code>bitmap</code>ï¼ˆé€šå¸¸ä¹Ÿè¢«ç§°ä¸º <code>backing store</code>ï¼‰ï¼Œè€Œå½“è®¾å¤‡å±å¹•è¿›è¡Œåˆ·æ–°æ—¶ï¼Œä¼šä» <code>CALayer</code> ä¸­è¯»å–ç”Ÿæˆå¥½çš„ <code>bitmap</code>ï¼Œè¿›è€Œå‘ˆç°åˆ°å±å¹•ä¸Šã€‚CALayerçš„<code>contents</code>çš„å€¼å¿…é¡»æ˜¯<code>CGImage</code>ã€‚</p><h3 id="ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªView-å…¶åº•å±‚åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ"><a href="#ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªView-å…¶åº•å±‚åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ" class="headerlink" title="ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªView,å…¶åº•å±‚åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ"></a>ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªView,å…¶åº•å±‚åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ</h3><p><code>Core Animation</code> ä¼šåœ¨APPå¯åŠ¨æ—¶åƒ <code>Runloop</code> æ³¨å†Œä¸€ä¸ª <code>Observer</code>ï¼Œå½“äº‹ä»¶åˆ°æ¥çš„æ—¶å€™ï¼Œ<code>Runloop</code> ä¼šè¢«å”¤é†’å¤„ç†ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼ˆUIView çš„åˆ›å»ºï¼Œä¿®æ”¹ï¼‰ï¼Œå°†UIä¿¡æ¯æäº¤ç»™<code>Render Server</code>,ç„¶åä¼šç­‰å¾…<code>VSync</code>ä¿¡å·çš„åˆ°æ¥ï¼Œç„¶åä¼šé€šè¿‡<code>Metal</code>æˆ–è€…<code>OpenGLES</code>åšä¸€äº›ç»˜åˆ¶æ“ä½œï¼Œç„¶åæŠŠå¤„ç†å®Œçš„æ•°æ®ï¼Œçº¹ç†ï¼Œé¡¶ç‚¹ï¼Œç€è‰²å™¨ç­‰æäº¤ç»™<code>GPU</code>ï¼Œåœ¨ä¸‹ä¸€ä¸ª<code>VSync</code>ä¿¡å·åˆ°æ¥çš„æ—¶å€™ï¼Œè§†é¢‘æ§åˆ¶å™¨ç­‰è¯»å–å¸§ç¼“å†²åŒºçš„æ•°æ®æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </p><h3 id="ç•Œé¢æ‰å¸§æ˜¯å› ä¸ºä»€ä¹ˆå¼•èµ·çš„ï¼Ÿ"><a href="#ç•Œé¢æ‰å¸§æ˜¯å› ä¸ºä»€ä¹ˆå¼•èµ·çš„ï¼Ÿ" class="headerlink" title="ç•Œé¢æ‰å¸§æ˜¯å› ä¸ºä»€ä¹ˆå¼•èµ·çš„ï¼Ÿ"></a>ç•Œé¢æ‰å¸§æ˜¯å› ä¸ºä»€ä¹ˆå¼•èµ·çš„ï¼Ÿ</h3><p>æ‰å¸§æ˜¯å› ä¸ºå½“åœ¨ä¸€ä¸ª<code>Vsync</code>å‘¨æœŸä¸­ï¼Œ<code>CPU</code>æˆ–è€…<code>GPU</code>æ²¡æœ‰å®Œæˆå†…å®¹æäº¤ï¼Œé‚£ä¹ˆè¿™ä¸€å¸§å°±ä¼šè¢«åºŸå¼ƒæ‰ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ª<code>Vsync</code>çš„åˆ°æ¥ï¼Œè€Œæ˜¾ç¤ºå±è¿˜ä¼šä¿æŒä¹‹å‰çš„å†…å®¹ä¸å˜ï¼Œè¿™ä¹Ÿæ˜¯ç•Œé¢å¡é¡¿çš„åŸå› ã€‚</p><h3 id="CoreAnimationæ¸²æŸ“æµç¨‹ï¼Ÿ"><a href="#CoreAnimationæ¸²æŸ“æµç¨‹ï¼Ÿ" class="headerlink" title="CoreAnimationæ¸²æŸ“æµç¨‹ï¼Ÿ"></a>CoreAnimationæ¸²æŸ“æµç¨‹ï¼Ÿ</h3><p>é¦–å…ˆæ”¶åˆ°äº‹ä»¶çš„å¤„ç†ï¼Œä¾‹å¦‚å¸ƒå±€æ”¹å˜</p><p>é€šè¿‡CPUå®Œæˆæ˜¾ç¤ºå†…å®¹è®¡ç®—ï¼Œå¯¹APPå›¾å±‚è¿›è¡Œæ‰“åŒ…ï¼Œåœ¨ä¸‹ä¸€æ¬¡runloopæ—¶å°†æè¿°å¥½çš„ UI ä¿¡æ¯ä»¥ <code>IPC</code> çš„å½¢å¼æä¾›ç»™<strong>ç³»ç»Ÿå¸¸é©»çš„ UI ç»˜åˆ¶è¿›ç¨‹</strong>æ¸²æŸ“æœåŠ¡RenderServer, </p><p>å°†æ”¶åˆ°çš„æ‰“åŒ…è¿›è¡Œè§£ç ï¼Œæ‰§è¡Œmetalç›¸å…³ç¨‹åºï¼Œè°ƒç”¨GPU</p><p>GPUå®Œæˆå¯¹å›¾åƒçš„æ¸²æŸ“ï¼Œæœ€åæ˜¾ç¤ºåˆ°å±å¹•ä¸Š</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzj6f3n9o3j20xc0hq406.jpg"></p><p><strong>ä½†æ˜¯å¦‚æœé‡å†™äº† <code>drawRect:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç›´æ¥è°ƒç”¨ <code>Core Graphics</code> ç»˜åˆ¶æ–¹æ³•å¾—åˆ° <code>bitmap</code> æ•°æ®ï¼ŒåŒæ—¶ç³»ç»Ÿä¼šé¢å¤–ç”³è¯·ä¸€å—å†…å­˜ï¼Œç”¨äºæš‚å­˜ç»˜åˆ¶å¥½çš„ <code>bitmap</code>ã€‚</strong></p><p>ç”±äºé‡å†™äº† <code>drawRect:</code> æ–¹æ³•ï¼Œå¯¼è‡´ç»˜åˆ¶è¿‡ç¨‹ä» GPU è½¬ç§»åˆ°äº† CPUï¼Œè¿™å°±å¯¼è‡´äº†ä¸€å®šçš„æ•ˆç‡æŸå¤±ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šé¢å¤–ä½¿ç”¨ CPU å’Œå†…å­˜ï¼Œå› æ­¤éœ€è¦é«˜æ•ˆç»˜åˆ¶ï¼Œå¦åˆ™å®¹æ˜“é€ æˆ CPU å¡é¡¿æˆ–è€…å†…å­˜çˆ†ç‚¸ã€‚</p><h3 id="ç¦»å±æ¸²æŸ“æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ç¦»å±æ¸²æŸ“æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ç¦»å±æ¸²æŸ“æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ç¦»å±æ¸²æŸ“æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æˆ‘ä»¬çŸ¥é“<code>GPU</code>ä¼šå°†æ¸²æŸ“å®Œæˆåçš„ç»“æœæ”¾å…¥<code>Frame Buffer</code>å½“ä¸­ï¼Œä½†æ˜¯å¦‚æœ<code>GPU</code>æ— æ³•ä¸€æ¬¡å®Œæˆæ¸²æŸ“å·¥ä½œï¼Œéœ€è¦ä¸¤ï¼Œè¿™æ—¶å°±éœ€è¦ä¸€ä¸ªé¢å¤–çš„è½½ä½“æ¥ä¿å­˜ç¬¬ä¸€æ¬¡çš„ç»“æœï¼Œè€Œè¿™ä¸ªè½½ä½“ä¹Ÿå°±æ˜¯ç¦»å±æ¸²æŸ“ç¼“å†²åŒºã€‚</p><p>ç¦»å±æ¸²æŸ“ä¼šåˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼Œå¢åŠ é¢å¤–çš„ç©ºé—´ï¼Œå¤§é‡çš„ç¦»å±æ¸²æŸ“å¯èƒ½é€ æˆå†…å­˜çš„è¿‡å¤§å‹åŠ›ã€‚</p><p>ç¦»å±æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¿›è¡Œä¸¤æ¬¡ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œå…ˆåˆ‡æ¢åˆ°å±å¹•å¤–ï¼Œç¦»å±æ¸²æŸ“å®Œæˆåå†åˆ‡å›å½“å‰å±å¹•ã€‚</p><h3 id="æ‰€æœ‰çš„ç¦»å±æ¸²æŸ“éƒ½æ˜¯åçš„å—ï¼Ÿ"><a href="#æ‰€æœ‰çš„ç¦»å±æ¸²æŸ“éƒ½æ˜¯åçš„å—ï¼Ÿ" class="headerlink" title="æ‰€æœ‰çš„ç¦»å±æ¸²æŸ“éƒ½æ˜¯åçš„å—ï¼Ÿ"></a>æ‰€æœ‰çš„ç¦»å±æ¸²æŸ“éƒ½æ˜¯åçš„å—ï¼Ÿ</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¼€å¯<code>CALayer</code>çš„<code>shouldRasterize</code>å±æ€§å»è§¦å‘ç¦»å±æ¸²æŸ“ã€‚å¼€å¯ä¹‹åï¼Œ<code>Render Server</code> ä¼šå¼ºåˆ¶å°† <code>CALayer çš„æ¸²æŸ“ä½å›¾ç»“æœ</code>bitmap&#96; ä¿å­˜ä¸‹æ¥ï¼Œè¿™æ ·ä¸‹æ¬¡å†éœ€è¦æ¸²æŸ“æ—¶å°±å¯ä»¥ç›´æ¥å¤ç”¨ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚</p><p>ä¿å­˜çš„ <code>bitmap</code> åŒ…å« <code>layer</code> çš„ <code>subLayer</code>ã€åœ†è§’ã€é˜´å½±ã€ç»„é€æ˜åº¦ <code>group opacity</code> ç­‰ï¼Œæ‰€ä»¥å¦‚æœ <code>layer</code> çš„æ„æˆåŒ…å«ä¸Šè¿°å‡ ç§å…ƒç´ ï¼Œç»“æ„å¤æ‚ä¸”éœ€è¦åå¤åˆ©ç”¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘æ‰“å¼€å…‰æ …åŒ–ã€‚<strong>å…¶ä¸»æ—¨åœ¨äºé™ä½æ€§èƒ½æŸå¤±ï¼Œä½†æ€»æ˜¯è‡³å°‘ä¼šè§¦å‘ä¸€æ¬¡ç¦»å±æ¸²æŸ“ã€‚</strong></p><blockquote><p>åœ†è§’ã€é˜´å½±ã€ç»„é€æ˜åº¦ç­‰ä¼šç”±ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ç¦»å±æ¸²æŸ“ï¼Œé‚£ä¹ˆæ‰“å¼€å…‰æ …åŒ–å°±å¯ä»¥èŠ‚çº¦ç¬¬äºŒæ¬¡åŠä»¥åçš„æ¸²æŸ“æ—¶é—´ã€‚è€Œå¤šå±‚ subLayer çš„æƒ…å†µç”±äºä¸ä¼šè‡ªåŠ¨è§¦å‘ç¦»å±æ¸²æŸ“ï¼Œæ‰€ä»¥ç›¸æ¯”ä¹‹ä¸‹ä¼šå¤šèŠ±è´¹ç¬¬ä¸€æ¬¡ç¦»å±æ¸²æŸ“çš„æ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥èŠ‚çº¦åç»­çš„é‡å¤æ¸²æŸ“çš„å¼€é”€ã€‚</p></blockquote><h3 id="å“ªäº›æƒ…å†µä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ"><a href="#å“ªäº›æƒ…å†µä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ" class="headerlink" title="å“ªäº›æƒ…å†µä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ"></a>å“ªäº›æƒ…å†µä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ</h3><ul><li>ä½¿ç”¨äº† <code>mask</code> çš„ <code>layer (layer.mask)</code>ï¼›</li><li>æ·»åŠ äº†æŠ•å½±çš„<code> layer (layer.shadow*ï¼Œè¡¨ç¤ºç›¸å…³çš„ shadow å¼€å¤´çš„å±æ€§)</code></li><li>è®¾ç½®äº†ç»„é€æ˜åº¦ä¸º YESï¼Œå¹¶ä¸”é€æ˜åº¦ä¸ä¸º 1 çš„<code>layer (layer.allowsGroupOpacity/layer.opacity)</code></li><li>é‡‡ç”¨äº†å…‰æ …åŒ–çš„ <code>layer (layer.shouldRasterize)</code></li><li>ç»˜åˆ¶äº†æ–‡å­—çš„ <code>layer (UILabel, CATextLayer, Core Text ç­‰)</code></li><li>éœ€è¦è¿›è¡Œè£å‰ªçš„<code> layer (layer.masksToBounds / view.clipsToBounds)</code></li></ul><p>æ€»ç»“ä¸€ä¸‹ï¼ŒiOS 9 ä¹‹ååœ†è§’é€ æˆç¦»å±æ¸²æŸ“çš„æ¡ä»¶åŒ…æ‹¬ï¼š</p><ul><li>åœ†è§’</li><li>è£å‰ª</li><li><code>layer</code> çš„<code>contents</code>ä¸ä¸º <code>nil</code></li><li>è®¾ç½®äº†èƒŒæ™¯è‰² &#x2F; è¾¹æ¡† &#x2F; å…¶ä»–æœ‰å›¾åƒå†…å®¹çš„å›¾å±‚</li></ul><h3 id="çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†"><a href="#çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†" class="headerlink" title="çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†"></a>çŸ¥è¯†ç‚¹é—®é¢˜æ¢³ç†</h3><ul><li><p>å›¾åƒæ˜¾ç¤ºçš„åŸç†</p></li><li><p>layoutSubviews()&#x2F;setNeedsLayout()&#x2F;layoutIfNeeded()ä¸‰è€…ä¹‹é—´çš„åŒºåˆ«ï¼Ÿ</p></li><li><p>setNeedsDisplay()æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p></li><li><p>ç•Œé¢æ‰å¸§æ˜¯å› ä¸ºä»€ä¹ˆå¼•èµ·çš„ï¼Ÿ</p></li><li><p>ç¦»å±æ¸²æŸ“æ˜¯ä»€ä¹ˆ?æ‰€æœ‰çš„ç¦»å±æ¸²æŸ“éƒ½æ˜¯åçš„å—ï¼Ÿå“ªäº›æƒ…å†µä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ</p></li><li><p>å¼‚æ­¥ç»˜åˆ¶çš„æµç¨‹</p></li><li><p>drawRectæ–¹æ³•åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Ÿ</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-Runloop</title>
    <link href="/2021/03/01/iOS-Runloop/"/>
    <url>/2021/03/01/iOS-Runloop/</url>
    
    <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯runloop"><a href="#ä»€ä¹ˆæ˜¯runloop" class="headerlink" title="ä»€ä¹ˆæ˜¯runloop"></a>ä»€ä¹ˆæ˜¯runloop</h3><ul><li>Run loopsæ˜¯çº¿ç¨‹ç›¸å…³çš„çš„åŸºç¡€æ¡†æ¶çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ªrunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ï¼Œç”¨æ¥ä¸åœçš„è°ƒåº¦å·¥ä½œä»¥åŠå¤„ç†è¾“å…¥äº‹ä»¶ã€‚å…¶å®å†…éƒ¨å°±æ˜¯doï¼whileå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯å†…éƒ¨ä¸æ–­åœ°å¤„ç†å„ç§ä»»åŠ¡ï¼ˆæ¯” å¦‚Sourceï¼ŒTimerï¼ŒObserverï¼‰ã€‚ä½¿ç”¨runloopçš„ç›®çš„æ˜¯è®©ä½ çš„çº¿ç¨‹åœ¨æœ‰å·¥ä½œçš„æ—¶å€™å¿™äºå·¥ä½œï¼Œè€Œæ²¡å·¥ä½œçš„æ—¶å€™å¤„äºä¼‘çœ çŠ¶æ€ã€‚</li></ul><h3 id="runloopå’Œçº¿ç¨‹çš„å…³ç³»"><a href="#runloopå’Œçº¿ç¨‹çš„å…³ç³»" class="headerlink" title="runloopå’Œçº¿ç¨‹çš„å…³ç³»"></a>runloopå’Œçº¿ç¨‹çš„å…³ç³»</h3><ul><li>çº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚</li><li>å­çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚</li><li>å­çº¿ç¨‹ä¸­ï¼ŒRunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚</li><li>ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚</li></ul><h3 id="runloopçš„æ¥å£"><a href="#runloopçš„æ¥å£" class="headerlink" title="runloopçš„æ¥å£"></a>runloopçš„æ¥å£</h3><ul><li>CFRunLoopRef<ul><li>ä¸€ä¸ª RunLoop åŒ…å«è‹¥å¹²ä¸ª Modeï¼Œæ¯ä¸ª Mode åˆåŒ…å«è‹¥å¹²ä¸ª Source&#x2F;Timer&#x2F;Observerã€‚æ¯æ¬¡è°ƒç”¨ RunLoop çš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ª Modeï¼Œè¿™ä¸ªModeè¢«ç§°ä½œ CurrentModeã€‚å¦‚æœéœ€è¦åˆ‡æ¢ Modeï¼Œåªèƒ½é€€å‡º Loopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ª Mode è¿›å…¥ã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„ Source&#x2F;Timer&#x2F;Observerï¼Œè®©å…¶äº’ä¸å½±å“</li></ul></li><li>CFRunLoopModeRef</li><li>CFRunLoopSourceRef<ul><li>CFRunLoopSourceRef æ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚Sourceæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šSource0 å’Œ Source1ã€‚<ul><li>Source0 åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨ CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ª Source æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ CFRunLoopWakeUp(runloop) æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</li><li>Source1 åŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ã€‚è¿™ç§ Source èƒ½ä¸»åŠ¨å”¤é†’ RunLoop çš„çº¿ç¨‹ï¼Œå…¶åŸç†åœ¨ä¸‹é¢ä¼šè®²åˆ°ã€‚</li></ul></li></ul></li><li>CFRunLoopTimerRef<ul><li>CFRunLoopTimerRef æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼Œå®ƒå’Œ NSTimer æ˜¯toll-free bridged çš„ï¼Œå¯ä»¥æ··ç”¨ã€‚å…¶åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ã€‚å½“å…¶åŠ å…¥åˆ° RunLoop æ—¶ï¼ŒRunLoopä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoopä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒã€‚</li></ul></li><li>CFRunLoopObserverRef<ul><li>CFRunLoopObserverRef æ˜¯è§‚å¯Ÿè€…ï¼Œæ¯ä¸ª Observer éƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥å—åˆ°è¿™ä¸ªå˜åŒ–ã€‚</li></ul></li></ul><h3 id="runloopçš„mode"><a href="#runloopçš„mode" class="headerlink" title="runloopçš„mode"></a>runloopçš„mode</h3><ul><li>kCFRunLoopDefaultMode&#x2F;NSDefaultRunLoopMode<ul><li>Appçš„é»˜è®¤ Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª Mode ä¸‹è¿è¡Œçš„ã€‚</li></ul></li><li>UITrackingRunLoopMode<ul><li>ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“ã€‚</li></ul></li><li>UIInitializationRunLoopMode<ul><li>åœ¨åˆšå¯åŠ¨Appæ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ªModeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨</li></ul></li><li>GSEventReceiveRunLoopMode<ul><li>æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°</li></ul></li><li>kCFRunLoopCommonModes&#x2F;NSRunLoopCommonModes<ul><li>ç»„åˆçŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ä¸ªå ä½çš„ Modeï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚</li></ul></li></ul><h3 id="runloopå†…éƒ¨é€»è¾‘"><a href="#runloopå†…éƒ¨é€»è¾‘" class="headerlink" title="runloopå†…éƒ¨é€»è¾‘"></a>runloopå†…éƒ¨é€»è¾‘</h3><p><img src="http://blog.qiji.tech/wp-content/uploads/2016/04/RunLoop_1.png" alt="image"></p><ul><li>1ã€é€šçŸ¥Observerï¼šå³å°†è¿›å…¥Loop</li><li>2ã€é€šçŸ¥Observerï¼šå°†è¦å¤„ç†Timer</li><li>3ã€é€šçŸ¥Observerï¼šå°†è¦å¤„ç†Source0</li><li>4ã€å¤„ç†Source0</li><li>5ã€å¦‚æœæœ‰Source1ï¼Œè·³åˆ°ç¬¬9æ­¥</li><li>6ã€é€šçŸ¥Observerï¼šçº¿ç¨‹å³å°†ä¼‘çœ </li><li>7ã€ä¼‘çœ ï¼Œç­‰å¾…å”¤é†’</li><li>8ã€é€šçŸ¥Observerï¼šçº¿ç¨‹åˆšè¢«å”¤é†’</li><li>9ã€å¤„ç†å”¤é†’æ—¶æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œä¹‹åè·³å›2</li><li>10ã€é€šçŸ¥Observerï¼šå³å°†é€€å‡ºLoop</li></ul><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs scss">&#123;<br>    <span class="hljs-comment">/// 1. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥RunLoop</span><br>    <span class="hljs-comment">/// æ­¤å¤„æœ‰Observerä¼šåˆ›å»ºAutoreleasePool: _objc_autoreleasePoolPush();</span><br>    <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopEntry);<br>    do &#123;<br> <br>        <span class="hljs-comment">/// 2. é€šçŸ¥ Observers: å³å°†è§¦å‘ Timer å›è°ƒã€‚</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeTimers);<br>        <span class="hljs-comment">/// 3. é€šçŸ¥ Observers: å³å°†è§¦å‘ Source (éåŸºäºportçš„,Source0) å›è°ƒã€‚</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeSources);<br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span>(block);<br> <br>        <span class="hljs-comment">/// 4. è§¦å‘ Source0 (éåŸºäºportçš„) å›è°ƒã€‚</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</span>(source0);<br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span>(block);<br> <br>        <span class="hljs-comment">/// 6. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥ä¼‘çœ </span><br>        <span class="hljs-comment">/// æ­¤å¤„æœ‰Observeré‡Šæ”¾å¹¶æ–°å»ºAutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeWaiting);<br> <br>        <span class="hljs-comment">/// 7. sleep to wait msg.</span><br>        <span class="hljs-built_in">mach_msg</span>() -&gt; <span class="hljs-built_in">mach_msg_trap</span>();<br>        <br> <br>        <span class="hljs-comment">/// 8. é€šçŸ¥Observersï¼Œçº¿ç¨‹è¢«å”¤é†’</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopAfterWaiting);<br> <br>        <span class="hljs-comment">/// 9. å¦‚æœæ˜¯è¢«Timerå”¤é†’çš„ï¼Œå›è°ƒTimer</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</span>(timer);<br> <br>        <span class="hljs-comment">/// 9. å¦‚æœæ˜¯è¢«dispatchå”¤é†’çš„ï¼Œæ‰§è¡Œæ‰€æœ‰è°ƒç”¨ dispatch_async ç­‰æ–¹æ³•æ”¾å…¥main queue çš„ block</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span>(dispatched_block);<br> <br>        <span class="hljs-comment">/// 9. å¦‚æœå¦‚æœRunloopæ˜¯è¢« Source1 (åŸºäºportçš„) çš„äº‹ä»¶å”¤é†’äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶</span><br>        <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</span>(source1);<br> <br> <br>    &#125; while (...);<br> <br>    <span class="hljs-comment">/// 10. é€šçŸ¥Observersï¼Œå³å°†é€€å‡ºRunLoop</span><br>    <span class="hljs-comment">/// æ­¤å¤„æœ‰Observeré‡Šæ”¾AutoreleasePool: _objc_autoreleasePoolPop();</span><br>    <span class="hljs-built_in">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopExit);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€è€ƒï¼š"><a href="#æ€è€ƒï¼š" class="headerlink" title="æ€è€ƒï¼š"></a>æ€è€ƒï¼š</h2><h3 id="runloopä»€ä¹ˆæ—¶å€™é€€å‡º"><a href="#runloopä»€ä¹ˆæ—¶å€™é€€å‡º" class="headerlink" title="runloopä»€ä¹ˆæ—¶å€™é€€å‡º"></a>runloopä»€ä¹ˆæ—¶å€™é€€å‡º</h3><ul><li>1ã€è¶…è¿‡è®¾å®šçš„è¶…æ—¶</li><li>2ã€å½“å‰runloopä¸­æ²¡æœ‰éœ€è¦å¤„ç†çš„timerã€source</li><li>3ã€æ¥æ”¶åˆ°exitä¿¡å·</li></ul><h2 id="runloopåœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨"><a href="#runloopåœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨" class="headerlink" title="runloopåœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨"></a>runloopåœ¨ç³»ç»Ÿä¸­çš„åº”ç”¨</h2><h3 id="1ã€AutoreleasePool"><a href="#1ã€AutoreleasePool" class="headerlink" title="1ã€AutoreleasePool"></a>1ã€AutoreleasePool</h3><p>Appå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚</p><p>ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</p><p>ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</p><p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚</p><h3 id="2ã€äº‹ä»¶å“åº”"><a href="#2ã€äº‹ä»¶å“åº”" class="headerlink" title="2ã€äº‹ä»¶å“åº”"></a>2ã€äº‹ä»¶å“åº”</h3><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º <code>__IOHIDEventSystemClientQueueCallback()</code></p><p>å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸&#x2F;é”å±&#x2F;æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± <code>IOKit.framework</code> ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±&#x2F;é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ <code>mach port</code> è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœåœ¨APPå†…æ³¨å†Œçš„ Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨<code>_UIApplicationHandleEventQueue() </code>è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚</p><p><code>_UIApplicationHandleEventQueue()</code> ä¼šæŠŠ <code>IOHIDEvent </code>å¤„ç†å¹¶åŒ…è£…æˆ <code>UIEvent</code> è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture&#x2F;å¤„ç†å±å¹•æ—‹è½¬&#x2F;å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ <code>UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel </code>äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚</p><h3 id="3ã€æ‰‹åŠ¿è¯†åˆ«"><a href="#3ã€æ‰‹åŠ¿è¯†åˆ«" class="headerlink" title="3ã€æ‰‹åŠ¿è¯†åˆ«"></a>3ã€æ‰‹åŠ¿è¯†åˆ«</h3><p>å½“ä¸Šé¢çš„ <code>_UIApplicationHandleEventQueue() </code>è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin&#x2F;Move&#x2F;End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ <code>_UIGestureRecognizerUpdateObserver()</code>ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ <code>GestureRecognizer</code>ï¼Œå¹¶æ‰§è¡Œ<code>GestureRecognizer</code>çš„å›è°ƒã€‚</p><p>å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º&#x2F;é”€æ¯&#x2F;çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚</p><h3 id="4ã€ç•Œé¢æ›´æ–°"><a href="#4ã€ç•Œé¢æ›´æ–°" class="headerlink" title="4ã€ç•Œé¢æ›´æ–°"></a>4ã€ç•Œé¢æ›´æ–°</h3><p>å½“åœ¨æ“ä½œ UI æ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº† Frameã€æ›´æ–°äº† UIView&#x2F;CALayer çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView&#x2F;CALayer çš„ <code>setNeedsLayout/setNeedsDisplay</code>æ–¹æ³•åï¼Œè¿™ä¸ª UIView&#x2F;CALayer å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚</p><p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(å³å°†è¿›å…¥ä¼‘çœ ) å’Œ Exit (å³å°†é€€å‡ºLoop) äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š<br><code>_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()</code>ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView&#x2F;CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚</p><h3 id="5ã€å®šæ—¶å™¨"><a href="#5ã€å®šæ—¶å™¨" class="headerlink" title="5ã€å®šæ—¶å™¨"></a>5ã€å®šæ—¶å™¨</h3><p>NSTimer å…¶å®å°±æ˜¯ CFRunLoopTimerRefï¼Œä»–ä»¬ä¹‹é—´æ˜¯ toll-free bridged çš„ã€‚ä¸€ä¸ª NSTimer æ³¨å†Œåˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚ä¾‹å¦‚ 10:00, 10:10, 10:20 è¿™å‡ ä¸ªæ—¶é—´ç‚¹ã€‚RunLoopä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ªTimerã€‚Timer æœ‰ä¸ªå±æ€§å«åš Tolerance (å®½å®¹åº¦)ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚</p><p>å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚å°±æ¯”å¦‚ç­‰å…¬äº¤ï¼Œå¦‚æœ 10:10 æ—¶æˆ‘å¿™ç€ç©æ‰‹æœºé”™è¿‡äº†é‚£ä¸ªç‚¹çš„å…¬äº¤ï¼Œé‚£æˆ‘åªèƒ½ç­‰ 10:20 è¿™ä¸€è¶Ÿäº†ã€‚</p><p>CADisplayLink æ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡ä¸€è‡´çš„å®šæ—¶å™¨ï¼ˆä½†å®é™…å®ç°åŸç†æ›´å¤æ‚ï¼Œå’Œ NSTimer å¹¶ä¸ä¸€æ ·ï¼Œå…¶å†…éƒ¨å®é™…æ˜¯æ“ä½œäº†ä¸€ä¸ª Sourceï¼‰ã€‚å¦‚æœåœ¨ä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´æ‰§è¡Œäº†ä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œé‚£å…¶ä¸­å°±ä¼šæœ‰ä¸€å¸§è¢«è·³è¿‡å»ï¼ˆå’Œ NSTimer ç›¸ä¼¼ï¼‰ï¼Œé€ æˆç•Œé¢å¡é¡¿çš„æ„Ÿè§‰ã€‚åœ¨å¿«é€Ÿæ»‘åŠ¨TableViewæ—¶ï¼Œå³ä½¿ä¸€å¸§çš„å¡é¡¿ä¹Ÿä¼šè®©ç”¨æˆ·æœ‰æ‰€å¯Ÿè§‰ã€‚Facebook å¼€æºçš„ AsyncDisplayLink å°±æ˜¯ä¸ºäº†è§£å†³ç•Œé¢å¡é¡¿çš„é—®é¢˜ï¼Œå…¶å†…éƒ¨ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œè¿™ä¸ªç¨åæˆ‘ä¼šå†å•ç‹¬å†™ä¸€é¡µåšå®¢æ¥åˆ†æã€‚</p><h3 id="6ã€PerformSelecter"><a href="#6ã€PerformSelecter" class="headerlink" title="6ã€PerformSelecter"></a>6ã€PerformSelecter</h3><p>å½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚</p><p>å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚</p><h3 id="7ã€ç½‘ç»œè¯·æ±‚ï¼ˆç°åœ¨çš„NSURLSessionæ˜¯å¦å€ŸåŠ©äº†runloopï¼Ÿï¼‰"><a href="#7ã€ç½‘ç»œè¯·æ±‚ï¼ˆç°åœ¨çš„NSURLSessionæ˜¯å¦å€ŸåŠ©äº†runloopï¼Ÿï¼‰" class="headerlink" title="7ã€ç½‘ç»œè¯·æ±‚ï¼ˆç°åœ¨çš„NSURLSessionæ˜¯å¦å€ŸåŠ©äº†runloopï¼Ÿï¼‰"></a>7ã€ç½‘ç»œè¯·æ±‚ï¼ˆç°åœ¨çš„NSURLSessionæ˜¯å¦å€ŸåŠ©äº†runloopï¼Ÿï¼‰</h3><p>NSURLConnection çš„å·¥ä½œè¿‡ç¨‹ä¹Ÿå€ŸåŠ©äº†runloopã€‚ä½¿ç”¨ NSURLConnection æ—¶ï¼Œä½ ä¼šä¼ å…¥ä¸€ä¸ª Delegateï¼Œå½“è°ƒç”¨äº† [connection start] åï¼Œè¿™ä¸ª Delegate å°±ä¼šä¸åœæ”¶åˆ°äº‹ä»¶å›è°ƒã€‚å®é™…ä¸Šï¼Œstart è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šä¼šè·å– CurrentRunLoopï¼Œç„¶ååœ¨å…¶ä¸­çš„ DefaultMode æ·»åŠ äº†4ä¸ª Source0 (å³éœ€è¦æ‰‹åŠ¨è§¦å‘çš„Source)ã€‚CFMultiplexerSource æ˜¯è´Ÿè´£å„ç§ Delegate å›è°ƒçš„ï¼ŒCFHTTPCookieStorage æ˜¯å¤„ç†å„ç§ Cookie çš„ã€‚</p><p>å½“å¼€å§‹ç½‘ç»œä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° NSURLConnection åˆ›å»ºäº†ä¸¤ä¸ªæ–°çº¿ç¨‹ï¼šcom.apple.NSURLConnectionLoader å’Œ com.apple.CFSocket.privateã€‚å…¶ä¸­ CFSocket çº¿ç¨‹æ˜¯å¤„ç†åº•å±‚ socket è¿æ¥çš„ã€‚NSURLConnectionLoader è¿™ä¸ªçº¿ç¨‹å†…éƒ¨ä¼šä½¿ç”¨ RunLoop æ¥æ¥æ”¶åº•å±‚ socket çš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡ä¹‹å‰æ·»åŠ çš„ Source0 é€šçŸ¥åˆ°ä¸Šå±‚çš„ Delegateã€‚</p><p><img src="https://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_network.png" alt="image"></p><p>NSURLConnectionLoader ä¸­çš„ RunLoop é€šè¿‡ä¸€äº›åŸºäº mach port çš„ Source æ¥æ”¶æ¥è‡ªåº•å±‚ CFSocket çš„é€šçŸ¥ã€‚å½“æ”¶åˆ°é€šçŸ¥åï¼Œå…¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºå‘ CFMultiplexerSource ç­‰ Source0 å‘é€é€šçŸ¥ï¼ŒåŒæ—¶å”¤é†’ Delegate çº¿ç¨‹çš„ RunLoop æ¥è®©å…¶å¤„ç†è¿™äº›é€šçŸ¥ã€‚CFMultiplexerSource ä¼šåœ¨ Delegate çº¿ç¨‹çš„ RunLoop å¯¹ Delegate æ‰§è¡Œå®é™…çš„å›è°ƒã€‚</p><h2 id="ä½ ç”¨runloopå®ç°äº†ä»€ä¹ˆ"><a href="#ä½ ç”¨runloopå®ç°äº†ä»€ä¹ˆ" class="headerlink" title="ä½ ç”¨runloopå®ç°äº†ä»€ä¹ˆ"></a>ä½ ç”¨runloopå®ç°äº†ä»€ä¹ˆ</h2><h3 id="ä½¿ç”¨runloopå¼€å¯ä¸€ä¸ªå¸¸é©»å­çº¿ç¨‹"><a href="#ä½¿ç”¨runloopå¼€å¯ä¸€ä¸ªå¸¸é©»å­çº¿ç¨‹" class="headerlink" title="ä½¿ç”¨runloopå¼€å¯ä¸€ä¸ªå¸¸é©»å­çº¿ç¨‹"></a>ä½¿ç”¨runloopå¼€å¯ä¸€ä¸ªå¸¸é©»å­çº¿ç¨‹</h3><ul><li>AFNetworking2å¼€å¯å­çº¿ç¨‹ï¼Œåœ¨åå°çº¿ç¨‹æ¥æ”¶ Delegate å›è°ƒ  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C">+ (<span class="hljs-type">void</span>)networkRequestThreadEntryPoint:(id)__unused object &#123;<br> <br>     @autoreleasepool &#123;<br>       [[NSThread currentThread] setName:@<span class="hljs-string">&quot;AFNetworking&quot;</span>];<br>       NSRunLoop *runLoop = [NSRunLoop currentRunLoop];<br>       [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];<br>       [runLoop run];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>çº¿ä¸Šå®æ—¶å¡é¡¿ç›‘æ§<ul><li>NSRunLoopè°ƒç”¨æ–¹æ³•ä¸»è¦å°±æ˜¯åœ¨kCFRunLoopBeforeSourcesï¼ˆ3. é€šçŸ¥ Observers: å³å°†è§¦å‘ Source0å›è°ƒï¼‰å’ŒkCFRunLoopBeforeWaitingï¼ˆ6. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥ä¼‘çœ ï¼‰ä¹‹é—´,è¿˜æœ‰kCFRunLoopAfterWaitingä¹‹å,ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬å‘ç°è¿™ä¸¤ä¸ªæ—¶é—´å†…è€—æ—¶å¤ªé•¿,é‚£ä¹ˆå°±å¯ä»¥åˆ¤å®šå‡ºæ­¤æ—¶ä¸»çº¿ç¨‹å¡é¡¿</li><li><a href="https://www.jianshu.com/p/890d1ba05f4c">iOSçº¿ä¸Šå®æ—¶å¡é¡¿ç›‘æ§</a></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-åŠ¨æ€åº“ä¸é™æ€åº“çš„åŒºåˆ«</title>
    <link href="/2021/02/16/%E5%8A%A8%E6%80%81%E5%BA%93%E4%B8%8E%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <url>/2021/02/16/%E5%8A%A8%E6%80%81%E5%BA%93%E4%B8%8E%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h3 id="é™æ€åº“-Static-Library"><a href="#é™æ€åº“-Static-Library" class="headerlink" title="é™æ€åº“ (Static Library)"></a>é™æ€åº“ (Static Library)</h3><ul><li><p>åˆ†å‘æ–‡ä»¶å¤§</p></li><li><p>é™æ€åº“é»˜è®¤ä»…å°†æœ‰ç”¨åˆ°çš„ç±»æ–‡ä»¶<code>link</code>åˆ°<code>Mach-O</code>ä¸­(å·²ç±»æ–‡ä»¶ä¸ºæœ€å°é“¾æ¥å•ä½)</p></li><li><p>ipaåŒ…å°(ä¸ºäº†APPç˜¦èº«ï¼Œå°½é‡å°†ä»£ç æ”¾é™æ€åº“ä¸­) </p><ul><li>é™æ€åº“ä¸­æŸä¸ªç›®æ ‡æ–‡ä»¶çš„ä»£ç æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œåˆ™è¿™ä¸ªç›®æ ‡æ–‡ä»¶ä¸ä¼šè¢«é“¾æ¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»(å‰ææ˜¯ä¸è¦ä½¿ç”¨<code>-Objc</code>å’Œ<code>-all_load</code>é€‰é¡¹ï¼Œåˆ†ç±»ä»£ç ç»å¸¸è¢«ä¼˜åŒ–æ‰ï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨<code>-force_load</code>æ¥å¤„ç†é™æ€åº“åˆ†ç±»åŠ è½½é—®é¢˜)</li></ul></li><li><p>APPå†·å¯åŠ¨é€Ÿåº¦å¿«</p><ul><li>å‰ææ˜¯ä¸ä½¿ç”¨<code>åŠ¨æ€åº“æ‹†åˆ†</code>æ­é…<code>åŠ¨æ€åº“æ‡’åŠ è½½æ–¹æ¡ˆ</code></li><li>APPå¯åŠ¨æµç¨‹ä¸­æœ‰<code>rebase</code>å’Œ<code>bind</code>ï¼Œå¤šä¸ªé™æ€åº“åªéœ€è¦<code>rebase</code>å’Œ<code>bind</code>ä¸€æ¬¡</li></ul></li><li><p>å­˜åœ¨ç¬¦å·å†²çªå¯èƒ½</p></li><li><p>å…±äº«<code>TEXTæ®µ</code></p><ul><li>iOS9ä»¥å‰å•ä¸ªMach-Oçš„TEXTé™åˆ¶60M</li><li>iOS9ä»¥åå•ä¸ªMach-Oçš„TEXTé™åˆ¶500M</li></ul></li><li><p>ä¸éœ€è¦é¢å¤–ç­¾åéªŒè¯  </p></li><li><p>é™æ€åº“ç¬¦å·çš„å¯è§æ€§å¯ä»¥åœ¨é“¾æ¥æœŸé—´è¢«ä¿®æ”¹ </p></li><li><p>æ–‡ä»¶æ ¼å¼å¤šä¸º<code>fat</code>æ ¼å¼çš„é™æ€åº“æ–‡ä»¶</p></li><li><p>å½¢å¼å¤šä¸º<code>.a</code>ä¸<code>.framework</code></p></li><li><p>é™æ€åº“ä¸å«<code>bitcode</code>æ—¶ï¼Œå¼•ç”¨é™æ€åº“çš„ç›®æ ‡éƒ¨ç½²æ—¶å°±ä¸èƒ½åŒ…å«<code>bitcode</code></p></li></ul><h3 id="åŠ¨æ€åº“-Dynamic-Library"><a href="#åŠ¨æ€åº“-Dynamic-Library" class="headerlink" title="åŠ¨æ€åº“ (Dynamic Library)"></a>åŠ¨æ€åº“ (Dynamic Library)</h3><ul><li><p>åˆ†å‘æ–‡ä»¶å°</p></li><li><p>ipaåŒ…å¤§  ï¼ˆå‰ææ˜¯ä¸è€ƒè™‘æ‡’åŠ è½½çš„æƒ…å†µï¼‰</p><ul><li>åŠ¨æ€åº“ä¼šæŠŠæ•´ä¸ª<code>lib</code>å¤åˆ¶è¿›<code>ipa</code>ä¸­</li></ul></li><li><p>APPå†·å¯åŠ¨é€Ÿåº¦æ…¢</p><ul><li>APPå¯åŠ¨æµç¨‹ä¸­æœ‰<code>rebase</code>å’Œ<code>bind</code>ï¼Œå¤šä¸ªåŠ¨æ€åº“åªéœ€è¦å¤šæ¬¡<code>rebase</code>å’Œ<code>bind</code></li></ul></li><li><p>éœ€è¦è®¾ç½®åˆé€‚çš„<code>runpath</code> </p></li><li><p>éœ€è¦åŠ¨æ€åŠ è½½</p></li><li><p>éœ€è¦ç­¾åä¸”éœ€è¦éªŒè¯ç­¾å</p><ul><li>ä¼šæ£€æŸ¥<code>framework</code>çš„ç­¾åï¼Œç­¾åä¸­å¿…é¡»åŒ…å«<code>TeamIdentifier</code>,å¹¶ä¸”<code>framework</code>å’Œhost APPçš„<code>TeamIdentifier</code>å¿…é¡»ä¸€è‡´</li><li>Xcodeé‡ç­¾å‘½ï¼Œä¿è¯åŠ¨æ€åº“ç­¾åä¸€è‡´æ€§</li></ul></li><li><p>éœ€è¦å¯¼å‡ºç¬¦å·</p></li><li><p>é‡å¤çš„<code>arch</code>ç»“æ„</p></li><li><p>APPä¸åŠ¨æ€åº“ä¸­é‡å¤ä»£ç å¯ä»¥å…±å­˜ï¼Œä¸ä¼šå‘ç”Ÿç¬¦å·å†²çª</p><ul><li>å› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶åœ¨æ„å»ºé“¾æ¥é˜¶æ®µï¼Œé‡åˆ°é™æ€åº“åˆ™å¸é™„è¿›æ¥ï¼Œé‡åˆ°åŠ¨æ€åº“åˆ™æ‰“ä¸ªæ ‡è®°ï¼Œå½¼æ­¤ä¿æŒç‹¬ç«‹æ€§</li><li>å¯¹äºæ¥è‡ªåŠ¨æ€åº“çš„ç¬¦å·ï¼Œç¼–è¯‘å™¨ä¼šæ‰“ä¸ªæ ‡è®°ï¼Œäº¤ç»™<code>dyld</code>å»åŠ è½½å’Œé“¾æ¥ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯æŠŠé“¾æ¥çš„è¿‡ç¨‹æ¨è¿Ÿåˆ°äº†è¿è¡Œæ—¶æ‰§è¡Œã€‚ï¼ˆæ¯”å¦‚APPä½¿ç”¨çš„æ˜¯3.0ç‰ˆæœ¬SDKï¼ŒåŠ¨æ€åº“ä½¿ç”¨çš„æ˜¯1.0ç‰ˆæœ¬SDKï¼Œèƒ½æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¼šæœ‰é£é™©ï¼‰</li></ul></li><li><p>é“¾æ¥åéœ€è¦åŒ…å«åˆ†å‘å¤§å°</p></li><li><p>å†·å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œé»˜è®¤ä¼šåœ¨<code>main</code>å‡½æ•°ä¹‹å‰åŠ è½½</p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿‡å¤šçš„åŠ¨æ€åº“ä¼šæ‹–æ…¢å†·å¯åŠ¨é€Ÿåº¦</li><li>å¦‚æœé‡‡ç”¨æ‡’åŠ è½½åŠ¨æ€åº“çš„å½¢å¼ï¼Œèƒ½å¤ŸåŠ å¿«APPçš„å¯åŠ¨é€Ÿåº¦,å¯ä»¥ä½¿ç”¨<code>dlopen</code>å’Œ<code>bundle</code>æ‡’åŠ è½½ä¼˜åŒ–</li></ul></li><li><p>æ–‡ä»¶æ ¼å¼<code>Mach-O</code>ï¼ˆä¸€ä¸ªæ²¡æœ‰<code>main</code>å‡½æ•°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰</p></li><li><p>åŠ¨æ€åº“ä¸åŒ…å«<code>bitcode</code>æ—¶ï¼Œå¼•ç”¨åŠ¨æ€åº“çš„ç›®æ ‡éƒ¨ç½²æ—¶å¯ä»¥åŒ…å«<code>bitcode</code></p></li><li><p><code>CocoaPods</code>ä»<code>v0.36.0</code>å¼€å§‹ï¼Œå¯æ·»åŠ å…³é”®å­—<code>use_frameworks!</code>ç¼–è¯‘æˆç±»ä¼¼<code>Embedded Framework</code>çš„ç»“æ„ï¼ˆå¯ä»¥ç§°ä¹‹ä¸º<code>umbrella framework</code>ï¼‰</p><ul><li>ç¼ºç‚¹ï¼šé»˜è®¤æŠŠé¡¹ç›®çš„ä¾èµ–å…¨éƒ¨æ”¹ä¸ºåŠ¨æ€åº“ï¼ˆå¯æ˜¯ä½¿ç”¨<code>use_modular_headers!</code>,ä¹Ÿå¯ä»¥åœ¨<code>podsepc</code>æ·»åŠ <code>s.static_framework = true</code>è§„é¿ï¼‰</li><li><code>CocoaPods</code>æ‰§è¡Œè„šæœ¬æŠŠåŠ¨æ€åº“åµŒå…¥åˆ°<code>.app</code>çš„<code>Framework</code>ç›®å½•ä¸‹ï¼ˆç›¸å½“äºåœ¨<code>Embedded Binaries</code>åŠ å…¥åŠ¨æ€åº“ï¼‰</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç½‘ç»œ</title>
    <link href="/2020/08/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    <url>/2020/08/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<hr><h3 id="ç®€è¿°OSIä¸ƒå±‚åè®®"><a href="#ç®€è¿°OSIä¸ƒå±‚åè®®" class="headerlink" title="ç®€è¿°OSIä¸ƒå±‚åè®®"></a>ç®€è¿°OSIä¸ƒå±‚åè®®</h3><ul><li>OSIä¸ƒå±‚åè®®åŒ…æ‹¬ï¼šç‰©ç†å±‚ï¼Œæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œå±‚ï¼Œè¿è¾“å±‚ï¼Œä¼šè¯å±‚ï¼Œè¡¨ç¤ºå±‚ï¼Œ åº”ç”¨å±‚</li></ul><hr><hr><h3 id="ç®€è¿°TCP-x2F-IPäº”å±‚åè®®"><a href="#ç®€è¿°TCP-x2F-IPäº”å±‚åè®®" class="headerlink" title="ç®€è¿°TCP&#x2F;IPäº”å±‚åè®®"></a>ç®€è¿°TCP&#x2F;IPäº”å±‚åè®®</h3><ul><li>TCP&#x2F;IPäº”å±‚åè®®åŒ…æ‹¬ï¼šç‰©ç†å±‚ï¼Œæ•°æ®é“¾è·¯å±‚ï¼Œç½‘ç»œå±‚ï¼Œè¿è¾“å±‚ï¼Œåº”ç”¨å±‚</li></ul><hr><hr><h3 id="ç‰©ç†å±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#ç‰©ç†å±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="ç‰©ç†å±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>ç‰©ç†å±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>ä¸»è¦è§£å†³ä¸¤å°ç‰©ç†æœºä¹‹é—´çš„é€šä¿¡ï¼Œé€šè¿‡äºŒè¿›åˆ¶æ¯”ç‰¹æµçš„ä¼ è¾“æ¥å®ç°ï¼ŒäºŒè¿›åˆ¶æ•°æ®è¡¨ç°ä¸ºç”µæµç”µå‹ä¸Šçš„å¼ºå¼±ï¼Œåˆ°è¾¾ç›®çš„åœ°å†è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æœºå™¨ç ã€‚ç½‘å¡ã€é›†çº¿å™¨å·¥ä½œåœ¨è¿™ä¸€å±‚ã€‚</li></ul><hr><hr><h3 id="æ•°æ®é“¾è·¯å±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#æ•°æ®é“¾è·¯å±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="æ•°æ®é“¾è·¯å±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>æ•°æ®é“¾è·¯å±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>åœ¨ä¸å¯é çš„ç‰©ç†ä»‹è´¨ä¸Šæä¾›å¯é çš„ä¼ è¾“ï¼Œæ¥æ”¶æ¥è‡ªç‰©ç†å±‚çš„ä½æµå½¢å¼çš„æ•°æ®ï¼Œå¹¶å°è£…æˆå¸§ï¼Œä¼ é€åˆ°ä¸Šä¸€å±‚ï¼›åŒæ ·ï¼Œä¹Ÿå°†æ¥è‡ªä¸Šå±‚çš„æ•°æ®å¸§ï¼Œæ‹†è£…ä¸ºä½æµå½¢å¼çš„æ•°æ®è½¬å‘åˆ°ç‰©ç†å±‚ã€‚è¿™ä¸€å±‚åœ¨ç‰©ç†å±‚æä¾›çš„æ¯”ç‰¹æµçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å·®é”™æ§åˆ¶ã€æµé‡æ§åˆ¶æ–¹æ³•ï¼Œä½¿æœ‰å·®é”™çš„ç‰©ç†çº¿è·¯å˜ä¸ºæ— å·®é”™çš„æ•°æ®é“¾è·¯ã€‚æä¾›ç‰©ç†åœ°å€å¯»å€åŠŸèƒ½ã€‚äº¤æ¢æœºå·¥ä½œåœ¨è¿™ä¸€å±‚ã€‚</li></ul><hr><hr><h3 id="ç½‘ç»œå±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#ç½‘ç»œå±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="ç½‘ç»œå±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>ç½‘ç»œå±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>å°†ç½‘ç»œåœ°å€ç¿»è¯‘æˆå¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå¹¶å†³å®šå¦‚ä½•å°†æ•°æ®ä»å‘é€æ–¹è·¯ç”±åˆ°æ¥æ”¶æ–¹ï¼Œé€šè¿‡è·¯ç”±é€‰æ‹©ç®—æ³•ä¸ºåˆ†ç»„é€šè¿‡é€šä¿¡å­ç½‘é€‰æ‹©æœ€ä½³è·¯å¾„ã€‚è·¯ç”±å™¨å·¥ä½œåœ¨è¿™ä¸€å±‚ã€‚</li></ul><hr><hr><h3 id="ä¼ è¾“å±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#ä¼ è¾“å±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="ä¼ è¾“å±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>ä¼ è¾“å±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>ä¼ è¾“å±‚æä¾›äº†è¿›ç¨‹é—´çš„é€»è¾‘é€šä¿¡ï¼Œä¼ è¾“å±‚å‘é«˜å±‚ç”¨æˆ·å±è”½äº†ä¸‹é¢ç½‘ç»œå±‚çš„æ ¸å¿ƒç»†èŠ‚ï¼Œä½¿åº”ç”¨ç¨‹åºçœ‹èµ·æ¥åƒæ˜¯åœ¨ä¸¤ä¸ªä¼ è¾“å±‚å®ä½“ä¹‹é—´æœ‰ä¸€æ¡ç«¯åˆ°ç«¯çš„é€»è¾‘é€šä¿¡ä¿¡é“ã€‚</li></ul><hr><hr><h3 id="ä¼šè¯å±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#ä¼šè¯å±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="ä¼šè¯å±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>ä¼šè¯å±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>å»ºç«‹ä¼šè¯ï¼šèº«ä»½éªŒè¯ï¼Œæƒé™é‰´å®šç­‰ï¼›ä¿æŒä¼šè¯ï¼šå¯¹è¯¥ä¼šè¯è¿›è¡Œç»´æŠ¤ï¼Œåœ¨ä¼šè¯ç»´æŒæœŸé—´ä¸¤è€…å¯ä»¥éšæ—¶ä½¿ç”¨è¿™æ¡ä¼šè¯ä¼ è¾“å±€ï¼›æ–­å¼€ä¼šè¯ï¼šå½“åº”ç”¨ç¨‹åºæˆ–åº”ç”¨å±‚è§„å®šçš„è¶…æ—¶æ—¶é—´åˆ°æœŸåï¼ŒOSIä¼šè¯å±‚æ‰ä¼šé‡Šæ”¾è¿™æ¡ä¼šè¯ã€‚</li></ul><hr><hr><h3 id="è¡¨ç¤ºå±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#è¡¨ç¤ºå±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="è¡¨ç¤ºå±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>è¡¨ç¤ºå±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>å¯¹æ•°æ®æ ¼å¼è¿›è¡Œç¼–è¯‘ï¼Œå¯¹æ”¶åˆ°æˆ–å‘å‡ºçš„æ•°æ®æ ¹æ®åº”ç”¨å±‚çš„ç‰¹å¾è¿›è¡Œå¤„ç†ï¼Œå¦‚å¤„ç†ä¸ºæ–‡å­—ã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€æ–‡æ¡£ç­‰ï¼Œè¿˜å¯ä»¥å¯¹å‹ç¼©æ–‡ä»¶è¿›è¡Œè§£å‹ç¼©ã€å¯¹åŠ å¯†æ–‡ä»¶è¿›è¡Œè§£å¯†ç­‰ã€‚</li></ul><hr><hr><h3 id="åº”ç”¨å±‚æœ‰ä»€ä¹ˆä½œç”¨"><a href="#åº”ç”¨å±‚æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="åº”ç”¨å±‚æœ‰ä»€ä¹ˆä½œç”¨"></a>åº”ç”¨å±‚æœ‰ä»€ä¹ˆä½œç”¨</h3><ul><li>æä¾›åº”ç”¨å±‚åè®®ï¼Œå¦‚HTTPåè®®ï¼ŒFTPåè®®ç­‰ç­‰ï¼Œæ–¹ä¾¿åº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</li></ul><hr><hr><h3 id="TCPä¸UDPåŒºåˆ«"><a href="#TCPä¸UDPåŒºåˆ«" class="headerlink" title="TCPä¸UDPåŒºåˆ«"></a>TCPä¸UDPåŒºåˆ«</h3><ul><li>TCPä½œä¸ºé¢å‘æµçš„åè®®ï¼Œæä¾›å¯é çš„ã€é¢å‘è¿æ¥çš„è¿è¾“æœåŠ¡ï¼Œå¹¶ä¸”æä¾›ç‚¹å¯¹ç‚¹é€šä¿¡ </li><li></li><li>UDPä½œä¸ºé¢å‘æŠ¥æ–‡çš„åè®®ï¼Œä¸æä¾›å¯é äº¤ä»˜ï¼Œå¹¶ä¸”ä¸éœ€è¦è¿æ¥ï¼Œä¸ä»…ä»…å¯¹ç‚¹å¯¹ç‚¹ï¼Œä¹Ÿæ”¯æŒå¤šæ’­å’Œå¹¿æ’­</li></ul><hr><hr><h3 id="ä¸ºä½•TCPå¯é "><a href="#ä¸ºä½•TCPå¯é " class="headerlink" title="ä¸ºä½•TCPå¯é "></a>ä¸ºä½•TCPå¯é </h3><ul><li>TCPæœ‰ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œå››æ¬¡æŒ¥æ‰‹å…³é—­è¿æ¥çš„æœºåˆ¶ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰æ»‘åŠ¨çª—å£å’Œæ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚æœ€æœ€å…³é”®çš„æ˜¯è¿˜ä¿ç•™è¶…æ—¶é‡ä¼ çš„æœºåˆ¶ã€‚å¯¹äºæ¯ä»½æŠ¥æ–‡ä¹Ÿå­˜åœ¨æ ¡éªŒï¼Œä¿è¯æ¯ä»½æŠ¥æ–‡å¯é æ€§ã€‚</li></ul><hr><hr><h3 id="ä¸ºä½•UDPä¸å¯é "><a href="#ä¸ºä½•UDPä¸å¯é " class="headerlink" title="ä¸ºä½•UDPä¸å¯é "></a>ä¸ºä½•UDPä¸å¯é </h3><ul><li>UDPé¢å‘æ•°æ®æŠ¥æ— è¿æ¥çš„ï¼Œæ•°æ®æŠ¥å‘å‡ºå»ï¼Œå°±ä¸ä¿ç•™æ•°æ®å¤‡ä»½äº†ã€‚ä»…ä»…åœ¨IPæ•°æ®æŠ¥å¤´éƒ¨åŠ å…¥æ ¡éªŒå’Œå¤ç”¨ã€‚UDPæ²¡æœ‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ¦‚å¿µã€‚UDPæŠ¥æ–‡è¿‡é•¿çš„è¯æ˜¯äº¤ç»™IPåˆ‡æˆå°æ®µï¼Œå¦‚æœæŸæ®µæŠ¥åºŸæŠ¥æ–‡å°±åºŸäº†ã€‚</li></ul><hr><hr><h3 id="ç®€è¿°TCPç²˜åŒ…ç°è±¡"><a href="#ç®€è¿°TCPç²˜åŒ…ç°è±¡" class="headerlink" title="ç®€è¿°TCPç²˜åŒ…ç°è±¡"></a>ç®€è¿°TCPç²˜åŒ…ç°è±¡</h3><ul><li>TCPæ˜¯é¢å‘æµåè®®ï¼Œå‘é€çš„å•ä½æ˜¯å­—èŠ‚æµï¼Œå› æ­¤ä¼šå°†å¤šä¸ªå°å°ºå¯¸æ•°æ®è¢«å°è£…åœ¨ä¸€ä¸ªtcpæŠ¥æ–‡ä¸­å‘å‡ºå»çš„å¯èƒ½æ€§ã€‚å¯ä»¥ç®€å•çš„ç†è§£æˆå®¢æˆ·ç«¯è°ƒç”¨äº†ä¸¤æ¬¡sendï¼ŒæœåŠ¡å™¨ç«¯ä¸€ä¸ªrecvå°±æŠŠä¿¡æ¯éƒ½è¯»å‡ºæ¥äº†ã€‚</li></ul><h3 id="TCPç²˜åŒ…ç°è±¡å¤„ç†æ–¹æ³•"><a href="#TCPç²˜åŒ…ç°è±¡å¤„ç†æ–¹æ³•" class="headerlink" title="TCPç²˜åŒ…ç°è±¡å¤„ç†æ–¹æ³•"></a>TCPç²˜åŒ…ç°è±¡å¤„ç†æ–¹æ³•</h3><ul><li>å›ºå®šå‘é€ä¿¡æ¯é•¿åº¦ï¼Œæˆ–åœ¨ä¸¤ä¸ªä¿¡æ¯ä¹‹é—´åŠ å…¥åˆ†éš”ç¬¦ã€‚</li></ul><hr><hr><h3 id="ç®€è¿°TCPåè®®çš„æ»‘åŠ¨çª—å£"><a href="#ç®€è¿°TCPåè®®çš„æ»‘åŠ¨çª—å£" class="headerlink" title="ç®€è¿°TCPåè®®çš„æ»‘åŠ¨çª—å£"></a>ç®€è¿°TCPåè®®çš„æ»‘åŠ¨çª—å£</h3><ul><li>æ»‘åŠ¨çª—å£æ˜¯ä¼ è¾“å±‚è¿›è¡Œæµé‡æ§åˆ¶çš„ä¸€ç§æªæ–½ï¼Œæ¥æ”¶æ–¹é€šè¿‡é€šå‘Šå‘ é€æ–¹è‡ªå·±çš„çª—å£å¤§å°ï¼Œä»è€Œæ§åˆ¶å‘é€æ–¹çš„å‘é€é€Ÿåº¦ï¼Œé˜²æ­¢å‘é€æ–¹å‘é€é€Ÿåº¦è¿‡å¿«è€Œå¯¼è‡´è‡ªå·±è¢«æ·¹æ²¡ã€‚</li></ul><h3 id="ç®€è¿°TCPåè®®çš„æ‹¥å¡æ§åˆ¶"><a href="#ç®€è¿°TCPåè®®çš„æ‹¥å¡æ§åˆ¶" class="headerlink" title="ç®€è¿°TCPåè®®çš„æ‹¥å¡æ§åˆ¶"></a>ç®€è¿°TCPåè®®çš„æ‹¥å¡æ§åˆ¶</h3><ul><li><p>æ‹¥å¡æ˜¯æŒ‡ä¸€ä¸ªæˆ–è€…å¤šä¸ªäº¤æ¢ç‚¹çš„æ•°æ®æŠ¥è¶…è½½ï¼ŒTCPåˆä¼šæœ‰é‡ä¼ æœºåˆ¶ï¼Œå¯¼è‡´è¿‡è½½ã€‚ä¸ºäº†é˜²æ­¢æ‹¥å¡çª—å£cwndå¢é•¿è¿‡å¤§å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡.</p></li><li><p>å½“cwnd &lt; ssthresh æ—¶ï¼Œä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ã€‚å½“cwnd &gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•è€Œæ”¹ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚å½“cwnd &#x3D; ssthresh æ—¶ï¼Œå³å¯ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä½¿ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚</p></li><li><p>æ…¢å¼€å§‹ï¼šç”±å°åˆ°å¤§é€æ¸å¢åŠ æ‹¥å¡çª—å£çš„å¤§å°ï¼Œæ¯æ¥ä¸€æ¬¡æŠ¥æ–‡ï¼ŒcwndæŒ‡æ•°å¢åŠ ã€‚</p></li><li><p>æ‹¥å¡é¿å…ï¼šcwndç¼“æ…¢åœ°å¢å¤§ï¼Œå³æ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´RTTå°±æŠŠå‘é€æ–¹çš„æ‹¥å¡çª—å£cwndåŠ 1ã€‚</p></li><li><p>å¿«æ¢å¤ä¹‹å‰çš„ç­–ç•¥ï¼šå‘é€æ–¹åˆ¤æ–­ç½‘ç»œå‡ºç°æ‹¥å¡ï¼Œå°±æŠŠssthreshè®¾ç½®ä¸ºå‡ºç°æ‹¥å¡æ—¶å‘é€æ–¹çª—å£å€¼çš„ä¸€åŠï¼Œç»§ç»­æ‰§è¡Œæ…¢å¼€å§‹ï¼Œä¹‹åè¿›è¡Œæ‹¥å¡é¿å…ã€‚</p></li><li><p>å¿«æ¢å¤ï¼šå‘é€æ–¹åˆ¤æ–­ç½‘ç»œå‡ºç°æ‹¥å¡ï¼Œå°±æŠŠssthreshè®¾ç½®ä¸ºå‡ºç°æ‹¥å¡æ—¶å‘é€æ–¹çª—å£å€¼çš„ä¸€åŠï¼Œå¹¶æŠŠcwndè®¾ç½®ä¸ºssthreshçš„ä¸€åŠï¼Œä¹‹åè¿›è¡Œæ‹¥å¡é¿å…ã€‚</p></li></ul><hr><hr><h3 id="ç®€è¿°å¿«é‡ä¼ "><a href="#ç®€è¿°å¿«é‡ä¼ " class="headerlink" title="ç®€è¿°å¿«é‡ä¼ "></a>ç®€è¿°å¿«é‡ä¼ </h3><ul><li>å¦‚æœåœ¨è¶…æ—¶é‡ä¼ å®šæ—¶å™¨æº¢å‡ºä¹‹å‰ï¼Œæ¥æ”¶åˆ°è¿ç»­çš„ä¸‰ä¸ªé‡å¤å†—ä½™ACKï¼Œå‘é€ç«¯ä¾¿çŸ¥æ™“å“ªä¸ªæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±äº†ï¼Œäºæ˜¯é‡å‘è¯¥æŠ¥æ–‡æ®µï¼Œä¸éœ€è¦ç­‰å¾…è¶…æ—¶é‡ä¼ å®šæ—¶å™¨æº¢å‡ºå†å‘é€è¯¥æŠ¥æ–‡ã€‚</li></ul><hr><hr><h3 id="TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹"><a href="#TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹" class="headerlink" title="TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹"></a>TCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹</h3><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹:å®¢æˆ·ç«¯å°†æ ‡å¿—ä½SYNç½®ä¸º1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªå€¼åºåˆ—å·seq&#x3D;xï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ è¿›å…¥syn_sentçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡ç«¯ç¡®è®¤ã€‚</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹:æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®åŒ…åç”±æ ‡å¿—ä½SYN&#x3D;1çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡ç«¯å°†æ ‡å¿—ä½SYNå’Œ ACKéƒ½ç½®ä¸º1ï¼Œack&#x3D;x+1,éšæœºäº§ç”Ÿä¸€ä¸ªå€¼seq&#x3D;yï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™å®¢æˆ·ç«¯ä»¥ç¡®è®¤è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿›å…¥syn_rcvdçŠ¶æ€ã€‚</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹:å®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤åæ£€æŸ¥,å¦‚æœæ­£ç¡®åˆ™å°†æ ‡å¿—ä½ACKä¸º1ï¼Œack&#x3D;y+1ï¼Œå¹¶å°†è¯¥æ•°æ®åŒ…å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯è¿›è¡Œæ£€æŸ¥å¦‚æœæ­£ç¡®åˆ™è¿æ¥å»ºç«‹æˆåŠŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›å…¥establishedçŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œéšåå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å¯ä»¥å¼€å§‹ä¼ è¾“ æ•°æ®äº†</li></ul><hr><hr><h3 id="ç®€è¿°åŠè¿æ¥é˜Ÿåˆ—"><a href="#ç®€è¿°åŠè¿æ¥é˜Ÿåˆ—" class="headerlink" title="ç®€è¿°åŠè¿æ¥é˜Ÿåˆ—"></a>ç®€è¿°åŠè¿æ¥é˜Ÿåˆ—</h3><ul><li>TCPæ¡æ‰‹ä¸­ï¼Œå½“æœåŠ¡å™¨å¤„äºSYN_RCVD çŠ¶æ€ï¼ŒæœåŠ¡å™¨ä¼šæŠŠæ­¤ç§çŠ¶æ€ä¸‹è¯·æ±‚è¿æ¥æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œè¯¥é˜Ÿåˆ—ç§°ä¸ºåŠè¿æ¥é˜Ÿåˆ—ã€‚</li></ul><hr><hr><h3 id="ç®€è¿°SYNæ”»å‡»"><a href="#ç®€è¿°SYNæ”»å‡»" class="headerlink" title="ç®€è¿°SYNæ”»å‡»"></a>ç®€è¿°SYNæ”»å‡»</h3><ul><li>SYNæ”»å‡»å³åˆ©ç”¨TCPåè®®ç¼ºé™·ï¼Œé€šè¿‡å‘é€å¤§é‡çš„åŠè¿æ¥è¯·æ±‚ï¼Œå ç”¨åŠè¿æ¥é˜Ÿåˆ—ï¼Œè€—è´¹CPUå’Œå†…å­˜èµ„æºã€‚</li></ul><h4 id="ä¼˜åŒ–æ–¹å¼ï¼š"><a href="#ä¼˜åŒ–æ–¹å¼ï¼š" class="headerlink" title="ä¼˜åŒ–æ–¹å¼ï¼š"></a>ä¼˜åŒ–æ–¹å¼ï¼š</h4><ul><li>ç¼©çŸ­SYN Timeoutæ—¶é—´<br>è®°å½•IPï¼Œè‹¥è¿ç»­å—åˆ°æŸä¸ªIPçš„é‡å¤SYNæŠ¥æ–‡ï¼Œä»è¿™ä¸ªIPåœ°å€æ¥çš„åŒ…ä¼šè¢«ä¸€æ¦‚ä¸¢å¼ƒã€‚</li></ul><hr><hr><h3 id="TCPå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹"><a href="#TCPå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹" class="headerlink" title="TCPå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹"></a>TCPå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹</h3><ul><li>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªFINï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„æ•°æ®ä¼ é€ï¼Œå®¢æˆ·ç«¯è¿›å…¥fin_wait_1çŠ¶æ€ã€‚</li><li>ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡ç«¯æ”¶åˆ°FINåï¼Œå‘é€ä¸€ä¸ªACKç»™å®¢æˆ·ç«¯ï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°åºå·+1ï¼ŒæœåŠ¡ç«¯è¿›å…¥Close_waitçŠ¶æ€ã€‚æ­¤æ—¶TCPè¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå³å®¢æˆ·ç«¯å·²ç»æ²¡æœ‰è¦å‘é€çš„æ•°æ®äº†ï¼Œä½†æœåŠ¡ç«¯è‹¥å‘é€æ•°æ®ï¼Œåˆ™å®¢æˆ·ç«¯ä»è¦æ¥æ”¶ã€‚</li><li>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡ç«¯å‘é€ä¸€ä¸ªFINï¼Œç”¨æ¥å…³é—­æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ä¼ é€ï¼ŒæœåŠ¡ç«¯è¿›å…¥Last_ackçŠ¶æ€ã€‚</li><li>ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°FINåï¼Œå®¢æˆ·ç«¯è¿›å…¥Time_waitçŠ¶æ€ï¼Œæ¥ç€å‘é€ä¸€ä¸ªACKç»™æœåŠ¡ç«¯ï¼Œç¡®è®¤åï¼ŒæœåŠ¡ç«¯è¿›å…¥ClosedçŠ¶æ€ï¼Œå®Œæˆå››æ¬¡æŒ¥æ‰‹ã€‚</li></ul><hr><hr><h3 id="ä¸ºä»€ä¹ˆTCPæŒ¥æ‰‹éœ€è¦4æ¬¡"><a href="#ä¸ºä»€ä¹ˆTCPæŒ¥æ‰‹éœ€è¦4æ¬¡" class="headerlink" title="ä¸ºä»€ä¹ˆTCPæŒ¥æ‰‹éœ€è¦4æ¬¡"></a>ä¸ºä»€ä¹ˆTCPæŒ¥æ‰‹éœ€è¦4æ¬¡</h3><ul><li><p>ä¸»è¦åŸå› æ˜¯å½“æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„ FIN æ•°æ®åŒ…åï¼ŒæœåŠ¡ç«¯å¯èƒ½è¿˜æœ‰æ•°æ®æ²¡å‘å®Œï¼Œä¸ä¼šç«‹å³closeã€‚</p></li><li><p>æ‰€ä»¥æœåŠ¡ç«¯ä¼šå…ˆå°† ACK å‘è¿‡å»å‘Šè¯‰å®¢æˆ·ç«¯æˆ‘æ”¶åˆ°ä½ çš„æ–­å¼€è¯·æ±‚äº†ï¼Œä½†è¯·å†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´ï¼Œè¿™æ®µæ—¶é—´ç”¨æ¥å‘é€å‰©ä¸‹çš„æ•°æ®æŠ¥æ–‡ï¼Œå‘å®Œä¹‹åå†å°† FIN åŒ…å‘ç»™å®¢æˆ·ç«¯è¡¨ç¤ºç°åœ¨å¯ä»¥æ–­äº†ã€‚ä¹‹åå®¢æˆ·ç«¯éœ€è¦æ”¶åˆ° FIN åŒ…åå‘é€ ACK ç¡®è®¤æ–­å¼€ä¿¡æ¯ç»™æœåŠ¡ç«¯ã€‚</p></li></ul><h3 id="ä¸ºä»€ä¹ˆå››æ¬¡æŒ¥æ‰‹é‡Šæ”¾è¿æ¥æ—¶éœ€è¦ç­‰å¾…2MSL"><a href="#ä¸ºä»€ä¹ˆå››æ¬¡æŒ¥æ‰‹é‡Šæ”¾è¿æ¥æ—¶éœ€è¦ç­‰å¾…2MSL" class="headerlink" title="ä¸ºä»€ä¹ˆå››æ¬¡æŒ¥æ‰‹é‡Šæ”¾è¿æ¥æ—¶éœ€è¦ç­‰å¾…2MSL"></a>ä¸ºä»€ä¹ˆå››æ¬¡æŒ¥æ‰‹é‡Šæ”¾è¿æ¥æ—¶éœ€è¦ç­‰å¾…2MSL</h3><ul><li>MSLå³æŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´ã€‚è®¾ç½®2MSLå¯ä»¥ä¿è¯ä¸Šä¸€æ¬¡è¿æ¥çš„æŠ¥æ–‡å·²ç»åœ¨ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä¸ä¼šå‡ºç°ä¸æ–°TCPè¿æ¥æŠ¥æ–‡å†²çªçš„æƒ…å†µã€‚</li></ul><hr><hr><h3 id="ç®€è¿°DNSåè®®"><a href="#ç®€è¿°DNSåè®®" class="headerlink" title="ç®€è¿°DNSåè®®"></a>ç®€è¿°DNSåè®®</h3><ul><li>DNSåè®®æ˜¯åŸºäºUDPçš„åº”ç”¨å±‚åè®®ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„åŸŸåï¼Œè§£æå‡ºè¯¥åŸŸåå¯¹åº”çš„IPåœ°å€ï¼Œä»è€Œç»™å®¢æˆ·ç«¯è¿›è¡Œè®¿é—®ã€‚</li></ul><h3 id="ç®€è¿°DNSè§£æè¿‡ç¨‹"><a href="#ç®€è¿°DNSè§£æè¿‡ç¨‹" class="headerlink" title="ç®€è¿°DNSè§£æè¿‡ç¨‹"></a>ç®€è¿°DNSè§£æè¿‡ç¨‹</h3><ol><li><p>å®¢æˆ·æœºå‘å‡ºæŸ¥è¯¢è¯·æ±‚ï¼Œåœ¨æœ¬åœ°è®¡ç®—æœºç¼“å­˜æŸ¥æ‰¾ï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šå°†è¯·æ±‚å‘é€ç»™dnsæœåŠ¡å™¨</p></li><li><p>æœ¬åœ°dnsæœåŠ¡å™¨ä¼šåœ¨è‡ªå·±çš„åŒºåŸŸé‡Œé¢æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å³æ ¹æ®æ­¤è®°å½•è¿›è¡Œè§£æï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šåœ¨æœ¬åœ°çš„ç¼“å­˜é‡Œé¢æŸ¥æ‰¾</p></li><li><p>æœ¬åœ°æœåŠ¡å™¨æ²¡æœ‰æ‰¾åˆ°å®¢æˆ·æœºæŸ¥è¯¢çš„ä¿¡æ¯ï¼Œå°±ä¼šå°†æ­¤è¯·æ±‚å‘é€åˆ°æ ¹åŸŸådnsæœåŠ¡å™¨</p></li><li><p>æ ¹åŸŸåæœåŠ¡å™¨è§£æå®¢æˆ·æœºè¯·æ±‚çš„æ ¹åŸŸéƒ¨åˆ†ï¼Œå®ƒæŠŠåŒ…å«çš„ä¸‹ä¸€çº§çš„dnsæœåŠ¡å™¨çš„åœ°å€è¿”å›åˆ°å®¢æˆ·æœºçš„dnsæœåŠ¡å™¨åœ°å€</p></li><li><p>å®¢æˆ·æœºçš„dnsæœåŠ¡å™¨æ ¹æ®è¿”å›çš„ä¿¡æ¯æ¥ç€è®¿é—®ä¸‹ä¸€çº§çš„dnsæœåŠ¡å™¨</p></li><li><p>è¿™æ ·é€’å½’çš„æ–¹æ³•ä¸€çº§ä¸€çº§æ¥è¿‘æŸ¥è¯¢çš„ç›®æ ‡ï¼Œæœ€ååœ¨æœ‰ç›®æ ‡åŸŸåçš„æœåŠ¡å™¨ä¸Šé¢å¾—åˆ°ç›¸åº”çš„IPä¿¡æ¯</p></li><li><p>å®¢æˆ·æœºçš„æœ¬åœ°çš„dnsæœåŠ¡å™¨ä¼šå°†æŸ¥è¯¢ç»“æœè¿”å›ç»™æˆ‘ä»¬çš„å®¢æˆ·æœº</p></li><li><p>å®¢æˆ·æœºæ ¹æ®å¾—åˆ°çš„ipä¿¡æ¯è®¿é—®ç›®æ ‡ä¸»æœºï¼Œå®Œæˆè§£æè¿‡ç¨‹</p></li></ol><hr><hr><h3 id="ç®€è¿°HTTPåè®®"><a href="#ç®€è¿°HTTPåè®®" class="headerlink" title="ç®€è¿°HTTPåè®®"></a>ç®€è¿°HTTPåè®®</h3><ul><li>httpåè®®æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ã€‚å®ƒæ˜¯åŸºäºTCPåè®®çš„åº”ç”¨å±‚ä¼ è¾“åè®®ï¼Œå³å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡Œæ•°æ®ä¼ è¾“çš„ä¸€ç§è§„åˆ™ã€‚è¯¥åè®®æœ¬èº«HTTP æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ã€‚</li></ul><hr><hr><h3 id="ç®€è¿°cookie"><a href="#ç®€è¿°cookie" class="headerlink" title="ç®€è¿°cookie"></a>ç®€è¿°cookie</h3><ul><li><p>HTTP åè®®æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ºäº†ä½¿å…¶èƒ½å¤„ç†æ›´åŠ å¤æ‚çš„é€»è¾‘ï¼ŒHTTP&#x2F;1.1 å¼•å…¥ Cookie æ¥ä¿å­˜çŠ¶æ€ä¿¡æ¯ã€‚</p></li><li><p>Cookieæ˜¯ç”±æœåŠ¡ç«¯äº§ç”Ÿçš„ï¼Œå†å‘é€ç»™å®¢æˆ·ç«¯ä¿å­˜ï¼Œå½“å®¢æˆ·ç«¯å†æ¬¡è®¿é—®çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å¯æ ¹æ®cookieè¾¨è¯†å®¢æˆ·ç«¯æ˜¯å“ªä¸ªï¼Œä»¥æ­¤å¯ä»¥åšä¸ªæ€§åŒ–æ¨é€ï¼Œå…è´¦å·å¯†ç ç™»å½•ç­‰ç­‰ã€‚</p></li></ul><hr><hr><h3 id="ç®€è¿°session"><a href="#ç®€è¿°session" class="headerlink" title="ç®€è¿°session"></a>ç®€è¿°session</h3><ul><li>sessionç”¨äºæ ‡è®°ç‰¹å®šå®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå­˜åœ¨åœ¨æœåŠ¡å™¨çš„ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚ä¸€èˆ¬å®¢æˆ·ç«¯å¸¦Cookieå¯¹æœåŠ¡å™¨è¿›è¡Œè®¿é—®ï¼Œå¯é€šè¿‡cookieä¸­çš„session idä»æ•´ä¸ªsessionä¸­æŸ¥è¯¢åˆ°æœåŠ¡å™¨è®°å½•çš„å…³äºå®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚</li></ul><h3 id="ç®€è¿°httpçŠ¶æ€ç å’Œå¯¹åº”çš„ä¿¡æ¯"><a href="#ç®€è¿°httpçŠ¶æ€ç å’Œå¯¹åº”çš„ä¿¡æ¯" class="headerlink" title="ç®€è¿°httpçŠ¶æ€ç å’Œå¯¹åº”çš„ä¿¡æ¯"></a>ç®€è¿°httpçŠ¶æ€ç å’Œå¯¹åº”çš„ä¿¡æ¯</h3><ul><li><p>1XXï¼šæ¥æ”¶çš„ä¿¡æ¯æ­£åœ¨å¤„ç†</p></li><li><p>2XXï¼šè¯·æ±‚æ­£å¸¸å¤„ç†å®Œæ¯•</p></li><li><p>3XXï¼šé‡å®šå‘</p></li><li><p>4XXï¼šå®¢æˆ·ç«¯é”™è¯¯</p></li><li><p>5XXï¼šæœåŠ¡ç«¯é”™è¯¯</p></li><li><p>å¸¸è§é”™è¯¯ç ï¼š301ï¼šæ°¸ä¹…é‡å®šå‘ 302ï¼šä¸´æ—¶é‡å®šå‘ 304ï¼šèµ„æºæ²¡ä¿®æ”¹ï¼Œç”¨ä¹‹å‰ç¼“å­˜å°±è¡Œ 400ï¼šå®¢æˆ·ç«¯è¯·æ±‚çš„æŠ¥æ–‡æœ‰é”™è¯¯ 403ï¼šè¡¨ç¤ºæœåŠ¡å™¨ç¦æ­¢è®¿é—®èµ„æº 404ï¼šè¡¨ç¤ºè¯·æ±‚çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æˆ–æœªæ‰¾åˆ°</p></li><li><p>è½¬å‘å’Œé‡å®šå‘çš„åŒºåˆ«<br>è½¬å‘æ˜¯æœåŠ¡å™¨è¡Œä¸ºã€‚æœåŠ¡å™¨ç›´æ¥å‘ç›®æ ‡åœ°å€è®¿é—®URL,å°†ç›¸åº”å†…å®¹è¯»å–ä¹‹åå‘ç»™æµè§ˆå™¨ï¼Œç”¨æˆ·æµè§ˆå™¨åœ°å€æ URLä¸å˜ï¼Œè½¬å‘é¡µé¢å’Œè½¬å‘åˆ°çš„é¡µé¢å¯ä»¥å…±äº«requesté‡Œé¢çš„æ•°æ®ã€‚</p></li><li><p>é‡å®šå‘æ˜¯åˆ©ç”¨æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ç æ¥å®ç°çš„ï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›301æˆ–è€…302ï¼Œæµè§ˆå™¨æ”¶åˆ°æ–°çš„æ¶ˆæ¯åè‡ªåŠ¨è·³è½¬åˆ°æ–°çš„ç½‘å€é‡æ–°è¯·æ±‚èµ„æºã€‚ç”¨æˆ·çš„åœ°å€æ urlä¼šå‘ç”Ÿæ”¹å˜ï¼Œè€Œä¸”ä¸èƒ½å…±äº«æ•°æ®ã€‚</p></li></ul><hr><hr><ul><li><p>ç®€è¿°http1.0<br>è§„å®šäº†è¯·æ±‚å¤´å’Œè¯·æ±‚å°¾ï¼Œå“åº”å¤´å’Œå“åº”å°¾ï¼ˆget postï¼‰</p></li><li><p>æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿æ¥ï¼Œåšä¸åˆ°è¿æ¥çš„å¤ç”¨</p></li></ul><hr><hr><h3 id="ç®€è¿°http1-1çš„æ”¹è¿›"><a href="#ç®€è¿°http1-1çš„æ”¹è¿›" class="headerlink" title="ç®€è¿°http1.1çš„æ”¹è¿›"></a>ç®€è¿°http1.1çš„æ”¹è¿›</h3><ul><li><p>HTTP1.1é»˜è®¤å¼€å¯é•¿è¿æ¥ï¼Œåœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå¯ä»¥ä¼ é€å¤šä¸ªHTTPè¯·æ±‚å’Œå“åº”ã€‚ä½¿ç”¨ TCP é•¿è¿æ¥çš„æ–¹å¼æ”¹å–„äº† HTTP&#x2F;1.0 çŸ­è¿æ¥é€ æˆçš„æ€§èƒ½å¼€é”€ã€‚</p></li><li><p>æ”¯æŒç®¡é“ï¼ˆpipelineï¼‰ç½‘ç»œä¼ è¾“ï¼Œåªè¦ç¬¬ä¸€ä¸ªè¯·æ±‚å‘å‡ºå»äº†ï¼Œä¸å¿…ç­‰å…¶å›æ¥ï¼Œå°±å¯ä»¥å‘ç¬¬äºŒä¸ªè¯·æ±‚å‡ºå»ï¼Œå¯ä»¥å‡å°‘æ•´ä½“çš„å“åº”æ—¶é—´ã€‚</p></li><li><p>æœåŠ¡ç«¯æ— æ³•ä¸»åŠ¨push</p></li></ul><hr><hr><h3 id="ç®€è¿°HTTPçŸ­è¿æ¥ä¸é•¿è¿æ¥åŒºåˆ«"><a href="#ç®€è¿°HTTPçŸ­è¿æ¥ä¸é•¿è¿æ¥åŒºåˆ«" class="headerlink" title="ç®€è¿°HTTPçŸ­è¿æ¥ä¸é•¿è¿æ¥åŒºåˆ«"></a>ç®€è¿°HTTPçŸ­è¿æ¥ä¸é•¿è¿æ¥åŒºåˆ«</h3><p>HTTPä¸­çš„é•¿è¿æ¥çŸ­è¿æ¥æŒ‡HTTPåº•å±‚TCPçš„è¿æ¥ã€‚</p><ul><li><p>çŸ­è¿æ¥ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œä¸€æ¬¡HTTPè¿æ¥æ“ä½œï¼Œå°±è¿›è¡Œä¸€æ¬¡TCPè¿æ¥ï¼Œè¿æ¥ç»“æŸTCPå…³é—­è¿æ¥ã€‚</p></li><li><p>é•¿è¿æ¥ï¼šå¦‚æœHTTPå¤´éƒ¨å¸¦æœ‰å‚æ•°keep-aliveï¼Œå³å¼€å¯é•¿è¿æ¥ç½‘é¡µå®Œæˆæ‰“å¼€åï¼Œåº•å±‚ç”¨äºä¼ è¾“æ•°æ®çš„TCPè¿æ¥ä¸ä¼šç›´æ¥å…³é—­ï¼Œä¼šæ ¹æ®æœåŠ¡å™¨è®¾ç½®çš„ä¿æŒæ—¶é—´ä¿æŒè¿æ¥ï¼Œä¿æŒæ—¶é—´è¿‡åè¿æ¥å…³é—­ã€‚</p></li></ul><hr><hr><h3 id="ç®€è¿°http2-0çš„æ”¹è¿›"><a href="#ç®€è¿°http2-0çš„æ”¹è¿›" class="headerlink" title="ç®€è¿°http2.0çš„æ”¹è¿›"></a>ç®€è¿°http2.0çš„æ”¹è¿›</h3><ul><li><p>æå‡ºå¤šè·¯å¤ç”¨ã€‚å¤šè·¯å¤ç”¨å‰ï¼Œæ–‡ä»¶æ—¶ä¸²è¡Œä¼ è¾“çš„ï¼Œè¯·æ±‚aæ–‡ä»¶ï¼Œbæ–‡ä»¶åªèƒ½ç­‰å¾…ï¼Œå¹¶ä¸”è¿æ¥æ•°è¿‡å¤šã€‚å¼•å…¥å¤šè·¯å¤ç”¨ï¼Œaæ–‡ä»¶bæ–‡ä»¶å¯ä»¥åŒæ—¶ä¼ è¾“ã€‚</p></li><li><p>å¼•å…¥äº†äºŒè¿›åˆ¶æ•°æ®å¸§ã€‚å…¶ä¸­å¸§å¯¹æ•°æ®è¿›è¡Œé¡ºåºæ ‡è¯†ï¼Œæœ‰äº†åºåˆ—idï¼ŒæœåŠ¡å™¨å°±å¯ä»¥è¿›è¡Œå¹¶è¡Œä¼ è¾“æ•°æ®ã€‚</p></li></ul><h3 id="httpä¸httpsçš„åŒºåˆ«"><a href="#httpä¸httpsçš„åŒºåˆ«" class="headerlink" title="httpä¸httpsçš„åŒºåˆ«"></a>httpä¸httpsçš„åŒºåˆ«</h3><ul><li>httpæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½æ— æ³•éªŒè¯å¯¹æ–¹çš„èº«ä»½ã€‚httpså…·æœ‰å®‰å…¨æ€§çš„sslåŠ å¯†ä¼ è¾“åè®®ï¼ŒåŠ å¯†é‡‡ç”¨å¯¹ç§°åŠ å¯†ï¼Œ httpsåè®®éœ€è¦åˆ°caç”³è¯·è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦å¾ˆå°‘ï¼Œéœ€è¦äº¤è´¹ã€‚</li></ul><hr><hr><h3 id="ç®€è¿°TLS-x2F-SSL-HTTP-HTTPSçš„å…³ç³»"><a href="#ç®€è¿°TLS-x2F-SSL-HTTP-HTTPSçš„å…³ç³»" class="headerlink" title="ç®€è¿°TLS&#x2F;SSL, HTTP, HTTPSçš„å…³ç³»"></a>ç®€è¿°TLS&#x2F;SSL, HTTP, HTTPSçš„å…³ç³»</h3><ul><li><p>SSLå…¨ç§°ä¸ºSecure Sockets Layerå³å®‰å…¨å¥—æ¥å±‚ï¼Œå…¶ç»§ä»»ä¸ºTLSTransport Layer Securityä¼ è¾“å±‚å®‰å…¨åè®®ï¼Œå‡ç”¨äºåœ¨ä¼ è¾“å±‚ä¸ºæ•°æ®é€šè®¯æä¾›å®‰å…¨æ”¯æŒã€‚</p></li><li><p>å¯ä»¥å°†HTTPSåè®®ç®€å•ç†è§£ä¸ºHTTPåè®®ï¼‹TLS&#x2F;SSL</p></li></ul><hr><hr><h3 id="httpsçš„è¿æ¥è¿‡ç¨‹"><a href="#httpsçš„è¿æ¥è¿‡ç¨‹" class="headerlink" title="httpsçš„è¿æ¥è¿‡ç¨‹"></a>httpsçš„è¿æ¥è¿‡ç¨‹</h3><ul><li><p>æµè§ˆå™¨å°†æ”¯æŒçš„åŠ å¯†ç®—æ³•ä¿¡æ¯å‘ç»™æœåŠ¡å™¨<br>æœåŠ¡å™¨é€‰æ‹©ä¸€å¥—æµè§ˆå™¨æ”¯æŒçš„åŠ å¯†ç®—æ³•ï¼Œä»¥è¯ä¹¦çš„å½¢å¼å›å‘ç»™æµè§ˆå™¨<br>å®¢æˆ·ç«¯(SSL&#x2F;TLS)è§£æè¯ä¹¦éªŒè¯è¯ä¹¦åˆæ³•æ€§ï¼Œç”Ÿæˆå¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œæˆ‘ä»¬å°†è¯¥å¯†é’¥ç§°ä¹‹ä¸ºclient keyï¼Œå³å®¢æˆ·ç«¯å¯†é’¥ï¼Œç”¨æœåŠ¡å™¨çš„å…¬é’¥å¯¹å®¢æˆ·ç«¯å¯†é’¥è¿›è¡Œéå¯¹ç§°åŠ å¯†ã€‚<br>å®¢æˆ·ç«¯ä¼šå‘èµ·HTTPSä¸­çš„ç¬¬äºŒä¸ªHTTPè¯·æ±‚ï¼Œå°†åŠ å¯†ä¹‹åçš„å®¢æˆ·ç«¯å¯¹ç§°å¯†é’¥å‘é€ç»™æœåŠ¡å™¨<br>æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„å¯†æ–‡ä¹‹åï¼Œä¼šç”¨è‡ªå·±çš„ç§é’¥å¯¹å…¶è¿›è¡Œéå¯¹ç§°è§£å¯†ï¼Œè§£å¯†ä¹‹åçš„æ˜æ–‡å°±æ˜¯å®¢æˆ·ç«¯å¯†é’¥ï¼Œç„¶åç”¨å®¢æˆ·ç«¯å¯†é’¥å¯¹æ•°æ®è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œè¿™æ ·æ•°æ®å°±å˜æˆäº†å¯†æ–‡ã€‚<br>æœåŠ¡å™¨å°†åŠ å¯†åçš„å¯†æ–‡å‘é€ç»™å®¢æˆ·ç«¯<br>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘é€æ¥çš„å¯†æ–‡ï¼Œç”¨å®¢æˆ·ç«¯å¯†é’¥å¯¹å…¶è¿›è¡Œå¯¹ç§°è§£å¯†ï¼Œå¾—åˆ°æœåŠ¡å™¨å‘é€çš„æ•°æ®ã€‚è¿™æ ·HTTPSä¸­çš„ç¬¬äºŒä¸ªHTTPè¯·æ±‚ç»“æŸï¼Œæ•´ä¸ªHTTPSä¼ è¾“å®Œæˆ<br>Getä¸PoståŒºåˆ«<br>Getï¼šæŒ‡å®šèµ„æºè¯·æ±‚æ•°æ®ï¼Œåˆ·æ–°æ— å®³ï¼ŒGetè¯·æ±‚çš„æ•°æ®ä¼šé™„åŠ åˆ°URLä¸­ï¼Œä¼ è¾“æ•°æ®çš„å¤§å°å—åˆ°urlçš„é™åˆ¶ã€‚</p></li><li><p>Postï¼šå‘æŒ‡å®šèµ„æºæäº¤è¦è¢«å¤„ç†çš„æ•°æ®ã€‚åˆ·æ–°ä¼šä½¿æ•°æ®ä¼šè¢«é‡å¤æäº¤ã€‚poståœ¨å‘é€æ•°æ®å‰ä¼šå…ˆå°†è¯·æ±‚å¤´å‘é€ç»™æœåŠ¡å™¨è¿›è¡Œç¡®è®¤ï¼Œç„¶åæ‰çœŸæ­£å‘é€æ•°æ®ã€‚</p></li><li><p>Getæ–¹æ³•å‚æ•°æœ‰å¤§å°é™åˆ¶å—<br>ä¸€èˆ¬HTTPåè®®é‡Œå¹¶ä¸é™åˆ¶å‚æ•°å¤§å°é™åˆ¶ã€‚ä½†ä¸€èˆ¬ç”±äºgetè¯·æ±‚æ˜¯ç›´æ¥é™„åŠ åˆ°åœ°å€æ é‡Œé¢çš„ï¼Œç”±äºæµè§ˆå™¨åœ°å€æ æœ‰é•¿åº¦é™åˆ¶ï¼Œå› æ­¤ä½¿GETè¯·æ±‚åœ¨æµè§ˆå™¨å®ç°å±‚é¢ä¸Šçœ‹ä¼šæœ‰é•¿åº¦é™åˆ¶ã€‚</p></li></ul><h3 id="äº†è§£REST-APIå—"><a href="#äº†è§£REST-APIå—" class="headerlink" title="äº†è§£REST APIå—"></a>äº†è§£REST APIå—</h3><ul><li><p>REST APIå…¨ç§°ä¸ºè¡¨è¿°æ€§çŠ¶æ€è½¬ç§»ï¼ˆRepresentational State Transferï¼ŒRESTï¼‰å³åˆ©ç”¨HTTPä¸­getã€postã€putã€deleteä»¥åŠå…¶ä»–çš„HTTPæ–¹æ³•æ„æˆRESTä¸­æ•°æ®èµ„æºçš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼š</p></li><li><p>Create ï¼šPOST<br>Read ï¼šGET<br>Update ï¼šPUT&#x2F;PATCH<br>Deleteï¼šDELETE<br>æµè§ˆå™¨ä¸­è¾“å…¥ä¸€ä¸ªç½‘å€åï¼Œå…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆ<br>è¿›è¡ŒDNSè§£ææ“ä½œï¼Œæ ¹æ®DNSè§£æçš„ç»“æœæŸ¥åˆ°æœåŠ¡å™¨IPåœ°å€<br>é€šè¿‡ipå¯»å€å’Œarpï¼Œæ‰¾åˆ°æœåŠ¡å™¨ï¼Œå¹¶åˆ©ç”¨ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥<br>æµè§ˆå™¨ç”ŸæˆHTTPæŠ¥æ–‡ï¼Œå‘é€HTTPè¯·æ±‚ï¼Œç­‰å¾…æœåŠ¡å™¨å“åº”<br>æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›ç»™æµè§ˆå™¨<br>æ ¹æ®HTTPæ˜¯å¦å¼€å¯é•¿è¿æ¥ï¼Œè¿›è¡ŒTCPçš„æŒ¥æ‰‹è¿‡ç¨‹<br>æµè§ˆå™¨æ ¹æ®æ”¶åˆ°çš„é™æ€èµ„æºè¿›è¡Œé¡µé¢æ¸²æŸ“</p></li></ul><hr><hr><h3 id="HTTPSç›¸å…³"><a href="#HTTPSç›¸å…³" class="headerlink" title="HTTPSç›¸å…³"></a>HTTPSç›¸å…³</h3><p>1ï¼‰HTTPS ç»“åˆä½¿ç”¨äº† éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œhashç®—æ³•ï¼Œåˆ†åˆ«åˆ©ç”¨ä»–ä»¬çš„ä¼˜åŠ¿ï¼Œé¿å…ä»–ä»¬çš„ç¼ºç‚¹ã€‚åˆ©ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•è·å¾—å¯¹ç§°åŠ å¯†ç®—æ³•çš„ç§˜é’¥ï¼Œä¿è¯ä»–çš„å®‰å…¨æ€§ï¼›ç„¶åå®é™…çš„ç½‘é¡µå†…å®¹çš„åŠ å¯†ä½¿ç”¨çš„æ˜¯å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œåˆ©ç”¨äº†å¯¹ç§°åŠ å¯†ç®—æ³•é€Ÿåº¦å¿«çš„ä¼˜åŠ¿ï¼Œhashç®—æ³•ä¸»è¦æ˜¯é˜²æ­¢ç¯¡æ”¹çš„å‘ç”Ÿï¼Œæ˜¯ä¸€ç§æ ¡éªŒæœºåˆ¶ï¼Œæœ€åæ•°å­—è¯ä¹¦ï¼Œä¿è¯äº†æœåŠ¡å™¨åœ¨å°†éå¯¹ç§°åŠ å¯†ç®—æ³•çš„å…¬é’¥ä¼ ç»™æµè§ˆå™¨æ—¶çš„å®‰å…¨æ€§(ä¸ä¼šè¢«ä¸­é—´äººç¯¡æ”¹)ï¼ŒåŒæ—¶ä¹Ÿæ ‡å¿—äº†æœåŠ¡å™¨çš„èº«ä»½ã€‚</p><p>2ï¼‰HTTPSçš„å››å¤§é‡‘åˆšï¼š</p><p>éå¯¹ç§°åŠ å¯†ç®—æ³•(å¯¹ç§°åŠ å¯†ç®—æ³•çš„ç§˜é’¥) + å¯¹ç§°åŠ å¯†ç®—æ³•(åŠ å¯†å†…å®¹) + æ•°å­—è¯ä¹¦(é˜²æ­¢ç¯¡æ”¹éå¯¹ç§°åŠ å¯†ç®—æ³•çš„å…¬é’¥) + HASHç®—æ³•(é˜²æ­¢ç¯¡æ”¹æ¶ˆæ¯)&#x3D;&#x3D; HTTPS</p><p>3ï¼‰HTTPSçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>HTTPSçš„æœ¬è´¨å°±æ˜¯åœ¨HTTPè¿æ¥å‘èµ·ä¹‹å‰ï¼Œå…ˆä½¿ç”¨SSL&#x2F;TLSåè®®ï¼Œåè°ƒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œåœ¨ä¸¤ç«¯å„è‡ªç”Ÿäº§ä¸€ä¸ªå¯¹ç§°åŠ å¯†ç®—æ³•çš„ç§˜é’¥ï¼Œ</p><p>ç„¶åä½¿ç”¨æ™®é€šçš„HTTPåè®®ä¼ è¾“ ç»è¿‡å¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†çš„ç½‘é¡µå†…å®¹ã€‚å› ä¸ºå¯¹ç§°åŠ å¯†ç®—æ³•çš„ç§˜é’¥æ˜¯å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†çš„ç½‘é¡µå†…å®¹ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>iOS-åŒæ­¥æ–¹æ¡ˆï¼ˆé”ï¼‰</title>
    <link href="/2020/04/16/iOS%E4%B9%8B%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88%EF%BC%88%E9%94%81%EF%BC%89/"/>
    <url>/2020/04/16/iOS%E4%B9%8B%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88%EF%BC%88%E9%94%81%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>è¿‘æœŸè¦å†™ä¸€ä¸ªå¤šçº¿ç¨‹å·¥å…·ï¼ŒæŠŠä¹‹å‰å­¦ä¹ çš„å¤šçº¿ç¨‹ï¼Œä»¥åŠçº¿ç¨‹åŒæ­¥å¤ä¹ ä¸€ä¸‹ </p><p>å¤šçº¿ç¨‹çš„æœ¬è´¨ï¼šæœ‰å¤šæ¡çº¿ç¨‹ï¼Œä½†æ˜¯åªèƒ½æ‰§è¡Œä¸€æ¡ï¼Œå¦‚æœé—´éš”æ—¶é—´è®¾ç½®çš„è¶³å¤Ÿå°ï¼Œå°±ç»™äººçš„æ„Ÿè§‰æ˜¯å¤šæ¡çº¿ç¨‹æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•</p><p>iOSä¸­çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ</p><ul><li>OSSpinLock</li><li>os_unfair_lock</li><li>pthread_mutex</li><li>dispatch_semaphore</li><li>Dispatch_queue(DISPATCH_QUEUE_SERIAL)</li><li>NSLock</li><li>NSRecursiveLock</li><li>NSCondition</li><li>NSConditionLock</li><li>@synchronized</li></ul><h4 id="OSSpinLock-è‡ªæ—‹é”"><a href="#OSSpinLock-è‡ªæ—‹é”" class="headerlink" title="OSSpinLock - è‡ªæ—‹é”"></a>OSSpinLock - è‡ªæ—‹é”</h4><p> ç­‰å¾…é”ğŸ”çš„çº¿ç¨‹ä¼šå¤„äºå¿™ç­‰çŠ¶æ€ï¼Œä¸€ç›´å ç”¨CPUèµ„æº</p><p>ä¼šå‡ºç°ä¼˜å…ˆçº§ç¿»è½¬çš„é—®é¢˜ï¼Œå¦‚æœçº¿ç¨‹ä¹‹é—´çš„ä¼˜å…ˆçº§ä¸åŒï¼Œå¦‚æœä½ä¼˜å…ˆçº§çš„é”å…ˆè¿›æ¥ï¼ŒæŠŠé”é”ä½ï¼Œé‚£ä¹ˆé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹è¿›æ¥å°±ä¼šä¸€ç›´å¿™ç­‰ï¼Œä½†æ˜¯ç³»ç»Ÿåˆä¼šåˆ†é…æ—¶é—´èµ„æºç»™çº¿ç¨‹é«˜çš„ï¼Œä»è€Œå¯¼è‡´ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹æ— æ³•æ‰§è¡Œå®Œè‡ªå·±çš„ä»£ç ï¼Œä»è€Œå¯¼è‡´ä¼˜å…ˆçº§ä½çš„é”æ— æ³•é‡Šæ”¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–é”<br>self.lock = OS_SPINLOCK_INIT;<br>   <br>- (void)saleTicket&#123;<br>    /// åŠ é”<br>  OSSpinLockLock(&amp;_lock);<br>  //BOOL isLock =  OSSpinLockTry(&amp;_lock); <br>  int oldTicketsCount = self.ticketsCount;<br>  sleep(.2);<br>  oldTicketsCount--;<br>  self.ticketsCount = oldTicketsCount;<br>  NSLog(@&quot;è¿˜å‰©ä¸‹%då¼ ç¥¨ = %@&quot;,self.ticketsCount,[NSThread currentThread]);<br>  /// è§£é”<br>  OSSpinLockUnlock(&amp;_lock);<br>&#125;<br>   <br></code></pre></td></tr></table></figure><hr><h4 id="os-unfair-lock-iOS10åæ”¯æŒ-ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰"><a href="#os-unfair-lock-iOS10åæ”¯æŒ-ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰" class="headerlink" title="os_unfair_lock - iOS10åæ”¯æŒ ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰"></a>os_unfair_lock - iOS10åæ”¯æŒ ï¼ˆæœ¬è´¨æ˜¯äº’æ–¥é”ï¼‰</h4><p>ç”¨äºæ›¿ä»£<code>OSSpinLock</code> çš„é”ï¼Œä½¿ç”¨çš„æŠ€æœ¯ä¸å†æ˜¯å¿™ç­‰ï¼Œè€Œæ˜¯ä¼‘çœ ç­‰å¾…å”¤é†’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–é”<br>self.lock = OS_UNFAIR_LOCK_INIT;<br>- (void)saleTicket&#123;   <br>    /// åŠ é”<br>    os_unfair_lock_lock(&amp;_lock);<br>//  BOOL isLock = os_unfair_lock_trylock(&amp;lock);<br>    // å–ç¥¨<br>    [self sale];<br>    /// è§£é”<br>    os_unfair_lock_unlock(&amp;_lock);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="pthread-mutex"><a href="#pthread-mutex" class="headerlink" title="pthread_mutex"></a>pthread_mutex</h4><p><code>mutex</code> å«åšâ€äº’æ–¥é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/// åˆå§‹åŒ–å±æ€§    <br>pthread_mutexattr_t attr;<br>pthread_mutexattr_init(&amp;attr);<br>pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_DEFAULT);<br>/// åˆå§‹åŒ–é”<br>pthread_mutex_init(&amp;_lock, &amp;attr);<br><br>//é”€æ¯å±æ€§ pthread_mutexattr_destroy(&amp;attr);<br>//é”€æ¯é”   pthread_mutex_destroy(&amp;_lock);<br><br>- (void)saleTicket&#123; <br>    /// åŠ é”<br>    pthread_mutex_lock(&amp;_lock);<br>    ///å°è¯• åŠ é”<br>    //BOOL islock = pthread_mutex_trylock(&amp;_lock);<br>    // å–ç¥¨<br>    [self sale];<br>    /// è§£é”<br>    pthread_mutex_unlock(&amp;_lock);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/*<br> * Mutex type attributes<br> */<br>#define PTHREAD_MUTEX_NORMAL0  //æ™®é€šçŠ¶æ€é”<br>#define PTHREAD_MUTEX_ERRORCHECK1<br>#define PTHREAD_MUTEX_RECURSIVE2  //ç”¨äºå¤„ç†é€’å½’é”<br>#define PTHREAD_MUTEX_DEFAULTPTHREAD_MUTEX_NORMAL<br><br></code></pre></td></tr></table></figure><h5 id="é€’å½’é”"><a href="#é€’å½’é”" class="headerlink" title="é€’å½’é”"></a>é€’å½’é”</h5><p>é€’å½’é”ï¼šå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€æŠŠé”é‡å¤åŠ é”</p><p>çº¿ç¨‹ä¸€ : è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</p><ul><li>è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</li><li>è°ƒç”¨<code>saleTicket</code> (+ğŸ”)</li></ul><p> çº¿ç¨‹äºŒï¼šè°ƒç”¨<code>saleTicket</code> (å‘ç°å·²ç»è¢«åŠ é”äº†ï¼Œç­‰å¾…) </p><p>å½“é”ä¸­é—´çš„ä»£ç é‡åˆ°é€’å½’è°ƒç”¨ï¼Œæ‰“å°çš„ç»“æœæ°¸è¿œåªæœ‰ä¸€æ¡<code>saleTicket</code>ï¼Œå› ä¸ºæ²¡æœ‰äººèƒ½å¤Ÿèµ°åˆ°è§£é”çš„é‚£ä¸€æ­¥ã€‚</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scss">- (void)saleTicket&#123;<br>    <span class="hljs-comment">/// åŠ é”</span><br>    <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;_lock);<br>    <span class="hljs-comment">///å°è¯• åŠ é”</span><br>    <span class="hljs-comment">//BOOL islock = pthread_mutex_trylock(&amp;_lock);</span><br>    <span class="hljs-built_in">NSLog</span>(@&quot;%s&quot;,__func__);<br>    <span class="hljs-comment">// å–ç¥¨ é€’å½’è°ƒç”¨</span><br>    <span class="hljs-selector-attr">[self saleTicket]</span>;<br>    <span class="hljs-comment">/// è§£é”</span><br>    <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;_lock);<br> <br>&#125;<br></code></pre></td></tr></table></figure><p> <code>pthread</code>æ˜¯æ”¯æŒé€’å½’é”çš„ï¼Œåªéœ€è¦æŠŠåˆå§‹åŒ–å±æ€§æ”¹ä¸ºé€’å½’é”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE);<br></code></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxupqijd8nj30c205igme.jpg"></p><h5 id="æ¡ä»¶é”"><a href="#æ¡ä»¶é”" class="headerlink" title="æ¡ä»¶é”"></a>æ¡ä»¶é”</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@property (nonatomic, assign) pthread_cond_t cond;<br><br>/// åˆå§‹åŒ–æ¡ä»¶<br>pthread_mutex_init(&amp;_lock, &amp;attr);<br><br>// é”€æ¯æ¡ä»¶<br>pthread_cond_destroy(&amp;_cond);<br><br>[[[NSThread alloc]initWithTarget:self selector:@selector(__remove) object:nil]start];<br>[[[NSThread alloc]initWithTarget:self selector:@selector(__add) object:nil]start];<br><br>- (void)__remove&#123;<br>   <br>    pthread_mutex_lock(&amp;_lock);<br>    <br>    if (self.dataArray.count == 0) &#123;<br>        //ä¸€æ—¦è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå°±ä¼šæ”¾å¼€è¿™æŠŠé”ï¼Œç›´åˆ°åˆ«äººå‘é€ä¿¡å·å”¤é†’<br>        pthread_cond_wait(&amp;_cond, &amp;_lock);<br>    &#125;<br>    [self.dataArray removeLastObject];<br>    NSLog(@&quot;åˆ é™¤äº†å…ƒç´ &quot;);<br>    pthread_mutex_unlock(&amp;_lock);<br>&#125;<br><br>- (void)__add&#123;<br>    <br>    pthread_mutex_lock(&amp;_lock);<br>    <br>    [self.dataArray addObject:@&quot;123&quot;];<br>    NSLog(@&quot;æ·»åŠ äº†å…ƒç´ &quot;);<br>     <br>    pthread_cond_signal(&amp;_cond);<br>    pthread_mutex_unlock(&amp;_lock);<br>    // è¿™é‡Œéœ€è¦ä¿è¯pthread_cond_signalåœ¨pthread_mutex_unlockä¹‹å‰<br>    // å¦‚æœåœ¨ä¹‹åçš„è¯ï¼Œé”è§£å¼€äº†ï¼Œå‘é€ä¿¡å·çš„è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å¯èƒ½è¢«åˆ«çš„é”æŠ¢å…ˆè¿›æ¥äº†<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><h4 id="NSLock-x2F-NSRecursiveLock-x2F-NSCondition"><a href="#NSLock-x2F-NSRecursiveLock-x2F-NSCondition" class="headerlink" title="NSLock&#x2F;NSRecursiveLock&#x2F;NSCondition"></a>NSLock&#x2F;NSRecursiveLock&#x2F;NSCondition</h4><ul><li><p><code>NSLock</code>æ˜¯å¯¹<code>mutex</code>æ™®é€šé”çš„å°è£…</p></li><li><p><code>NSRecursiveLock</code> æ˜¯å¯¹<code>mutex</code>é€’å½’é”çš„å°è£…</p></li><li><p><code>NSCondition</code> æ˜¯å¯¹<code>mutex</code>å’Œ<code>cont</code>çš„å°è£…</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@protocol NSLocking<br><br>- (void)lock;<br>- (void)unlock;<br><br>@end<br><br>@interface NSLock : NSObject &lt;NSLocking&gt; &#123;<br>@private<br>    void *_priv;<br>&#125;<br><br>- (BOOL)tryLock; // å°è¯•åŠ é”<br>- (BOOL)lockBeforeDate:(NSDate *)limit; //åœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰ç­‰ä¸åˆ°è¿™ä¸ªé”ï¼Œéƒ½ä¼šç¡çœ <br><br>@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));<br>@end<br></code></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥çœ‹GNUStepçœ‹åˆ°<code>NSLock</code>çš„å®ç°</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxusubtzxlj30js0b8400.jpg"></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface NSConditionLock : NSObject &lt;NSLocking&gt; &#123;<br>@private<br>    void *_priv;<br>&#125;<br><br>- (instancetype)initWithCondition:(NSInteger)condition NS_DESIGNATED_INITIALIZER;<br><br>@property (readonly) NSInteger condition;<br>- (void)lockWhenCondition:(NSInteger)condition;<br>- (BOOL)tryLock;<br>- (BOOL)tryLockWhenCondition:(NSInteger)condition;<br>- (void)unlockWithCondition:(NSInteger)condition;<br>- (BOOL)lockBeforeDate:(NSDate *)limit;<br>- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;<br><br>@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));<br><br>@end<br></code></pre></td></tr></table></figure><hr><h4 id="Dispatch-queue-DISPATCH-QUEUE-SERIAL-ä¸²è¡Œé˜Ÿåˆ—"><a href="#Dispatch-queue-DISPATCH-QUEUE-SERIAL-ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="Dispatch_queue(DISPATCH_QUEUE_SERIAL) - ä¸²è¡Œé˜Ÿåˆ—"></a>Dispatch_queue(DISPATCH_QUEUE_SERIAL) - ä¸²è¡Œé˜Ÿåˆ—</h4><ul><li>ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥ï¼Œä¿è¯äº†æ¯ä¸€æ¡çº¿ç¨‹çš„æ“ä½œéƒ½æ˜¯æŒ‰é¡ºåºçš„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">  @property (nonatomic, strong) dispatch_queue_t  queen;<br>  <br>  self.queen =  dispatch_queue_create(&quot;123&quot;, DISPATCH_QUEUE_SERIAL);<br>  <br>  - (void)test&#123;<br>    self.ticketsCount = 20;<br>    <br>    dispatch_async(self.queen, ^&#123;<br>        for (int i = 0; i&lt;5; i++) &#123;<br>            [self saleTicket];<br>        &#125;<br>    &#125;);<br>    <br>    dispatch_async(self.queen, ^&#123;<br>        for (int i = 0; i&lt;5; i++) &#123;<br>            [self saleTicket];<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="dispatch-semaphore-ä¿¡å·é‡"><a href="#dispatch-semaphore-ä¿¡å·é‡" class="headerlink" title="dispatch_semaphore - ä¿¡å·é‡"></a>dispatch_semaphore - ä¿¡å·é‡</h4><ul><li>ä¿¡å·é‡çš„åˆå§‹å€¼ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶çº¿ç¨‹çš„å¹¶å‘è®¿é—®çš„æœ€å¤§æ•°é‡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@property (nonatomic, strong) dispatch_semaphore_t semaphore;<br>  // è®¾ç½®æœ€å¤§å¹¶å‘æ•°     <br> self.semaphore = dispatch_semaphore_create(1);<br>      <br>  for (int i = 0; i&lt;20; i++) &#123;<br>     [[[NSThread alloc]initWithTarget:self selector:@selector(test) object:nil]start];<br>  &#125;<br>  <br>- (void)test&#123;    <br>    // å¦‚æœä¿¡å·é‡çš„å€¼&gt;0,å°±è®©ä¿¡å·é‡å‡1ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç <br>    // ç›´åˆ°ä¿¡å·é‡çš„å€¼&lt;=0çš„æ—¶å€™ï¼Œå°±ä¼šä¼‘çœ ç­‰å¾…<br>    // DISPATCH_TIME_FOREVERæ°¸è¿œ æˆ–è€… è®¾ç½®æˆ DISPATCH_TIME_NOWç°åœ¨ç«‹å³<br>    dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);<br>    self.ticketsCount--;<br>    sleep(2);<br>    NSLog(@&quot;å‰©ä¸‹çš„ç¥¨ä¸º %d&quot;,self.ticketsCount);<br>    //è®©ä¿¡å·é‡çš„å€¼+1<br>    dispatch_semaphore_signal(self.semaphore);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h4><ul><li><code>@synchronized</code>æ˜¯å¯¹<code>mutex</code>é€’å½’é”çš„å°è£…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@synchronized (self) &#123; //objc_sync_enter<br>&#125; // objc_sync_exit<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">int objc_sync_enter(id obj)<br>&#123;<br>    int result = OBJC_SYNC_SUCCESS;<br><br>    if (obj) &#123;<br>        SyncData* data = id2data(obj, ACQUIRE);<br>        ASSERT(data);<br>        data-&gt;mutex.lock();<br>    &#125; else &#123;<br>        // @synchronized(nil) does nothing<br>        if (DebugNilSync) &#123;<br>            _objc_inform(&quot;NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug&quot;);<br>        &#125;<br>        objc_sync_nil();<br>    &#125;<br><br>    return result;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>id2data</code> æ–¹æ³•å†…éƒ¨</p><p>![image-20211229175537934](&#x2F;Users&#x2F;karthrine&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20211229175537934.png)</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxuusl6m2wj30cm01z74g.jpg"></p><p>å†…éƒ¨æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ŒæŠŠ<code>obj</code>å½“åš<code>key</code> ï¼Œ<code>data-&gt;mutex.lock();</code> æ‹¿åˆ°å”¯ä¸€çš„mutexé”ï¼Œæ¥åŠ é”</p><hr><h4 id="è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”"><a href="#è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”" class="headerlink" title="è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”"></a>è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”</h4><p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨è‡ªæ—‹é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´å¾ˆçŸ­</li><li>åŠ é”çš„ä»£ç ï¼ˆä¸´ç•ŒåŒºï¼‰ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰æƒ…å†µå¾ˆå°‘å‘é€</li><li>CPUèµ„æºä¸ç´§å¼ </li><li>å¤šæ ¸å¤„ç†å™¨</li></ul><p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨äº’æ–¥é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ</p><ul><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´è¾ƒé•¿</li><li>å•æ ¸å¤„ç†å™¨</li><li>ä¸´ç•ŒåŒºæœ‰IOæ“ä½œ</li><li>ä¸´ç•ŒåŒºä»£ç å¤æ‚æˆ–è€…å¾ªç¯é‡å¤§</li></ul>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æµ‹è¯•æ–‡ç« </title>
    <link href="/2019/04/17/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/"/>
    <url>/2019/04/17/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
